@section Scripts{
<script>
(function(){
  function setBusy(job, busy) {
    const spin = document.getElementById(job ? 'spin-' + job : 'spin-sp');
    if (!spin) return;
    spin.classList.toggle('d-none', !busy);
  }
  function setStatus(job, text, ok) {
    const el = document.getElementById('status-' + job);
    if (el) {
      el.textContent = text;
      el.className = ok ? 'text-success' : (text === 'Idle' ? 'text-muted' : 'text-danger');
    }
  }
  function setOutput(id, text) {
    const el = document.getElementById(id);
    if (el) el.textContent = text || '';
  }
  function getToken(form){
    const token = form.querySelector('input[name="__RequestVerificationToken"]');
    return token ? token.value : '';
  }

  // Run individual functions (disable the clicked button until done)
  document.querySelectorAll('form.ajax-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const job = form.dataset.job;
      const data = new FormData(form);
      const btn = form.querySelector('button[type="submit"]');

      // guard against double-submits
      if (btn && btn.disabled) return;
      if (btn) { btn.disabled = true; btn.setAttribute('aria-disabled', 'true'); }

      setBusy(job, true);
      setStatus(job, 'Running…', true);
      setOutput('out-' + job, '');

      try {
        const resp = await fetch(form.getAttribute('action') || (window.location.pathname + "?handler=RunFunction"), {
          method: "POST",
          headers: { "RequestVerificationToken": getToken(form) },
          body: data
        });
        const json = await resp.json();
        setOutput('out-' + job, json.output);
        setStatus(job, json.ok ? 'Completed (' + (json.status ?? 200) + ')' : 'Failed (' + (json.status ?? resp.status) + ')', json.ok);
      } catch(err){
        setOutput('out-' + job, 'Client error: ' + err);
        setStatus(job, 'Failed (client)', false);
      } finally {
        setBusy(job, false);
        if (btn) { btn.disabled = false; btn.removeAttribute('aria-disabled'); }
      }
    });
  });

  // Run stored procedure (disable until done)
  const spForm = document.querySelector('form.ajax-form-sp');
  if (spForm){
    spForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = spForm.querySelector('button[type="submit"]');
      if (btn && btn.disabled) return;
      if (btn) { btn.disabled = true; btn.setAttribute('aria-disabled', 'true'); }

      setBusy(null, true);
      setOutput('out-sp', 'Running…');

      try {
        const resp = await fetch(spForm.getAttribute('action') || (window.location.pathname + "?handler=RunSp"), {
          method: "POST",
          headers: { "RequestVerificationToken": getToken(spForm) },
          body: new FormData(spForm)
        });
        const json = await resp.json();
        setOutput('out-sp', json.output || (json.ok ? 'Done.' : 'Failed.'));
      } catch(err){
        setOutput('out-sp', 'Client error: ' + err);
      } finally {
        setBusy(null, false);
        if (btn) { btn.disabled = false; btn.removeAttribute('aria-disabled'); }
      }
    });
  }

  // Copy buttons
  document.querySelectorAll('button[data-copy]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const sel = btn.getAttribute('data-copy');
      const el = document.querySelector(sel);
      if (el) {
        await navigator.clipboard.writeText(el.textContent || '');
        const g = document.getElementById('globalStatus');
        if (g){ g.textContent = 'Output copied to clipboard.'; setTimeout(()=> g.textContent='', 2000); }
      }
    });
  });
})();
</script>
}
