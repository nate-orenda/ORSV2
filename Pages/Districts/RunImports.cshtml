@page
@model ORSV2.Pages.Districts.RunImportsModel
@{
    ViewData["Title"] = "Run Imports";
    var jobs = new[]{
        "ImportSchools", "ImportCodes", "ImportStaff", "ImportStaffAssignments",
        "ImportCourses", "ImportStudents", "ImportDiscipline",
        "ImportGrades", "ImportMasterSchedule", "ImportReportCards",
        "ImportAttendance", "ImportStudentClasses", "ImportTeachers"
    };
}

<partial name="_Breadcrumbs" model="Model.Breadcrumbs" />

<div class="orenda-container">
    <div class="orenda-header">
        <h2 class="mb-1">Run Imports – @Model.District?.Name</h2>
        <p class="mb-0">District ID: <strong>@Model.DistrictId</strong></p>
    </div>

    <div class="orenda-card shadow-orenda">
        <div class="orenda-card-body">
            <div class="d-flex align-items-center gap-2 mb-3">
                <span class="badge checkpoint-badge">Admin Tools</span>
                <div id="globalStatus" class="text-muted small"></div>
            </div>

            <div class="orenda-table-wrapper">
                <table class="table orenda-table align-middle">
                    <thead>
                        <tr>
                            <th style="width:220px">Job</th>
                            <th style="width:220px">Actions</th>
                            <th style="width:160px">Status</th>
                            <th>Output</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var job in jobs)
                        {
                            <tr>
                                <td>
                                    <span class="school-badge">@job</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <form method="post" asp-page-handler="RunFunction" class="ajax-form" data-job="@job">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="job" value="@job" />
                                            <input type="hidden" name="districtId" value="@Model.DistrictId" />
                                            <button type="submit" class="btn-action btn-edit">
                                                Run
                                            </button>
                                        </form>

                                        <button type="button"
                                                class="btn-action btn-print"
                                                data-copy="#out-@job">
                                            Copy Output
                                        </button>

                                        <div class="spinner-border spinner-border-sm text-primary d-none"
                                             id="spin-@job" role="status" aria-hidden="true"></div>
                                    </div>
                                </td>
                                <td>
                                    <span id="status-@job" class="text-muted">Idle</span>
                                </td>
                                <td>
                                    <pre id="out-@job" class="mb-0" style="white-space:pre-wrap; font-size:.85rem;"></pre>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>

            <!-- Stored procedure runner (kept separate) -->
            <div class="p-3 border rounded-3 mt-3">
                <div class="d-flex align-items-center justify-content-between">
                    <h6 class="mb-0">Update Guidance Alignment</h6>
                    <div class="spinner-border spinner-border-sm text-primary d-none" role="status" id="spin-sp" aria-hidden="true"></div>
                </div>
                <p class="text-muted small mt-2">
                    Runs <code>EXEC sp_UpdateAllGuidanceAlignment @Model.DistrictId</code> for District @Model.DistrictId.
                </p>
                <form method="post" asp-page-handler="RunSp" class="ajax-form-sp">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="districtId" value="@Model.DistrictId" />
                    <button type="submit" class="btn btn-primary btn-sm">Run Stored Procedure</button>
                </form>
                <pre id="out-sp" class="mt-3 mb-0" style="white-space:pre-wrap; font-size:.85rem;"></pre>
            </div>
        </div>
    </div>
</div>

@section Scripts{
<script>
(function(){
  function setBusy(job, busy) {
    const spin = document.getElementById(job ? 'spin-' + job : 'spin-sp');
    if (!spin) return;
    spin.classList.toggle('d-none', !busy);
  }
  function setStatus(job, text, ok) {
    const el = document.getElementById('status-' + job);
    if (el) {
      el.textContent = text;
      el.className = ok ? 'text-success' : (text === 'Idle' ? 'text-muted' : 'text-danger');
    }
  }
  function setOutput(id, text) {
    const el = document.getElementById(id);
    if (el) el.textContent = text || '';
  }
  function getToken(form){
    const token = form.querySelector('input[name="__RequestVerificationToken"]');
    return token ? token.value : '';
  }
  function disableAllRunButtons(disable, runningText) {
    document.querySelectorAll('form.ajax-form button[type="submit"], form.ajax-form-sp button[type="submit"]').forEach(b => {
      if (disable) {
        b.disabled = true;
        b.setAttribute('aria-disabled', 'true');
        b.classList.add('btn-busy');
        if (runningText) b.textContent = runningText;
      } else {
        b.disabled = false;
        b.removeAttribute('aria-disabled');
        b.classList.remove('btn-busy');
        if (b.closest('form').classList.contains('ajax-form-sp')) {
          b.textContent = 'Run Stored Procedure';
        } else {
          b.textContent = 'Run';
        }
      }
    });
  }

  // Run individual functions
  document.querySelectorAll('form.ajax-form').forEach(form => {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const job = form.dataset.job;
      const data = new FormData(form);

      disableAllRunButtons(true, 'Running…');
      setBusy(job, true);
      setStatus(job, 'Running…', true);
      setOutput('out-' + job, '');

      try {
        const resp = await fetch(form.getAttribute('action') || (window.location.pathname + "?handler=RunFunction"), {
          method: "POST",
          headers: { "RequestVerificationToken": getToken(form) },
          body: data
        });
        const json = await resp.json();
        setOutput('out-' + job, json.output);
        setStatus(job,
          json.ok ? 'Completed (' + (json.status ?? 200) + ')' : 'Failed (' + (json.status ?? resp.status) + ')',
          json.ok
        );
      } catch(err){
        setOutput('out-' + job, 'Client error: ' + err);
        setStatus(job, 'Failed (client)', false);
      } finally {
        setBusy(job, false);
        disableAllRunButtons(false);
      }
    });
  });

  // Run stored procedure
  const spForm = document.querySelector('form.ajax-form-sp');
  if (spForm){
    spForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      disableAllRunButtons(true, 'Running…');
      setBusy(null, true);
      setOutput('out-sp', 'Running…');

      try {
        const resp = await fetch(spForm.getAttribute('action') || (window.location.pathname + "?handler=RunSp"), {
          method: "POST",
          headers: { "RequestVerificationToken": getToken(spForm) },
          body: new FormData(spForm)
        });
        const json = await resp.json();
        setOutput('out-sp', json.output || (json.ok ? 'Done.' : 'Failed.'));
      } catch(err){
        setOutput('out-sp', 'Client error: ' + err);
      } finally {
        setBusy(null, false);
        disableAllRunButtons(false);
      }
    });
  }

  // Copy buttons
  document.querySelectorAll('button[data-copy]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const sel = btn.getAttribute('data-copy');
      const el = document.querySelector(sel);
      if (el) {
        await navigator.clipboard.writeText(el.textContent || '');
        const g = document.getElementById('globalStatus');
        if (g){ g.textContent = 'Output copied to clipboard.'; setTimeout(()=> g.textContent='', 2000); }
      }
    });
  });
})();
</script>
}


