@page "{schoolId:int}/{grade:int}"
@model ORSV2.Pages.GuidanceAlignment.StudentsModel
@using System.Text.Json
@{
    ViewData["Title"] = $"Students - Grade {Model.Grade}";
}

<!-- Breadcrumbs -->
<partial name="_Breadcrumbs" model="Model.Breadcrumbs" />

<div class="row">
    <!-- Left: Indicator Bar Chart -->
    <div class="col-md-6 mb-4 d-flex">
        <div class="card shadow-sm p-3 w-100 d-flex flex-column align-self-end">
            <!-- Summary Table (no header) -->
            <table class="table table-sm mb-2">
                <tr>
                    <td><strong>Grade:</strong> @Model.Grade</td>
                    <td><strong>Checkpoint:</strong> @Model.CurrentCheckpoint</td>
                    <td><strong>Above %:</strong> @Model.FormatPercentage(@Model.AboveTheLineCount)</td>
                    <td><strong>Above #:</strong> @Model.AboveTheLineCount</td>
                    <td><strong>Total:</strong> @Model.TotalCount</td>
                </tr>
            </table>

            <!-- Detailed Indicator Table -->
            <table class="table table-sm table-bordered text-center mb-3">
                <thead class="table-light">
                    <tr>
                        <th>Grade</th>
                        <th>CP</th>
                        <th>Indicator</th>
                        <th>% Met</th>
                        <th># Met</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.IndicatorSummaries != null)
                    {
                        @foreach (var i in Model.IndicatorSummaries)
                        {
                            <tr>
                                <td>@Model.Grade</td>
                                <td>@Model.CurrentCheckpoint</td>
                                <td>@i.Name</td>
                                <td>@i.PercentMet.ToString("0.0")%</td>
                                <td>@i.CountMet</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>

            <h6 class="text-center mb-3">Indicators Met – Grade @Model.Grade</h6>
            @if (Model.IndicatorSummaries?.Any() == true)
            {
                <canvas id="indicatorChart"></canvas>
            }
            else
            {
                <div class="alert alert-info text-center mb-0">
                    No indicators found for this grade/checkpoint.
                </div>
            }
        </div>
    </div>

    <!-- Right: Quadrant Pie Chart -->
    <div class="col-md-6 mb-4 d-flex">
        <div class="card shadow-sm p-3 w-100 d-flex flex-column justify-content-end">
            <h6 class="text-center mb-3">Quadrant Distribution – Grade @Model.Grade</h6>
            <canvas id="quadrantPie"></canvas>
        </div>
    </div>
</div>

<!-- Updated Student Table with Dynamic Indicators -->
<div class="card shadow-sm border-0">
    <div class="card-body p-2">
        <h5 class="card-title mb-3 px-2">Student List – Grade @Model.Grade</h5>

        <div class="table-responsive">
            <table class="table table-sm table-hover table-striped mb-0" id="studentsTable" style="font-size: 0.85rem;">
                <thead class="table-dark">
                    <tr>
                        <th class="py-2">Name</th>
                        <th class="py-2">ID</th>
                        <th class="py-2">Gr</th>
                        <th class="py-2">Counselor</th>
                        <th class="py-2">Race/Ethnicity</th>
                        <th class="py-2 text-center">SWD</th>
                        <th class="py-2 text-center">SED</th>
                        <th class="py-2 text-center">LF</th>
                        <th class="py-2 text-center">Yrs</th>
                        <th class="py-2 text-center">Curr GPA</th>
                        <th class="py-2 text-center">Cum GPA</th>
                        <th class="py-2 text-center">Credits</th>
                        
                        <!-- Dynamic Indicator Columns -->
                        @if (Model.IndicatorSummaries != null)
                        {
                            @foreach (var indicator in Model.IndicatorSummaries)
                            {
                                <th class="py-2 text-center">@GetIndicatorDisplayName(indicator.Name)</th>
                            }
                        }
                        
                        <th class="py-2 text-center">Quadrant</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var s in Model.Students)
                    {
                        <tr style="font-size: 0.8rem;">
                            <td class="py-1">
                                <a href="#" class="fw-semibold text-decoration-none view-profile" data-bs-toggle="modal"
                                   data-bs-target="#profileModal" data-student-id="@s.ResultId">
                                    @s.LastName, @s.FirstName
                                </a>
                            </td>
                            <td class="py-1"><span class="badge bg-secondary fs-6">@s.LocalStudentId</span></td>
                            <td class="py-1">@s.Grade</td>
                            <td class="py-1">@((!string.IsNullOrEmpty(s.CounselorName) && s.CounselorName.Length > 15) ? s.CounselorName.Substring(0, 15) + "..." : s.CounselorName ?? "-")</td>
                            <td class="py-1">@((!string.IsNullOrEmpty(s.RaceEthnicity) && s.RaceEthnicity.Length > 20) ? s.RaceEthnicity.Substring(0, 20) + "..." : s.RaceEthnicity ?? "-")</td>
                            <td class="py-1 text-center">
                                <span class="badge @(s.SWD == true ? "bg-warning" : "bg-light text-muted") fs-6">
                                    @(s.SWD == true ? "Y" : "N")
                                </span>
                            </td>
                            <td class="py-1 text-center">
                                <span class="badge @(s.SED == true ? "bg-info" : "bg-light text-muted") fs-6">
                                    @(s.SED == true ? "Y" : "N")
                                </span>
                            </td>
                            <td class="py-1 text-center">@(s.LF ?? "-")</td>
                            <td class="py-1 text-center">@(s.YrsInProgram?.ToString("0.0") ?? "-")</td>
                            <td class="py-1 text-center">@(s.CurrentGPA?.ToString("0.00") ?? "-")</td>
                            <td class="py-1 text-center">@(s.CumulativeGPA?.ToString("0.00") ?? "-")</td>
                            <td class="py-1 text-center">@(s.CreditsCompleted?.ToString("0.#") ?? "-")</td>
                            
                            <!-- Dynamic Indicator Values -->
                            @if (Model.IndicatorSummaries != null)
                            {
                                @foreach (var indicator in Model.IndicatorSummaries)
                                {
                                    var value = GetIndicatorValue(s, indicator.Name);
                                    <td class="py-1 text-center">
                                        <span class="badge @(value == true ? "bg-success" : value == false ? "bg-danger" : "bg-secondary") fs-6">
                                            @(value == true ? "✓" : value == false ? "✗" : "-")
                                        </span>
                                    </td>
                                }
                            }
                            
                            <td class="py-1 text-center">
                                <span class="badge 
                                    @(s.Quadrant == "Challenge" ? "bg-primary" :
                                    s.Quadrant == "Benchmark" ? "bg-success" :
                                    s.Quadrant == "Strategic" ? "bg-warning text-dark" :
                                    s.Quadrant == "Intensive" ? "bg-danger" :
                                    "bg-secondary") fs-6">
                                    @(s.Quadrant ?? "-")
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileModalLabel">Student Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="profileContent">Loading...</div>
            </div>
        </div>
    </div>
</div>

@functions {
    bool? GetIndicatorValue(ORSV2.Models.GAResults student, string indicatorName)
    {
        return indicatorName switch
        {
            "OnTrack" => student.OnTrack,
            "GPA" => student.GPA,
            "AGGrades" => student.AGGrades,
            "AGSchedule" => student.AGSchedule,
            "Affiliation" => student.Affiliation,
            "FAFSA" => student.FAFSA,
            "CollegeApplication" => student.CollegeApplication,
            "Attendance" => student.Attendance,
            "Referrals" => student.Referrals,
            "Grades" => student.Grades,
            "ELA" => student.AssessmentsELA,
            "Math" => student.AssessmentsMath,
            _ => null
        };
    }

    string GetIndicatorDisplayName(string indicatorName)
    {
        return indicatorName switch
        {
            "OnTrack" => "On Track",
            "AGGrades" => "A-G Grades",
            "AGSchedule" => "A-G Schedule",
            "CollegeApplication" => "College App",
            "AssessmentsELA" => "ELA",
            "AssessmentsMath" => "Math",
            _ => indicatorName
        };
    }
}

<style>
    #indicatorChart {
        max-height: 300px;
    }
</style>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var modal = document.getElementById('profileModal');
            modal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var studentId = button.getAttribute('data-student-id');
                fetch(`/GuidanceAlignment/GAProfileCard?id=${studentId}`)
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById("profileContent").innerHTML = html;

                        // ✅ Extract and execute the script manually
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        const scriptTag = tempDiv.querySelector('script');
                        if (scriptTag) {
                            eval(scriptTag.textContent);
                        }
                    });

            });

            // DataTable initialization
            $('#studentsTable').DataTable({
                responsive: true,
                pageLength: 50,
                lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "All"]],
                order: [[0, 'asc']],
                dom: 'Blfrtip',
                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: '<i class="fas fa-file-excel"></i> Excel',
                        className: 'btn btn-success btn-sm'
                    },
                    {
                        extend: 'csvHtml5', 
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        className: 'btn btn-info btn-sm'
                    },
                    {
                        extend: 'print',
                        text: '<i class="fas fa-print"></i> Print', 
                        className: 'btn btn-secondary btn-sm'
                    }
                ],
                columnDefs: [
                    { width: "150px", targets: 0 }, // Name
                    { width: "80px", targets: 1 },  // ID
                    { width: "40px", targets: 2 },  // Grade
                    { width: "100px", targets: 3 }, // Counselor
                    { width: "120px", targets: 4 }, // Race/Ethnicity
                    { width: "40px", targets: [5,6,7] }, // SWD, SED, LF
                    { width: "50px", targets: [8,9,10,11] }, // Numeric columns
                    { className: "text-center", targets: [1,2,5,6,7,8,9,10,11] }
                ],
                language: {
                    search: "Search students:",
                    lengthMenu: "Show _MENU_ students",
                    info: "Showing _START_ to _END_ of _TOTAL_ students"
                }
            });
        });
    </script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const indicatorData = @Html.Raw(JsonSerializer.Serialize(Model.IndicatorSummaries));
        const indicatorLabels = indicatorData.map(i => i.Name);
        const indicatorPercents = indicatorData.map(i => i.PercentMet.toFixed(1));

        if (indicatorData.length > 0) {
            if (window.indicatorChartInstance) {
                window.indicatorChartInstance.destroy();
            }

            window.indicatorChartInstance = new Chart(document.getElementById('indicatorChart'), {
                type: 'bar',
                data: {
                    labels: indicatorLabels,
                    datasets: [{
                        label: '% Met',
                        data: indicatorPercents,
                        backgroundColor: '#0d6efd'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: '% Met' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    });
</script>

<script>
    const quadrantCounts = @Html.Raw(JsonSerializer.Serialize(Model.QuadrantCounts));
    const aboveCount = @Model.AboveTheLineCount;
    const belowCount = @Model.BelowTheLineCount;
    const total = @Model.TotalCount;

    const quadrantPie = new Chart(document.getElementById('quadrantPie'), {
        type: 'pie',
        data: {
            labels: [
                `Challenge (${quadrantCounts["Challenge"] || 0})`,
                `Benchmark (${quadrantCounts["Benchmark"] || 0})`,
                `Strategic (${quadrantCounts["Strategic"] || 0})`,
                `Intensive (${quadrantCounts["Intensive"] || 0})`
            ],
            datasets: [{
                data: [
                    quadrantCounts["Challenge"] || 0,
                    quadrantCounts["Benchmark"] || 0,
                    quadrantCounts["Strategic"] || 0,
                    quadrantCounts["Intensive"] || 0
                ],
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545'],
                borderColor: '#fff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    align: 'center'  // this is default, but makes intent clear
                },
                title: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const percent = ((value / total) * 100).toFixed(1);
                            return `${context.label}: ${value} (${percent}%)`;
                        }
                    }
                }
            }
        }
    });
</script>

}