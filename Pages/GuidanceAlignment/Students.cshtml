@page "{schoolId:int}/{grade:int}"
@model ORSV2.Pages.GuidanceAlignment.StudentsModel
@using System.Text.Json
@{
    ViewData["Title"] = $"Students - Grade {Model.Grade}";
}

@functions {
    bool? GetIndicatorValue(ORSV2.Models.GAResults student, string indicatorName)
    {
        return indicatorName switch
        {
            "OnTrack" => student.OnTrack,
            "GPA" => student.GPA,
            "AGGrades" => student.AGGrades,
            "AGSchedule" => student.AGSchedule,
            "Affiliation" => student.Affiliation,
            "FAFSA" => student.FAFSA,
            "CollegeApplication" => student.CollegeApplication,
            "Attendance" => student.Attendance,
            "Referrals" => student.Referrals,
            "Grades" => student.Grades,
            "ELA" => student.AssessmentsELA,
            "Math" => student.AssessmentsMath,
            _ => null
        };
    }

    string GetIndicatorDisplayName(string indicatorName)
    {
        return indicatorName switch
        {
            "OnTrack" => "On Track",
            "AGGrades" => "A-G Grades",
            "AGSchedule" => "A-G Schedule",
            "CollegeApplication" => "College App",
            "AssessmentsELA" => "ELA",
            "AssessmentsMath" => "Math",
            _ => indicatorName
        };
    }
}
@section Styles {
    <style>
        #loader-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 1rem;
            transition: opacity 0.3s ease-in-out;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        #loader-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }
        #indicatorChart {
            max-height: 300px;
        }
        
        /* NEW: This container enables both vertical scrolling for the table body and horizontal scrolling for the whole table */
        .table-scroll-container {
            overflow: auto; /* Handles both x and y scroll */
            max-height: 70vh; /* Example height, adjust as needed */
            position: relative;
        }

        /* NEW: This makes the header sticky within the scrolling container */
        #studentsTable > thead th {
            position: -webkit-sticky; /* For Safari */
            position: sticky;
            top: 0;
            z-index: 10;
            background-color: #f8f9fa; /* Match table-light */
            box-shadow: inset 0 -2px 0 #dee2e6; /* Clean bottom border */
        }

        /* Keep all your existing drag/drop and grouping styles */
        .grouping-area {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
            min-height: 60px;
            transition: all 0.3s ease;
        }
        
        .grouping-area.drag-over {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        
        .grouping-area .ga-placeholder {
            color: #6c757d;
            font-style: italic;
            text-align: center;
            line-height: 30px;
            background: transparent; /* ensure no grey fill */
        }

        
        .group-tag {
            display: inline-block;
            background: #007bff;
            color: white;
            padding: 5px 12px;
            margin: 2px;
            border-radius: 20px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        
        .group-tag .remove {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .draggable-header {
            cursor: move;
            user-select: none;
        }
        /* Show/hide clear grouping button nicely */
        .clear-grouping {
            margin-left: auto;
            display: none; /* JS shows it when groups exist */
        }

        button.clear-grouping.btn {
            --bs-btn-padding-y: .25rem;
            --bs-btn-padding-x: .5rem;
            --bs-btn-font-size: .875rem;
        }

        /* Kill jQuery UI’s default active/hover grey states */
        .grouping-area.ui-droppable-active,
        .grouping-area.ui-state-active,
        .grouping-area.ui-state-hover {
            background: #f8f9fa !important;
            border-color: #dee2e6 !important;
        }

        #studentsTable tbody tr { cursor: pointer; }
        tr.dtrg-start { cursor: pointer; } /* group headers still clickable */


        /* Optional: nicer drag cursor */
        .draggable-header { cursor: grab; }
        .ui-draggable-dragging { cursor: grabbing; }
        .clickable-group-header { cursor: pointer; pointer-events: auto; }
        
        /* ===== Orenda-Styled Student Table ===== */

        /* Header Styling */
        #studentsTable > thead th {
            /* Apply a subtle gradient background from your theme */
            background: linear-gradient(135deg, var(--orenda-secondary, #f8f9fb) 0%, var(--orenda-border, #e9ecef) 100%);
            
            /* Center-align text and vertically align for the sort icons */
            text-align: center;
            vertical-align: middle;

            /* Text styling to match .orenda-table from site.css */
            color: #495057;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.7rem; /* slightly smaller for this compact table */
            letter-spacing: .5px;
            white-space: nowrap;

            /* KEY FIX: Add padding on the right to make space for sort arrows */
            padding-right: 1.5rem !important;
        }

        /* Row Styling */
        #studentsTable tbody td {
            /* Add a clean, light border between rows */
            border-bottom: 1px solid #f1f3f4;
            vertical-align: middle;
        }

        /* Remove the border from the very last row for a cleaner look */
        #studentsTable tbody tr:last-child td {
            border-bottom: none;
        }

        /* Orenda-style hover effect for rows */
        #studentsTable tbody tr:hover {
            background-color: #f8f9ff; /* A subtle blue-tinted white */
            color: var(--orenda-primary);
        }

        /* Smooth transition for the hover effect */
        #studentsTable tbody tr {
            transition: background-color 0.2s ease-in-out;
        }
        .condensed-column {
            max-width: 120px; /* Adjust this width as needed */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

    </style>
}

<!-- Breadcrumbs -->
<partial name="_Breadcrumbs" model="Model.Breadcrumbs" />
<div id="loader-overlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="text-muted">Loading student data...</p>
</div>

<div id="page-content-wrapper" style="visibility: hidden;">
<form id="createGroupForm"
      method="post"
      asp-page-handler="CreateTargetGroup"
      asp-route-schoolId="@Model.SchoolId">
  @Html.AntiForgeryToken()
  <input type="hidden" id="tgFormName" name="groupName" />
  <input type="hidden" id="tgFormNote"  name="note" />
  <input type="hidden" id="tgFormIds"   name="studentIds" />
</form>


<div class="row">
    <!-- Left: Indicator Bar Chart -->
    <div class="col-md-6 mb-4 d-flex">
        <div class="card shadow-sm p-3 w-100 d-flex flex-column align-self-end">
            <form method="get" class="d-flex align-items-center gap-2 mb-2">
                <input type="hidden" name="SchoolId" value="@Model.SchoolId" />
                <input type="hidden" name="Grade" value="@Model.Grade" />

                <label for="gaFilter" class="fw-semibold text-primary me-2">Filter:</label>
                <select id="gaFilter" name="Filter" class="form-select form-select-sm orenda-select" onchange="this.form.submit()">
                    <option value="ALL" selected="@(Model.Filter is null || Model.Filter.ToUpper() == "ALL")">All students (default)</option>
                    <option value="SWD" selected="@(Model.Filter?.ToUpper() == "SWD")">Students with Disabilities (SWD)</option>
                    <option value="SED" selected="@(Model.Filter?.ToUpper() == "SED")">Low Income Students (SED)</option>
                    <option value="EL" selected="@(Model.Filter?.ToUpper() == "EL")">English Learners (EL)</option>
                    <option value="RFEP" selected="@(Model.Filter?.ToUpper() == "RFEP")">Redesignated English Proficient (RFEP)</option>
                    <option value="G_M" selected="@(Model.Filter?.ToUpper() == "G_M")">Gender (Male)</option>
                    <option value="G_F" selected="@(Model.Filter?.ToUpper() == "G_F")">Gender (Female)</option>
                    <option value="G_X" selected="@(Model.Filter?.ToUpper() == "G_X")">Gender (X)</option>
                    <option value="RE_BLACK" selected="@(Model.Filter?.ToUpper() == "RE_BLACK")">Black or African American</option>
                    <option value="RE_HISP" selected="@(Model.Filter?.ToUpper() == "RE_HISP")">Hispanic or Latino</option>
                    <option value="FOSTER" selected="@(Model.Filter?.ToUpper() == "FOSTER")">Foster</option>
                    <option value="MIGRANT" selected="@(Model.Filter?.ToUpper() == "MIGRANT")">Migrant</option>
                    <option value="HOMELESS" selected="@(Model.Filter?.ToUpper() == "HOMELESS")">Homeless</option>
                </select>

                <span class="badge bg-light text-dark ms-1" title="Active filter">
                    @Model.ActiveFilterLabel
                </span>
            </form>
            <!-- Summary Table (no header) -->
            <table class="table table-sm mb-2">
                <tr>
                    <td><strong>Grade:</strong> @Model.Grade</td>
                    <td><strong>Checkpoint:</strong> @Model.CurrentCheckpoint</td>
                    <td><strong>Above %:</strong> @Model.FormatPercentage(@Model.AboveTheLineCount)</td>
                    <td><strong>Above #:</strong> @Model.AboveTheLineCount</td>
                    <td><strong>Total:</strong> @Model.TotalCount</td>
                </tr>
            </table>

            <!-- Detailed Indicator Table -->
            <table class="table table-sm table-bordered text-center mb-3">
                <thead class="table-light">
                    <tr>
                        <th>Grade</th>
                        <th>CP</th>
                        <th>Indicator</th>
                        <th>% Met</th>
                        <th># Met</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.IndicatorSummaries != null)
                    {
                        @foreach (var i in Model.IndicatorSummaries)
                        {
                            <tr>
                                <td>@Model.Grade</td>
                                <td>@Model.CurrentCheckpoint</td>
                                <td>@i.Name</td>
                                <td>@i.PercentMet.ToString("0.0")%</td>
                                <td>@i.CountMet</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>

            <h6 class="text-center mb-3">Indicators Met – Grade @Model.Grade</h6>
            @if (Model.IndicatorSummaries?.Any() == true)
            {
                <canvas id="indicatorChart"></canvas>
            }
            else
            {
                <div class="alert alert-info text-center mb-0">
                    No indicators found for this grade/checkpoint.
                </div>
            }
        </div>
    </div>

    <!-- Right: Quadrant Pie Chart -->
    <div class="col-md-6 mb-4 d-flex">
        <div class="card shadow-sm p-3 w-100 d-flex flex-column justify-content-end">
            <h6 class="text-center mb-3">Quadrant Distribution – Grade @Model.Grade</h6>
            <canvas id="quadrantPie"></canvas>
        </div>
    </div>
</div>

<!-- Updated Student Table with Drag-to-Group -->
<div class="card shadow-sm border-0">
    <div class="card-body p-2">
        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
            <h5 class="card-title mb-0">Student List – Grade @Model.Grade</h5>
            <div class="d-flex align-items-center">
                <button type="button" class="btn btn-outline-danger btn-sm clear-grouping" onclick="StudentGrouping.clearGrouping()" style="display:none;">
                    <i class="bi bi-x-circle"></i> Clear Grouping
                </button>
            </div>
        </div>

        <!-- Drag and Drop Grouping Area -->
        <div class="grouping-area" id="groupingArea" 
             data-placeholder="Drag column headers here to group students by that field">
        </div>
        <div id="studentsToolbar" class="students-toolbar">
            <div class="left">
                <div id="dtButtons"></div>
                <button id="createTargetGroupBtn" class="btn btn-orenda-primary btn-sm condensed-btn" disabled>
                    <i class="bi bi-bullseye"></i> Create Target Group
                </button>
                <a class="btn btn-orenda-primary btn-sm condensed-btn"
                    asp-page="/GuidanceAlignment/ViewTargetGroups"
                    asp-route-schoolId="@Model.SchoolId">
                    View Target Groups
                </a>
                <a class="btn btn-orenda-primary btn-sm condensed-btn"
                    asp-page="/GuidanceAlignment/CompareCP"
                    asp-route-schoolId="@Model.SchoolId"
                    asp-route-grade="@Model.Grade">
                    Compare Checkpoints
                </a>
            </div>
            <div class="right">
                <input id="studentsSearch" class="form-control form-control-sm" placeholder="Search students…" />
            </div>
        </div>
        <!-- Container for scrolling -->
        <div class="table-scroll-container">
            <table class="table table-sm table-hover table-striped mb-0" id="studentsTable">
                <thead class="table-light">
                    <tr>
                        <!-- REMOVED sort icons. DataTables will add them automatically. -->
                        <th class="py-2 draggable-header" data-column="name">Name</th>
                        <th class="py-2 draggable-header" data-column="id">ID</th>
                        <th class="py-2 draggable-header" data-column="grade">Gr</th>
                        <th class="py-2 draggable-header" data-column="counselor">Counselor</th>
                        <th class="py-2 draggable-header" data-column="race">Race/Eth</th>
                        <th class="py-2 text-center draggable-header" data-column="swd">SWD</th>
                        <th class="py-2 text-center draggable-header" data-column="sed">SED</th>
                        <th class="py-2 text-center draggable-header" data-column="lf">LF</th>
                        <th class="py-2 text-center draggable-header" data-column="years">Yrs</th>
                        <th class="py-2 text-center draggable-header" data-column="currentgpa">Curr GPA</th>
                        <th class="py-2 text-center draggable-header" data-column="cumgpa">Cum GPA</th>
                        <th class="py-2 text-center draggable-header" data-column="credits">Credits</th>
                        
                        <!-- Dynamic Indicator Columns -->
                        @if (Model.IndicatorSummaries != null)
                        {
                            @foreach (var indicator in Model.IndicatorSummaries)
                            {
                                <th class="py-2 text-center draggable-header" data-column="@indicator.Name.ToLower()">@GetIndicatorDisplayName(indicator.Name)</th>
                            }
                        }
                        
                        <th class="py-2 text-center draggable-header" data-column="quadrant">Quadrant</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var s in Model.Students)
                    {
                        <tr style="font-size: 0.8rem;" 
                            data-name="@s.LastName, @s.FirstName"
                            data-id="@s.LocalStudentId"
                            data-grade="@s.Grade"
                            data-counselor="@(s.CounselorName ?? "")"
                            data-race="@(s.RaceEthnicity ?? "")"
                            data-swd="@(s.SWD == true ? "Yes" : "No")"
                            data-sed="@(s.SED == true ? "Yes" : "No")"
                            data-lf="@(s.LF ?? "")"
                            data-years="@(s.YrsInProgram?.ToString("0.0") ?? "")"
                            data-currentgpa="@(s.CurrentGPA?.ToString("0.00") ?? "")"
                            data-cumgpa="@(s.CumulativeGPA?.ToString("0.00") ?? "")"
                            data-credits="@(s.CreditsCompleted?.ToString("0.#") ?? "")"
                            @if (Model.IndicatorSummaries != null)
                            {
                                @foreach (var indicator in Model.IndicatorSummaries)
                                {
                                    var value = GetIndicatorValue(s, indicator.Name);
                                    @Html.Raw($"data-{indicator.Name.ToLower()}=\"{(value == true ? "Met" : value == false ? "Not Met" : "N/A")}\"")
                                }
                            }
                            data-quadrant="@(s.Quadrant ?? "")">
                            <td class="py-1">
                                <a href="#"
                                    class="fw-semibold text-decoration-none view-profile"
                                    data-bs-toggle="modal"
                                    data-bs-target="#profileModal"
                                    data-result-id="@s.ResultId"
                                    data-student-id="@(Model.StuIdByLocal.TryGetValue(s.LocalStudentId, out var stu) ? stu : 0)">
                                    @s.LastName, @s.FirstName
                                </a>
                            </td>
                            <td class="py-1"><span class="badge bg-secondary" style="font-size: 0.7rem;">@s.LocalStudentId</span></td>
                            <td class="py-1">@s.Grade</td>
                            <td class="py-1">@((!string.IsNullOrEmpty(s.CounselorName) && s.CounselorName.Length > 15) ? s.CounselorName.Substring(0, 15) + "..." : s.CounselorName ?? "-")</td>
                            <td class="py-1" title="@s.RaceEthnicity">@(s.RaceEthnicity ?? "-")</td>
                            <td class="py-1 text-center">
                                <span class="badge @(s.SWD == true ? "bg-warning" : "bg-light text-muted")" style="font-size: 0.7rem;">
                                    @(s.SWD == true ? "Y" : "N")
                                </span>
                            </td>
                            <td class="py-1 text-center">
                                <span class="badge @(s.SED == true ? "bg-info" : "bg-light text-muted")" style="font-size: 0.7rem;">
                                    @(s.SED == true ? "Y" : "N")
                                </span>
                            </td>
                            <td class="py-1 text-center">@(s.LF ?? "-")</td>
                            <td class="py-1 text-center">@(s.YrsInProgram?.ToString("0.0") ?? "-")</td>
                            <td class="py-1 text-center">@(s.CurrentGPA?.ToString("0.00") ?? "-")</td>
                            <td class="py-1 text-center">@(s.CumulativeGPA?.ToString("0.00") ?? "-")</td>
                            <td class="py-1 text-center">@(s.CreditsCompleted?.ToString("0.#") ?? "-")</td>
                            
                            <!-- Dynamic Indicator Values -->
                            @if (Model.IndicatorSummaries != null)
                            {
                                @foreach (var indicator in Model.IndicatorSummaries)
                                {
                                    var value = GetIndicatorValue(s, indicator.Name);
                                    <td class="py-1 text-center">
                                        <span class="badge @(value == true ? "bg-success" : value == false ? "bg-danger" : "bg-secondary")" style="font-size: 0.65rem; padding: 2px 6px;">
                                            @(value == true ? "✓" : value == false ? "✗" : "-")
                                        </span>
                                    </td>
                                }
                            }
                            
                            <td class="py-1 text-center">
                                <span class="badge 
                                    @(s.Quadrant == "Challenge" ? "bg-primary" :
                                    s.Quadrant == "Benchmark" ? "bg-success" :
                                    s.Quadrant == "Strategic" ? "bg-warning text-dark" :
                                    s.Quadrant == "Intensive" ? "bg-danger" :
                                    "bg-secondary")" style="font-size: 0.7rem; padding: 2px 6px;">
                                    @(s.Quadrant ?? "-")
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileModalLabel">Student Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="profileContent">Loading...</div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="createGroupModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Create Target Group</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Group name</label>
          <input id="tgName" class="form-control" placeholder="Target Group" />
        </div>
        <div class="mb-2">
          <label class="form-label">Note (optional)</label>
          <textarea id="tgNote" class="form-control" rows="3"></textarea>
        </div>
        <div class="text-muted small">Students selected: <span id="tgCount">0</span></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
        <button type="button" id="confirmCreateGroupBtn" class="btn btn-orenda-primary btn-sm">Create</button>
      </div>
    </div>
  </div>
</div>
</div>

@section Scripts {
    <!-- libs -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css">
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.0.2/css/buttons.bootstrap5.css">
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/dataTables.buttons.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.bootstrap5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.print.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/select/2.0.3/css/select.bootstrap5.css">
    <script src="https://cdn.datatables.net/select/2.0.3/js/dataTables.select.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/rowgroup/1.5.0/css/rowGroup.bootstrap5.css">
    <script src="https://cdn.datatables.net/rowgroup/1.5.0/js/dataTables.rowGroup.js"></script>

    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- If your _Layout does NOT already include Bootstrap bundle, add it: -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script> -->

    <!-- your page script -->
    <script src="~/js/students-grouping.js" asp-append-version="true"></script>

    <script>
      // Page data for charts
      window.studentPageData = {
        indicatorData: @Html.Raw(JsonSerializer.Serialize(Model.IndicatorSummaries)),
        quadrantCounts: @Html.Raw(JsonSerializer.Serialize(Model.QuadrantCounts)),
        aboveCount: @Model.AboveTheLineCount,
        belowCount: @Model.BelowTheLineCount,
        total: @Model.TotalCount
      };

      // Initialize once
      (function () {
        if (!window.__studentsInitDone) {
          window.__studentsInitDone = true;
          StudentGrouping.init({ schoolId: @Model.SchoolId, grade: @Model.Grade });
          if (window.StudentCharts?.init) StudentCharts.init();
        }
      })();
    </script>
}
