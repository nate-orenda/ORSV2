@page
@model ORSV2.Pages.GuidanceAlignment.StudentsModel
@using System.Text.Json
@{
    ViewData["Title"] = $"Students - Grade {Model.Grade}";
}

<!-- Breadcrumbs -->
<partial name="_Breadcrumbs" model="Model.Breadcrumbs" />

<div class="row">
    <!-- Left: Indicator Bar Chart -->
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm p-3">
            <h6 class="text-center mb-3">Indicators Met – Grade @Model.Grade</h6>
            <pre>@JsonSerializer.Serialize(Model.IndicatorSummaries)</pre>

            @if (Model.IndicatorSummaries?.Any() == true)
            {
                <canvas id="indicatorChart"></canvas>
            }
            else
            {
                <div class="alert alert-info text-center mb-0">
                    No indicators found for this grade/checkpoint.
                </div>
            }
        </div>
    </div>

    <!-- Right: Quadrant Pie Chart -->
    <div class="col-md-6 mb-4">
        <div class="card shadow-sm p-3">
            <h6 class="text-center mb-3">Quadrant Distribution – Grade @Model.Grade</h6>
                <canvas id="quadrantPie"></canvas>
        </div>
    </div>
</div>

<!-- Existing student table stays below -->
<div class="card shadow-sm mb-4 p-4">
    <h5 class="mb-3">Student List – Grade @Model.Grade</h5>
    <table class="table table-bordered table-striped">
        <thead class="table-light">
            <tr>
                <th>Name</th>
                <th>Local ID</th>
                <th>Quadrant</th>
                <th>OnTrack</th>
                <!-- Add more columns as needed -->
            </tr>
        </thead>
        <tbody>
        @foreach (var s in Model.Students)
        {
            <tr>
                <td><a href="#" class="view-profile" data-bs-toggle="modal" data-bs-target="#profileModal"
                    data-student-id="@s.ResultId">@s.LastName, @s.FirstName</a>
                </td>
                <td>@s.LocalStudentId</td>
                <td>@s.Quadrant</td>
                <td>@(s.OnTrack == true ? "Yes" : "No")</td>
            </tr>
        }
        </tbody>
    </table>
</div>

<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileModalLabel">Student Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="profileContent">Loading...</div>
            </div>
        </div>
    </div>
</div>

<style>
    #indicatorChart {
        max-height: 300px;
    }
</style>
@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var modal = document.getElementById('profileModal');
            modal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var studentId = button.getAttribute('data-student-id');
                fetch(`/GuidanceAlignment/GAProfileCard?id=${studentId}`)
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById("profileContent").innerHTML = html;

                        // ✅ Extract and execute the script manually
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        const scriptTag = tempDiv.querySelector('script');
                        if (scriptTag) {
                            eval(scriptTag.textContent);
                        }
                    });

            });
        });
    </script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const indicatorData = @Html.Raw(JsonSerializer.Serialize(Model.IndicatorSummaries));
        const indicatorLabels = indicatorData.map(i => i.Name);
        const indicatorPercents = indicatorData.map(i => i.PercentMet.toFixed(1));

        if (indicatorData.length > 0) {
            if (window.indicatorChartInstance) {
                window.indicatorChartInstance.destroy();
            }

            window.indicatorChartInstance = new Chart(document.getElementById('indicatorChart'), {
                type: 'bar',
                data: {
                    labels: indicatorLabels,
                    datasets: [{
                        label: '% Met',
                        data: indicatorPercents,
                        backgroundColor: '#0d6efd'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: '% Met' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    });
</script>


<script>
    const quadrantCounts = @Html.Raw(JsonSerializer.Serialize(Model.QuadrantCounts));
    const aboveCount = @Model.AboveTheLineCount;
    const belowCount = @Model.BelowTheLineCount;
    const total = @Model.TotalCount;

    const quadrantPie = new Chart(document.getElementById('quadrantPie'), {
        type: 'pie',
        data: {
            labels: [
                `Challenge (${quadrantCounts["Challenge"] || 0})`,
                `Benchmark (${quadrantCounts["Benchmark"] || 0})`,
                `Strategic (${quadrantCounts["Strategic"] || 0})`,
                `Intensive (${quadrantCounts["Intensive"] || 0})`
            ],
            datasets: [{
                data: [
                    quadrantCounts["Challenge"] || 0,
                    quadrantCounts["Benchmark"] || 0,
                    quadrantCounts["Strategic"] || 0,
                    quadrantCounts["Intensive"] || 0
                ],
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545'],
                borderColor: '#fff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    align: 'center'  // this is default, but makes intent clear
                },
                title: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const percent = ((value / total) * 100).toFixed(1);
                            return `${context.label}: ${value} (${percent}%)`;
                        }
                    }
                }
            }
        }
    });
</script>


}
