@page "{schoolId:int}/{grade:int}"
@model ORSV2.Pages.GuidanceAlignment.StudentsModel
@using System.Text.Json
@{
    ViewData["Title"] = $"Students - Grade {Model.Grade}";
}

@functions {
    bool? GetIndicatorValue(ORSV2.Models.GAResults student, string indicatorName)
    {
        return indicatorName switch
        {
            "OnTrack" => student.OnTrack,
            "GPA" => student.GPA,
            "AGGrades" => student.AGGrades,
            "AGSchedule" => student.AGSchedule,
            "Affiliation" => student.Affiliation,
            "FAFSA" => student.FAFSA,
            "CollegeApplication" => student.CollegeApplication,
            "Attendance" => student.Attendance,
            "Referrals" => student.Referrals,
            "Grades" => student.Grades,
            "ELA" => student.AssessmentsELA,
            "Math" => student.AssessmentsMath,
            _ => null
        };
    }

    string GetIndicatorDisplayName(string indicatorName)
    {
        return indicatorName switch
        {
            "OnTrack" => "On Track",
            "AGGrades" => "A-G Grades",
            "AGSchedule" => "A-G Schedule",
            "CollegeApplication" => "College App",
            "AssessmentsELA" => "ELA",
            "AssessmentsMath" => "Math",
            _ => indicatorName
        };
    }
}

<!-- Breadcrumbs -->
<partial name="_Breadcrumbs" model="Model.Breadcrumbs" />

<div class="row">
    <!-- Left: Indicator Bar Chart -->
    <div class="col-md-6 mb-4 d-flex">
        <div class="card shadow-sm p-3 w-100 d-flex flex-column align-self-end">
            <!-- Summary Table (no header) -->
            <table class="table table-sm mb-2">
                <tr>
                    <td><strong>Grade:</strong> @Model.Grade</td>
                    <td><strong>Checkpoint:</strong> @Model.CurrentCheckpoint</td>
                    <td><strong>Above %:</strong> @Model.FormatPercentage(@Model.AboveTheLineCount)</td>
                    <td><strong>Above #:</strong> @Model.AboveTheLineCount</td>
                    <td><strong>Total:</strong> @Model.TotalCount</td>
                </tr>
            </table>

            <!-- Detailed Indicator Table -->
            <table class="table table-sm table-bordered text-center mb-3">
                <thead class="table-light">
                    <tr>
                        <th>Grade</th>
                        <th>CP</th>
                        <th>Indicator</th>
                        <th>% Met</th>
                        <th># Met</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.IndicatorSummaries != null)
                    {
                        @foreach (var i in Model.IndicatorSummaries)
                        {
                            <tr>
                                <td>@Model.Grade</td>
                                <td>@Model.CurrentCheckpoint</td>
                                <td>@i.Name</td>
                                <td>@i.PercentMet.ToString("0.0")%</td>
                                <td>@i.CountMet</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>

            <h6 class="text-center mb-3">Indicators Met – Grade @Model.Grade</h6>
            @if (Model.IndicatorSummaries?.Any() == true)
            {
                <canvas id="indicatorChart"></canvas>
            }
            else
            {
                <div class="alert alert-info text-center mb-0">
                    No indicators found for this grade/checkpoint.
                </div>
            }
        </div>
    </div>

    <!-- Right: Quadrant Pie Chart -->
    <div class="col-md-6 mb-4 d-flex">
        <div class="card shadow-sm p-3 w-100 d-flex flex-column justify-content-end">
            <h6 class="text-center mb-3">Quadrant Distribution – Grade @Model.Grade</h6>
            <canvas id="quadrantPie"></canvas>
        </div>
    </div>
</div>

<!-- Updated Student Table with Drag-to-Group -->
<div class="card shadow-sm border-0">
    <div class="card-body p-2">
        <div class="d-flex justify-content-between align-items-center mb-3 px-2">
            <h5 class="card-title mb-0">Student List – Grade @Model.Grade</h5>
            <div class="d-flex align-items-center">
                <small class="text-muted me-3">Drag column headers below to group students</small>
                <button class="clear-grouping" onclick="clearGrouping()" style="display: none;">Clear Grouping</button>
            </div>
        </div>

        <!-- Drag and Drop Grouping Area -->
        <div class="grouping-area" id="groupingArea" 
     data-placeholder="Drag column headers here to group students by that field">
   </div>

        <!-- MODIFIED: Dual-container approach for sticky + horizontal scroll -->
        <div class="table-container-wrapper">
            <div class="table-scroll-container">
                <table class="table table-sm table-hover table-striped mb-0" id="studentsTable">
                <thead class="table-light">
                    <tr>
                        <th class="py-2 draggable-header" data-column="name">Name</th>
                        <th class="py-2 draggable-header" data-column="id">ID</th>
                        <th class="py-2 draggable-header" data-column="grade">Gr</th>
                        <th class="py-2 draggable-header" data-column="counselor">Counselor</th>
                        <th class="py-2 draggable-header" data-column="race">Race/Ethnicity</th>
                        <th class="py-2 text-center draggable-header" data-column="swd">SWD</th>
                        <th class="py-2 text-center draggable-header" data-column="sed">SED</th>
                        <th class="py-2 text-center draggable-header" data-column="lf">LF</th>
                        <th class="py-2 text-center draggable-header" data-column="years">Yrs</th>
                        <th class="py-2 text-center draggable-header" data-column="currentgpa">Curr GPA</th>
                        <th class="py-2 text-center draggable-header" data-column="cumgpa">Cum GPA</th>
                        <th class="py-2 text-center draggable-header" data-column="credits">Credits</th>
                        
                        <!-- Dynamic Indicator Columns -->
                        @if (Model.IndicatorSummaries != null)
                        {
                            @foreach (var indicator in Model.IndicatorSummaries)
                            {
                                <th class="py-2 text-center draggable-header" data-column="@indicator.Name.ToLower()">@GetIndicatorDisplayName(indicator.Name)</th>
                            }
                        }
                        
                        <th class="py-2 text-center draggable-header" data-column="quadrant">Quadrant</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var s in Model.Students)
                    {
                        <tr style="font-size: 0.8rem;" 
                            data-name="@s.LastName, @s.FirstName"
                            data-id="@s.LocalStudentId"
                            data-grade="@s.Grade"
                            data-counselor="@(s.CounselorName ?? "")"
                            data-race="@(s.RaceEthnicity ?? "")"
                            data-swd="@(s.SWD == true ? "Yes" : "No")"
                            data-sed="@(s.SED == true ? "Yes" : "No")"
                            data-lf="@(s.LF ?? "")"
                            data-years="@(s.YrsInProgram?.ToString("0.0") ?? "")"
                            data-currentgpa="@(s.CurrentGPA?.ToString("0.00") ?? "")"
                            data-cumgpa="@(s.CumulativeGPA?.ToString("0.00") ?? "")"
                            data-credits="@(s.CreditsCompleted?.ToString("0.#") ?? "")"
                            @if (Model.IndicatorSummaries != null)
                            {
                                @foreach (var indicator in Model.IndicatorSummaries)
                                {
                                    var value = GetIndicatorValue(s, indicator.Name);
                                    @Html.Raw($"data-{indicator.Name.ToLower()}=\"{(value == true ? "Met" : value == false ? "Not Met" : "N/A")}\"")
                                }
                            }
                            data-quadrant="@(s.Quadrant ?? "")">
                            <td class="py-1">
                                <a href="#" class="fw-semibold text-decoration-none view-profile" data-bs-toggle="modal"
                                   data-bs-target="#profileModal" data-student-id="@s.ResultId">
                                    @s.LastName, @s.FirstName
                                </a>
                            </td>
                            <td class="py-1"><span class="badge bg-secondary" style="font-size: 0.7rem;">@s.LocalStudentId</span></td>
                            <td class="py-1">@s.Grade</td>
                            <td class="py-1">@((!string.IsNullOrEmpty(s.CounselorName) && s.CounselorName.Length > 15) ? s.CounselorName.Substring(0, 15) + "..." : s.CounselorName ?? "-")</td>
                            <td class="py-1">@((!string.IsNullOrEmpty(s.RaceEthnicity) && s.RaceEthnicity.Length > 20) ? s.RaceEthnicity.Substring(0, 20) + "..." : s.RaceEthnicity ?? "-")</td>
                            <td class="py-1 text-center">
                                <span class="badge @(s.SWD == true ? "bg-warning" : "bg-light text-muted")" style="font-size: 0.7rem;">
                                    @(s.SWD == true ? "Y" : "N")
                                </span>
                            </td>
                            <td class="py-1 text-center">
                                <span class="badge @(s.SED == true ? "bg-info" : "bg-light text-muted")" style="font-size: 0.7rem;">
                                    @(s.SED == true ? "Y" : "N")
                                </span>
                            </td>
                            <td class="py-1 text-center">@(s.LF ?? "-")</td>
                            <td class="py-1 text-center">@(s.YrsInProgram?.ToString("0.0") ?? "-")</td>
                            <td class="py-1 text-center">@(s.CurrentGPA?.ToString("0.00") ?? "-")</td>
                            <td class="py-1 text-center">@(s.CumulativeGPA?.ToString("0.00") ?? "-")</td>
                            <td class="py-1 text-center">@(s.CreditsCompleted?.ToString("0.#") ?? "-")</td>
                            
                            <!-- Dynamic Indicator Values -->
                            @if (Model.IndicatorSummaries != null)
                            {
                                @foreach (var indicator in Model.IndicatorSummaries)
                                {
                                    var value = GetIndicatorValue(s, indicator.Name);
                                    <td class="py-1 text-center">
                                        <span class="badge @(value == true ? "bg-success" : value == false ? "bg-danger" : "bg-secondary")" style="font-size: 0.65rem; padding: 2px 6px;">
                                            @(value == true ? "✓" : value == false ? "✗" : "-")
                                        </span>
                                    </td>
                                }
                            }
                            
                            <td class="py-1 text-center">
                                <span class="badge 
                                    @(s.Quadrant == "Challenge" ? "bg-primary" :
                                    s.Quadrant == "Benchmark" ? "bg-success" :
                                    s.Quadrant == "Strategic" ? "bg-warning text-dark" :
                                    s.Quadrant == "Intensive" ? "bg-danger" :
                                    "bg-secondary")" style="font-size: 0.7rem; padding: 2px 6px;">
                                    @(s.Quadrant ?? "-")
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileModalLabel">Student Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="profileContent">Loading...</div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Override site-wide CSS to fix sticky positioning context */
    html {
        position: static;
    }

    #indicatorChart {
        max-height: 300px;
    }
    
    #studentsTable {
        font-size: 0.85rem;
    }

    /* Simple horizontal scroll container */
    .table-container-wrapper {
        position: relative;
    }

    .table-scroll-container {
        overflow-x: auto;
        overflow-y: visible;
        max-width: 100%;
        /* Custom scrollbar */
        scrollbar-width: thin;
        scrollbar-color: #007bff #f8f9fa;
    }

    .table-scroll-container::-webkit-scrollbar {
        height: 8px;
    }

    .table-scroll-container::-webkit-scrollbar-track {
        background: #f8f9fa;
        border-radius: 4px;
    }

    .table-scroll-container::-webkit-scrollbar-thumb {
        background: #007bff;
        border-radius: 4px;
    }

    .table-scroll-container::-webkit-scrollbar-thumb:hover {
        background: #0056b3;
    }

    /* Headers will be positioned by JavaScript */
    #studentsTable > thead > tr > th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        white-space: nowrap;
        z-index: 10;
    }

    /* Enhanced table styling */
    #studentsTable {
        min-width: max-content;
        margin-bottom: 0;
    }

    #studentsTable td,
    #studentsTable th {
        white-space: nowrap;
        padding: 8px;
    }

    /* Sticky header when active */
    #studentsTable > thead.sticky-active {
        position: fixed;
        top: 70px;
        z-index: 1000;
        background-color: #f8f9fa;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* Keep all your existing drag/drop styles unchanged */
    .grouping-area {
        background: #f8f9fa;
        border: 2px dashed #dee2e6;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
        min-height: 60px;
        transition: all 0.3s ease;
    }
    
    .grouping-area.drag-over {
        background: #e3f2fd;
        border-color: #2196f3;
    }
    
    .grouping-area .placeholder {
        color: #6c757d;
        font-style: italic;
        text-align: center;
        line-height: 30px;
    }
    
    .group-tag {
        display: inline-block;
        background: #007bff;
        color: white;
        padding: 5px 12px;
        margin: 2px;
        border-radius: 20px;
        font-size: 0.85rem;
        cursor: pointer;
        position: relative;
    }
    
    .group-tag .remove {
        margin-left: 8px;
        cursor: pointer;
        font-weight: bold;
    }
    
    .group-tag:hover {
        background: #0056b3;
    }
    
    .draggable-header {
        cursor: move;
        user-select: none;
        position: relative;
    }
    
    .draggable-header:hover {
        background: #e3f2fd;
    }
    
    .draggable-header.dragging {
        opacity: 0.5;
    }
    
    .grouped-table {
        margin-top: 20px;
    }
    
    .group-header {
        background: #f1f3f4;
        font-weight: bold;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
    }
    
    .group-content {
        border-left: 3px solid #007bff;
    }
    
    .clear-grouping {
        background: #dc3545;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        margin-left: 10px;
    }
    
    .clear-grouping:hover {
        background: #c82333;
    }
    
    .group-select-all {
        margin-right: 8px;
    }
    
    .group-header-text {
        vertical-align: middle;
    }
    
    .clickable-group-header {
        cursor: pointer;
        user-select: none;
        padding: 4px 8px;
        border-radius: 4px;
        transition: background-color 0.2s ease-in-out;
    }

    .clickable-group-header:hover {
        background-color: #e9ecef;
    }
</style>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/2.0.8/css/dataTables.bootstrap5.css">
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.js"></script>
    <script src="https://cdn.datatables.net/2.0.8/js/dataTables.bootstrap5.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/3.0.2/css/buttons.bootstrap5.css">
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/dataTables.buttons.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.bootstrap5.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.2.7/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/3.0.2/js/buttons.print.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.datatables.net/select/2.0.3/css/select.bootstrap5.css">
    <script src="https://cdn.datatables.net/select/2.0.3/js/dataTables.select.js"></script>
    
    <link rel="stylesheet" href="https://cdn.datatables.net/rowgroup/1.5.0/css/rowGroup.bootstrap5.css">
    <script src="https://cdn.datatables.net/rowgroup/1.5.0/js/dataTables.rowGroup.js"></script>
    
    <!-- Removed FixedHeader plugin -->

    <link type="text/css" href="https://cdn.datatables.net/1.11.0/css/dataTables.checkboxes.css" rel="stylesheet" />
    <script type="text/javascript" src="https://cdn.datatables.net/1.11.0/js/dataTables.checkboxes.min.js"></script>

    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

   <script src="~/js/students-grouping.js"></script>
    <script>
        // Initialize page with data from server
        window.studentPageData = {
            indicatorData: @Html.Raw(JsonSerializer.Serialize(Model.IndicatorSummaries)),
            quadrantCounts: @Html.Raw(JsonSerializer.Serialize(Model.QuadrantCounts)),
            aboveCount: @Model.AboveTheLineCount,
            belowCount: @Model.BelowTheLineCount,
            total: @Model.TotalCount
        };
        
        // Enhanced sticky header functionality with column width preservation
        function initStickyHeaders() {
            const table = document.getElementById('studentsTable');
            const thead = table.querySelector('thead');
            const scrollContainer = document.querySelector('.table-scroll-container');
            
            let isSticky = false;
            let originalColumnWidths = [];
            
            function captureColumnWidths() {
                // Capture the actual rendered widths of each column
                const headerCells = thead.querySelectorAll('th');
                originalColumnWidths = Array.from(headerCells).map(th => {
                    return th.getBoundingClientRect().width;
                });
            }
            
            function applyColumnWidths() {
                const headerCells = thead.querySelectorAll('th');
                headerCells.forEach((th, index) => {
                    if (originalColumnWidths[index]) {
                        th.style.width = originalColumnWidths[index] + 'px';
                        th.style.minWidth = originalColumnWidths[index] + 'px';
                        th.style.maxWidth = originalColumnWidths[index] + 'px';
                    }
                });
            }
            
            function removeColumnWidths() {
                const headerCells = thead.querySelectorAll('th');
                headerCells.forEach(th => {
                    th.style.width = '';
                    th.style.minWidth = '';
                    th.style.maxWidth = '';
                });
            }
            
            function updateStickyHeader() {
                const tableRect = table.getBoundingClientRect();
                const shouldBeSticky = tableRect.top <= 95;
                
                if (shouldBeSticky && !isSticky) {
                    // Capture widths before making sticky
                    captureColumnWidths();
                    
                    // Make sticky
                    thead.classList.add('sticky-active');
                    thead.style.width = table.offsetWidth + 'px';
                    thead.style.left = tableRect.left + 'px';
                    
                    // Apply the captured widths
                    applyColumnWidths();
                    
                    isSticky = true;
                } else if (!shouldBeSticky && isSticky) {
                    // Remove sticky
                    thead.classList.remove('sticky-active');
                    thead.style.width = '';
                    thead.style.left = '';
                    
                    // Remove fixed widths
                    removeColumnWidths();
                    
                    isSticky = false;
                } else if (isSticky) {
                    // Update position when sticky (but keep widths)
                    const newTableRect = table.getBoundingClientRect();
                    thead.style.left = newTableRect.left + 'px';
                }
            }
            
            // Update on scroll
            window.addEventListener('scroll', updateStickyHeader);
            
            // Update on horizontal scroll to maintain alignment
            scrollContainer.addEventListener('scroll', function() {
                if (isSticky) {
                    const tableRect = table.getBoundingClientRect();
                    thead.style.left = tableRect.left + 'px';
                }
            });
            
            // Update on resize - recalculate everything
            window.addEventListener('resize', function() {
                if (isSticky) {
                    // Temporarily remove sticky to get natural widths
                    thead.classList.remove('sticky-active');
                    removeColumnWidths();
                    
                    // Recalculate
                    setTimeout(function() {
                        updateStickyHeader();
                    }, 10);
                } else {
                    updateStickyHeader();
                }
            });
            
            // Initial check
            updateStickyHeader();
        }
        
        // Initialize when DOM is ready
        $(document).ready(function() {
            StudentGrouping.init();
            StudentCharts.init();
            
            // Initialize sticky headers after DataTable is loaded and rendered
            setTimeout(function() {
                initStickyHeaders();
            }, 200); // Increased timeout to ensure DataTable is fully rendered
        });
    </script>
}
