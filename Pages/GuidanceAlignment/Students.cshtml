@page "{schoolId:int}/{grade:int}"
@model ORSV2.Pages.GuidanceAlignment.StudentsModel
@{
    ViewData["Title"] = $"Students - Grade {Model.Grade}";
}

<partial name="_Breadcrumbs" model="Model.Breadcrumbs" />

<div class="container-fluid px-4 py-3">
<!-- Summary Cards Row -->
<div class="row mb-3">
    <!-- Left: Indicator Performance Overview -->
    <div class="col-md-6 mb-3 d-flex">
        <div class="card shadow-sm p-3 w-100 d-flex flex-column justify-content-center">
            <h6 class="text-center mb-3">Indicator Performance – Grade @Model.Grade</h6>
            <div class="row g-2">
                @foreach (var indicator in Model.IndicatorSummaries)
                {
                    <div class="col-6 col-lg-4">
                        <div class="text-center p-2 border rounded">
                            <div class="fw-semibold small">@GetIndicatorDisplayName(indicator.Name)</div>
                            <div class="h5 mb-1 @(indicator.PercentMet >= 80 ? "text-success" : indicator.PercentMet >= 60 ? "text-warning" : "text-danger")">
                                @indicator.PercentMet.ToString("0")%
                            </div>
                            <div class="small text-muted">@indicator.CountMet met</div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Right: Quadrant Pie Chart -->
    <div class="col-md-6 mb-3 d-flex">
        <div class="card shadow-sm p-3 w-100 d-flex flex-column justify-content-end">
            <h6 class="text-center mb-3">Quadrant Distribution – Grade @Model.Grade</h6>
            <canvas id="quadrantPie"></canvas>
        </div>
    </div>
</div>

<!-- Student Table -->
<div class="card shadow-sm mb-4 border-0">
    <div class="card-body">
        <h5 class="card-title mb-4">Student List – Grade @Model.Grade</h5>

        <div class="table-responsive">
            <table class="table table-hover align-middle" id="schoolsTable">
                <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Local ID</th>
                        <th>Grade</th>
                        <th>Counselor</th>
                        <th>Race / Ethnicity</th>
                        <th>SWD</th>
                        <th>SED</th>
                        <th>LF</th>
                        <th>Years in Program</th>
                        <th>Current GPA</th>
                        <th>Cumulative GPA</th>
                        <th>Credits</th>
                        
                        <!-- Dynamic Indicator Columns -->
                        @foreach (var indicator in Model.IndicatorSummaries)
                        {
                            <th class="text-center">@GetIndicatorDisplayName(indicator.Name)</th>
                        }
                        
                        <th>Quadrant</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var s in Model.Students)
                    {
                        <tr>
                            <td>
                                <a href="#" class="fw-semibold text-decoration-none view-profile" data-bs-toggle="modal"
                                   data-bs-target="#profileModal" data-student-id="@s.ResultId">
                                    @s.LastName, @s.FirstName
                                </a>
                            </td>
                            <td><span class="badge bg-secondary">@s.LocalStudentId</span></td>
                            <td>@s.Grade</td>
                            <td>@s.CounselorName</td>
                            <td>@s.RaceEthnicity</td>
                            <td>
                                <span class="badge bg-@(s.SWD == true ? "warning" : "light text-muted")">
                                    @(s.SWD == true ? "Yes" : "No")
                                </span>
                            </td>
                            <td>
                                <span class="badge bg-@(s.SED == true ? "info" : "light text-muted")">
                                    @(s.SED == true ? "Yes" : "No")
                                </span>
                            </td>
                            <td>@s.LF</td>
                            <td>@s.YrsInProgram</td>
                            <td>@(s.CurrentGPA?.ToString("0.00") ?? "-")</td>
                            <td>@(s.CumulativeGPA?.ToString("0.00") ?? "-")</td>
                            <td>@(s.CreditsCompleted?.ToString("0.#") ?? "-")</td>
                            
                            <!-- Dynamic Indicator Values -->
                            @foreach (var indicator in Model.IndicatorSummaries)
                            {
                                var value = GetIndicatorValue(s, indicator.Name);
                                <td class="text-center">
                                    <span class="badge bg-@(value == true ? "success" : value == false ? "danger" : "secondary")">
                                        @(value == true ? "Met" : value == false ? "Not Met" : "N/A")
                                    </span>
                                </td>
                            }
                            
                            <td>
                                <span class="badge 
                                    @(s.Quadrant == "Q1" ? "bg-success" :
                                    s.Quadrant == "Q2" ? "bg-warning text-dark" :
                                    s.Quadrant == "Q3" ? "bg-danger" :
                                    s.Quadrant == "Q4" ? "bg-info" : "bg-secondary")">
                                    @(s.Quadrant ?? "N/A")
                                </span>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>
</div>

<!-- Student Profile Modal -->
<div class="modal fade" id="profileModal" tabindex="-1" aria-labelledby="profileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="profileModalLabel">Student Profile</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="profileContent">
                <!-- Content loaded via AJAX -->
            </div>
        </div>
    </div>
</div>

@functions {
    bool? GetIndicatorValue(ORSV2.Models.GAResults student, string indicatorName)
    {
        return indicatorName switch
        {
            "OnTrack" => student.OnTrack,
            "GPA" => student.GPA,
            "AGGrades" => student.AGGrades,
            "AGSchedule" => student.AGSchedule,
            "Affiliation" => student.Affiliation,
            "FAFSA" => student.FAFSA,
            "CollegeApplication" => student.CollegeApplication,
            "Attendance" => student.Attendance,
            "Referrals" => student.Referrals,
            "Grades" => student.Grades,
            "ELA" => student.AssessmentsELA,
            "Math" => student.AssessmentsMath,
            _ => null
        };
    }

    string GetIndicatorDisplayName(string indicatorName)
    {
        return indicatorName switch
        {
            "OnTrack" => "On Track",
            "AGGrades" => "A-G Grades",
            "AGSchedule" => "A-G Schedule",
            "CollegeApplication" => "College App",
            "AssessmentsELA" => "ELA",
            "AssessmentsMath" => "Math",
            _ => indicatorName
        };
    }
}

<style>
    #indicatorChart {
        max-height: 300px;
    }
</style>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            var modal = document.getElementById('profileModal');
            modal.addEventListener('show.bs.modal', function (event) {
                var button = event.relatedTarget;
                var studentId = button.getAttribute('data-student-id');
                fetch(`/GuidanceAlignment/GAProfileCard?id=${studentId}`)
                    .then(response => response.text())
                    .then(html => {
                        document.getElementById("profileContent").innerHTML = html;

                        // ✅ Extract and execute the script manually
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = html;
                        const scriptTag = tempDiv.querySelector('script');
                        if (scriptTag) {
                            eval(scriptTag.textContent);
                        }
                    });

            });

            // DataTable initialization
            $('#studentsTable').DataTable({
                responsive: true,
                pageLength: 50,
                lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "All"]],
                order: [[0, 'asc']],
                dom: 'Blfrtip',
                buttons: [
                    {
                        extend: 'excelHtml5',
                        text: '<i class="fas fa-file-excel"></i> Excel',
                        className: 'btn btn-success btn-sm'
                    },
                    {
                        extend: 'csvHtml5', 
                        text: '<i class="fas fa-file-csv"></i> CSV',
                        className: 'btn btn-info btn-sm'
                    },
                    {
                        extend: 'print',
                        text: '<i class="fas fa-print"></i> Print', 
                        className: 'btn btn-secondary btn-sm'
                    }
                ],
                columnDefs: [
                    { width: "150px", targets: 0 }, // Name
                    { width: "80px", targets: 1 },  // ID
                    { width: "40px", targets: 2 },  // Grade
                    { width: "100px", targets: 3 }, // Counselor
                    { width: "120px", targets: 4 }, // Race/Ethnicity
                    { width: "40px", targets: [5,6,7] }, // SWD, SED, LF
                    { width: "50px", targets: [8,9,10,11] }, // Numeric columns
                    { className: "text-center", targets: [1,2,5,6,7,8,9,10,11] }
                ],
                language: {
                    search: "Search students:",
                    lengthMenu: "Show _MENU_ students",
                    info: "Showing _START_ to _END_ of _TOTAL_ students"
                }
            });
        });
    </script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const indicatorData = @Html.Raw(JsonSerializer.Serialize(Model.IndicatorSummaries));
        const indicatorLabels = indicatorData.map(i => i.Name);
        const indicatorPercents = indicatorData.map(i => i.PercentMet.toFixed(1));

        if (indicatorData.length > 0) {
            if (window.indicatorChartInstance) {
                window.indicatorChartInstance.destroy();
            }

            window.indicatorChartInstance = new Chart(document.getElementById('indicatorChart'), {
                type: 'bar',
                data: {
                    labels: indicatorLabels,
                    datasets: [{
                        label: '% Met',
                        data: indicatorPercents,
                        backgroundColor: '#0d6efd'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: '% Met' }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    });
</script>


<script>
    const quadrantCounts = @Html.Raw(JsonSerializer.Serialize(Model.QuadrantCounts));
    const aboveCount = @Model.AboveTheLineCount;
    const belowCount = @Model.BelowTheLineCount;
    const total = @Model.TotalCount;

    const quadrantPie = new Chart(document.getElementById('quadrantPie'), {
        type: 'pie',
        data: {
            labels: [
                `Challenge (${quadrantCounts["Challenge"] || 0})`,
                `Benchmark (${quadrantCounts["Benchmark"] || 0})`,
                `Strategic (${quadrantCounts["Strategic"] || 0})`,
                `Intensive (${quadrantCounts["Intensive"] || 0})`
            ],
            datasets: [{
                data: [
                    quadrantCounts["Challenge"] || 0,
                    quadrantCounts["Benchmark"] || 0,
                    quadrantCounts["Strategic"] || 0,
                    quadrantCounts["Intensive"] || 0
                ],
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545'],
                borderColor: '#fff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    align: 'center'  // this is default, but makes intent clear
                },
                title: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const percent = ((value / total) * 100).toFixed(1);
                            return `${context.label}: ${value} (${percent}%)`;
                        }
                    }
                }
            }
        }
    });
</script>

}