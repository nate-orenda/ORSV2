@page
@model ORSV2.Pages.GuidanceAlignment.ProtocolSections.CommonAgreementsModel
@{
    ViewData["Title"] = "Common Agreements";
    Layout = "~/Pages/Shared/_ProtocolLayout.cshtml";
}

<style>
    .collapse-content {
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .question-section {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-left: 4px solid var(--bs-primary);
        margin-bottom: 1.5rem;
    }
    
    .question-label {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 0.75rem;
    }
    
    .form-control {
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: var(--bs-primary);
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .accordion-button {
        font-weight: 600;
        padding: 1.25rem;
    }
    
    .accordion-button:not(.collapsed) {
        background: linear-gradient(135deg, var(--bs-primary) 0%, #0056b3 100%);
        color: white;
        border-color: var(--bs-primary);
    }
    
    .accordion-button:focus {
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }
</style>

<!-- Main Content -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="mb-0">
        <i class="bi bi-handshake me-2 text-primary"></i>Common Agreements
    </h4>
    @if (!string.IsNullOrEmpty(Model.LastUpdated))
    {
        <small class="text-muted">
            <i class="bi bi-clock me-1"></i>Last updated @Model.LastUpdated by @Model.LastUpdatedBy
        </small>
    }
</div>

<div class="alert alert-info mb-4">
    <i class="bi bi-info-circle me-2"></i>
    <strong>Instructions:</strong> From your reflection on the data, select a focus for the upcoming Checkpoint. 
    Click on one or more focus areas below to complete the planning questions and establish common agreements 
    for your team.
</div>

<!-- Focus Areas Accordion -->
<form method="post" asp-page-handler="SaveAll" asp-route-protocolId="@Model.ProtocolId">
    <div class="accordion" id="focusAreasAccordion">
        @{
            int accordionIndex = 0;
        }
        @foreach (var focusArea in CommonAgreementsModel.FocusAreas)
        {
            var areaId = focusArea.Key.ToLower();
            accordionIndex++;
            
            <div class="accordion-item mb-3" id="@areaId">
                <h2 class="accordion-header" id="heading@(focusArea.Key)">
                    <button class="accordion-button collapsed" 
                            type="button" 
                            data-bs-toggle="collapse" 
                            data-bs-target="#collapse@(focusArea.Key)" 
                            aria-expanded="false" 
                            aria-controls="collapse@(focusArea.Key)">
                        <i class="@focusArea.Value.Icon me-3" style="font-size: 1.2rem;"></i>
                        <div>
                            <div class="fw-bold">@focusArea.Value.Title</div>
                            <small class="opacity-75">
                                @if (focusArea.Key == "Indicators")
                                {
                                    <span>Focus on specific performance indicators for improvement</span>
                                }
                                else if (focusArea.Key == "Quadrants")
                                {
                                    <span>Target specific performance quadrants (Challenge, Benchmark, Strategic, Intensive)</span>
                                }
                                else if (focusArea.Key == "StudentGroups")
                                {
                                    <span>Focus on specific student demographic groups</span>
                                }
                            </small>
                        </div>
                    </button>
                </h2>
                <div id="collapse@(focusArea.Key)" 
                     class="accordion-collapse collapse" 
                     aria-labelledby="heading@(focusArea.Key)" 
                     data-bs-parent="#focusAreasAccordion">
                    <div class="accordion-body">
                        @foreach (var question in focusArea.Value.Questions)
                        {
                            var responseKey = $"{focusArea.Key}_{question.Key}";
                            var currentValue = Model.CommonAgreementResponses.GetValueOrDefault(responseKey, string.Empty);
                            
                            <div class="question-section p-4 rounded mb-4">
                                <label class="question-label">
                                    @question.Value
                                </label>
                                <textarea 
                                    name="CommonAgreementResponses[@responseKey]" 
                                    class="form-control" 
                                    rows="4" 
                                    placeholder="@GetPlaceholderText(question.Key)">@currentValue</textarea>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- Save Button -->
    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
        <button type="submit" class="btn btn-primary btn-lg">
            <i class="bi bi-check-circle me-2"></i>Save Common Agreements
        </button>
    </div>
</form>

<hr class="my-4" />

<h4 class="mb-3">Action Plan</h4>
<p>If appropriate, divide up the work tasks so each member contributes to the common agreements.</p>

<div class="card shadow-sm mb-4">
    <div class="card-header">
        <h5 class="mb-0">Add New Task</h5>
    </div>
    <div class="card-body">
        <form method="post" asp-page-handler="AddActionPlanItem" asp-route-protocolId="@Model.ProtocolId" id="addActionPlanItemForm">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <div class="row g-3">
                <div class="col-md-4">
                    <label for="user-search-input" class="form-label fw-bold">Search Team Member</label>
                    <input type="text" id="user-search-input" class="form-control mb-2" placeholder="Type to search by name or email...">
                    
                    <label asp-for="NewActionPlanItem.TeamMemberId" class="form-label visually-hidden">Team Member</label>
                    <select asp-for="NewActionPlanItem.TeamMemberId" class="form-select" asp-items="Model.SchoolUsers" size="5">
                        <option value="" disabled>-- Select a user --</option>
                    </select>
                    <span asp-validation-for="NewActionPlanItem.TeamMemberId" class="text-danger"></span>
                </div>
                <div class="col-md-5">
                    <label asp-for="NewActionPlanItem.Task" class="form-label fw-bold">Task to Do</label>
                    <input asp-for="NewActionPlanItem.Task" class="form-control" placeholder="Enter task description" />
                    <span asp-validation-for="NewActionPlanItem.Task" class="text-danger"></span>
                </div>
                <div class="col-md-3">
                    <label asp-for="NewActionPlanItem.DueDate" class="form-label fw-bold">Due Date</label>
                    <input asp-for="NewActionPlanItem.DueDate" type="date" class="form-control" />
                    <span asp-validation-for="NewActionPlanItem.DueDate" class="text-danger"></span>
                </div>
            </div>
            <div class="mt-3 text-end">
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-plus-circle"></i> Add Task
                </button>
            </div>
        </form>
    </div>
</div>

<h5 class="mt-4">Assigned Tasks</h5>
<div class="table-responsive">
    <table class="table table-striped table-hover">
        <thead class="table-light">
            <tr>
                <th style="width: 25%;">Team Member</th>
                <th style="width: 50%;">Task</th>
                <th style="width: 20%;">Due Date</th>
                <th style="width: 5%;"></th>
            </tr>
        </thead>
        <tbody>
            @if (!Model.ActionPlanItems.Any())
            {
                <tr>
                    <td colspan="4" class="text-center">No action plan items have been added yet.</td>
                </tr>
            }
            @foreach (var item in Model.ActionPlanItems)
            {
                <tr>
                    <td>
                        @if (item.TeamMember != null)
                        {
                            <span>@($"{item.TeamMember.FirstName} {item.TeamMember.LastName}".Trim())</span>
                            <br>
                            <small class="text-muted">@item.TeamMember.Email</small>
                        }
                        else
                        {
                            <span>N/A</span>
                        }
                    </td>
                    <td>@item.Task</td>
                    <td>@item.DueDate.ToString("MM/dd/yyyy")</td>
                    <td>
                        @* Future placeholder for edit/delete buttons *@
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const searchInput = document.getElementById('user-search-input');
            const userSelect = document.querySelector('select[asp-for="NewActionPlanItem.TeamMemberId"]');
            
            if (searchInput && userSelect) {
                const options = Array.from(userSelect.options);

                searchInput.addEventListener('keyup', function () {
                    const searchText = this.value.toLowerCase();
                    
                    // Clear current options
                    userSelect.innerHTML = ''; 

                    // Filter and re-add options
                    options.forEach(option => {
                        if (option.text.toLowerCase().includes(searchText)) {
                            userSelect.add(option);
                        }
                    });
                });
            }
        });
    </script>
}

@functions {
    private string GetPlaceholderText(string questionKey)
    {
        return questionKey switch
        {
            "FocusIndicators" => "Identify specific indicators (e.g., ELA proficiency, Math growth, Attendance) and explain why these are priorities...",
            "IndicatorStrategies" => "Detail specific strategies, interventions, and common agreements for improving the selected indicators...",
            "FocusQuadrants" => "Specify which quadrants (Challenge, Benchmark, Strategic, Intensive) need focus and provide rationale...",
            "QuadrantStrategies" => "Outline targeted strategies and agreements for moving students between quadrants...",
            "FocusStudentGroups" => "Identify specific student groups (e.g., English Learners, Students with Disabilities, specific demographic groups) and justify the focus...",
            "StudentGroupStrategies" => "Describe targeted interventions and agreements for supporting the identified student groups...",
            _ => "Enter your response here..."
        };
    }
}