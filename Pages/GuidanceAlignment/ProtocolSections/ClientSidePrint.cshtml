@page
@model ORSV2.Pages.GuidanceAlignment.ProtocolSections.ClientSidePrintModel
@{
    ViewData["Title"] = "Print Protocol";
    // Use the shared layout you pasted; do NOT set Layout = null;
}
@section Styles {
<style>
  /* ==== PRINT LAYOUT TUNING ==== */
  @@page {
    size: Letter;
    margin: 0.5in; /* slightly tighter margin */
  }

  @@media print {
    html, body {
      font-size: 10pt;          /* smaller text overall */
      line-height: 1.3;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
    }

    .container, .container-fluid, #sectionsContainer {
      max-width: none !important;
      width: 100% !important;
      padding-left: 0.1in !important;
      padding-right: 0.1in !important;
    }

    /* Headings slightly smaller/compact */
    h1 { font-size: 16pt; margin-bottom: 0.2in; }
    h2 { font-size: 13pt; margin: 0.15in 0 0.1in; }
    h3.section-header { font-size: 12pt; }
    h4, h5, h6 { font-size: 10.5pt; }

    .section-content { margin-bottom: 0.25in; page-break-inside: avoid; }
    .section-header { border-bottom: 1px solid #ccc; padding-bottom: .1rem; margin-bottom: .25rem; color: #000; }

    /* === TABLES === */
    table {
      width: 100% !important;
      border-collapse: collapse !important;
      font-size: 9pt;             /* smaller for dense data */
      table-layout: fixed;        /* helps force-fit */
      word-wrap: break-word;      /* break long values */
    }
    th, td {
      padding: 4px 6px !important;
      border: 1px solid #ccc !important;
      vertical-align: top;
    }
    thead th { font-weight: 600; }

    /* Charts full width */
    #sectionsContainer canvas,
    #sectionsContainer .chart,
    #sectionsContainer .chart-container {
      width: 100% !important;
      max-width: 100% !important;
      height: auto !important;
    }

    /* Hide app chrome in print */
    header.main-header, footer, .print-controls, .navbar,
    .dropdown, .user-profile,
    .alert, .alert-info, .toast, .toast-container,
    .btn, button, .btn-group, .toolbar, [role="toolbar"],
    .form-actions, .card-footer, .pagination, .page-item, .page-link,
    .form-group, .form-check, .input-group, .form-label, label {
      display: none !important;
    }

    /* Strip extra decoration for clean print */
    .card, .shadow, .shadow-sm, .shadow-lg { box-shadow: none !important; }
    .rounded, .rounded-1, .rounded-2, .rounded-3 { border-radius: 0 !important; }
  }

  /* On screen (unchanged) */
  .section-content { margin-bottom: 2rem; page-break-inside: avoid; }
  .section-header { color: #0d6efd; border-bottom: 2px solid #e9ecef; padding-bottom: .4rem; margin-bottom: 1rem; page-break-after: avoid; }
</style>
}



<section class="container my-3">
    <!-- Print Controls -->
    <div class="print-controls d-flex gap-2 align-items-center mb-3">
        <button id="printBtn" class="btn btn-primary" disabled>
            <i class="bi bi-printer"></i> Print Report
        </button>
        <button id="refreshBtn" class="btn btn-secondary">
            <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        <small id="loadStatus" class="text-muted ms-2">Loading sections…</small>
    </div>

    <!-- Protocol Header (shows once) -->
    <header class="mb-4">
        <h1 class="h3">Guidance Alignment Protocol - Checkpoint @Model.Protocol?.CP</h1>
        <div class="row">
            <div class="col-md-6">
                <p class="mb-1"><strong>School:</strong> @Model.School?.Name</p>
                <p class="mb-1"><strong>District:</strong> @Model.School?.District?.Name</p>
            </div>
            <div class="col-md-6">
                <p class="mb-1"><strong>School Year:</strong> @Model.Protocol?.SchoolYear</p>
                <p class="mb-1"><strong>Generated:</strong> <span id="generatedTime"></span></p>
            </div>
        </div>
    </header>

    <!-- Sections Container -->
    <div id="sectionsContainer" class="pb-5">
        <!-- Sections will be injected here -->
    </div>
</section>


@section Scripts {
<script>
  // ------- SECTIONS to load -------
  const sectionsToLoad = [
    { title: "1. Introduction",     url: '@Url.Page("/GuidanceAlignment/ProtocolSections/Introduction",     new { protocolId = Model.Protocol?.Id })' },
    { title: "2. Targets",          url: '@Url.Page("/GuidanceAlignment/ProtocolSections/Targets",          new { protocolId = Model.Protocol?.Id })' },
    { title: "3. Above the Line",   url: '@Url.Page("/GuidanceAlignment/ProtocolSections/Abovetheline",     new { protocolId = Model.Protocol?.Id })' },
    { title: "4. Demographics",     url: '@Url.Page("/GuidanceAlignment/ProtocolSections/Demographics",     new { protocolId = Model.Protocol?.Id })' },
    { title: "5. Indicators",       url: '@Url.Page("/GuidanceAlignment/ProtocolSections/Indicators",       new { protocolId = Model.Protocol?.Id })' },
    { title: "6. Trends",           url: '@Url.Page("/GuidanceAlignment/ProtocolSections/Trends",           new { protocolId = Model.Protocol?.Id })' },
    { title: "7. Common Agreements",url: '@Url.Page("/GuidanceAlignment/ProtocolSections/CommonAgreements", new { protocolId = Model.Protocol?.Id })' },
    { title: "9. Wrap Up",          url: '@Url.Page("/GuidanceAlignment/ProtocolSections/WrapUp",           new { protocolId = Model.Protocol?.Id })' }
  ];

  // Small utils
  function formatDate(d) {
    try { return new Intl.DateTimeFormat(undefined, { dateStyle:"medium", timeStyle:"short" }).format(d); }
    catch { return d.toLocaleString(); }
  }
  function looksLikeLoginPage(html) {
    const lc = html.toLowerCase();
    return lc.includes("/account/login") || lc.includes("returnurl=") || lc.includes('name="input.password"');
  }

  // --- NEW: post-insert chart normalization for Trends ---
  function normalizeCharts(rootEl) {
    if (!rootEl) return;

    // Ensure any collapses/tabs housing charts are open/visible
    rootEl.querySelectorAll('.collapse,[aria-expanded="false"]').forEach(el => {
      el.classList.add('show');
      el.setAttribute('aria-expanded', 'true');
      el.style.removeProperty('height');
      el.style.removeProperty('max-height');
      el.style.removeProperty('overflow');
    });

    // Make canvases fill parent and have a reasonable height if missing
    rootEl.querySelectorAll('canvas').forEach(cv => {
      // If explicit height/width aren’t set, give a sensible height
      if (!cv.getAttribute('height') && !cv.style.height) {
        cv.style.height = '320px';
      }
      cv.style.width = '100%';
      cv.removeAttribute('width'); // let CSS control width
    });

    // Nudge Chart.js / ECharts / D3 to recompute sizes
    try {
      // Chart.js 3+: window.Chart.getChart(canvas)
      rootEl.querySelectorAll('canvas').forEach(cv => {
        const inst = (window.Chart && window.Chart.getChart) ? window.Chart.getChart(cv) : null;
        if (inst && inst.resize) inst.resize();
      });
    } catch {}

    // Global resize for libs that listen to window
    window.dispatchEvent(new Event('resize'));
    // One more tick after layout settles
    setTimeout(() => window.dispatchEvent(new Event('resize')), 50);
  }

  // ------- Cleaner (Targets fixes + Trends sidebar removal/centering) -------
  function extractMainContent(rawHtml, { lenient = false } = {}) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(rawHtml, "text/html");

    const root =
      doc.querySelector("main") ||
      doc.querySelector("#main-content") ||
      doc.querySelector(".content") ||
      doc.body;

    // Intro banner
    root.querySelectorAll(".alert, .alert-info").forEach(a => {
      const t = (a.textContent || "").toLowerCase();
      if (t.includes("welcome to the guidance alignment protocol workspace")) a.remove();
    });

    // Light shell removal
    const toRemove = lenient
      ? ["script","link","style","footer"]
      : [
          "script","link","style","footer",
          "header.main-header",".navbar",".sidebar-container",".sidebar-content",
          ".breadcrumb",".breadcrumbs",".nav.flex-column",".nav-link"
        ];
    toRemove.forEach(sel => root.querySelectorAll(sel).forEach(el => el.remove()));

    // TARGETS: remove add form
    root.querySelectorAll("h3,h4").forEach(h => {
      const t = (h.textContent || "").trim().toLowerCase();
      if (t.startsWith("add new target")) h.remove();
    });
    root.querySelectorAll("form").forEach(f => {
      const action = (f.getAttribute("action") || "").toLowerCase();
      if (action.includes("handler=addtarget")) f.remove();
    });

    // Unwrap remaining forms
    root.querySelectorAll("form").forEach(form => {
      const p = form.parentNode; if (!p) return;
      while (form.firstChild) p.insertBefore(form.firstChild, form);
      form.remove();
    });

    // Remove anti-forgery hidden input
    root.querySelectorAll('input[type="hidden"][name="__RequestVerificationToken"]').forEach(el => el.remove());

    // Convert inputs -> text
    root.querySelectorAll("input, select, textarea").forEach(el => {
      if (el.tagName === "INPUT" && (el.type === "hidden" || el.type === "submit" || el.type === "button")) return;
      let val = "";
      if (el.tagName === "SELECT") {
        const opt = el.selectedOptions && el.selectedOptions[0];
        val = opt ? (opt.textContent || opt.innerText || opt.value || "") : (el.value || "");
      } else if (el.type === "checkbox" || el.type === "radio") {
        val = el.checked ? "Yes" : "No";
      } else {
        val = el.value ?? el.textContent ?? "";
      }
      const span = doc.createElement("span");
      span.textContent = (val || "").trim();
      el.replaceWith(span);
    });

    // Strip leftover placeholders (Targets)
    const killTexts = new Set(["grade","target %","-- select --","grade -- select --"]);
    root.querySelectorAll("label, span, p, small").forEach(el => {
      const txt = (el.textContent || "").trim().toLowerCase();
      if ((killTexts.has(txt) && el.tagName !== "TH") || !txt) el.remove();
    });

    // Remove action controls
    [
      "button",".btn","a.btn",".btn-group",
      "[role='toolbar']",".form-actions",".card-footer",
      "input[type='submit']","input[type='button']",
      ".pagination",".page-item",".page-link",".toast",".toast-container"
    ].forEach(sel => root.querySelectorAll(sel).forEach(el => el.remove()));

    // TRENDS: remove left nav column & expand main col
    const trendsHeadings = ["navigate trends","trends analysis","predictive grades analysis"];
    root.querySelectorAll(".row").forEach(row => {
      const cols = Array.from(row.children).filter(c => /\bcol(-sm|-md|-lg)?-\d+\b/.test(c.className));
      const sidebar = cols.find(c => {
        const t = (c.textContent || "").toLowerCase();
        return trendsHeadings.some(h => t.includes(h));
      });
      if (sidebar) {
        sidebar.remove();
        const remaining = Array.from(row.children).filter(c => /\bcol(-sm|-md|-lg)?-\d+\b/.test(c.className));
        if (remaining.length === 1) {
          remaining[0].className = remaining[0].className
            .replace(/\bcol(-sm|-md|-lg)?-\d+\b/g, "")
            .trim() + " col-12 text-start";
        }
      }
    });

    // remove duplicated per-section header
    root.querySelectorAll("h2").forEach(h2 => {
      const t = (h2.textContent || "").toLowerCase();
      if (t.includes("protocol") && t.includes("checkpoint")) h2.remove();
    });

    // remove duplicate School/District/Year lines
    root.querySelectorAll("p").forEach(p => {
      const t = (p.textContent || "").toLowerCase();
      if (t.includes("school:") && t.includes("district:") && t.includes("year:")) p.remove();
    });

    // Tidy
    root.querySelectorAll("div, section, article").forEach(el => {
      const text = (el.textContent || "").trim();
      if (!text && el.children.length === 0) el.remove();
    });

    return root.innerHTML || "";
  }

  // ------- Loader -------
  async function loadSections() {
    const statusEl  = document.getElementById("loadStatus");
    const printBtn  = document.getElementById("printBtn");
    const container = document.getElementById("sectionsContainer");

    printBtn.disabled = true;
    statusEl.textContent = "Loading sections…";
    container.innerHTML = "";

    let i = 0;
    for (const s of sectionsToLoad) {
      i++;
      statusEl.textContent = `Loading ${s.title} (${i}/${sectionsToLoad.length})…`;

      const wrap = document.createElement("section");
      wrap.className = "section-content";
      wrap.innerHTML = `<h3 class="section-header">${s.title}</h3><div class="text-muted">Loading…</div>`;
      container.appendChild(wrap);

      try {
        const resp = await fetch(s.url, { credentials: "same-origin", cache: "no-store" });
        const rawHtml = await resp.text();

        if (!resp.ok || looksLikeLoginPage(rawHtml)) {
          wrap.querySelector(".text-muted")?.remove();
          wrap.insertAdjacentHTML("beforeend",
            `<div class="alert alert-warning">Could not load this section. ${!resp.ok ? `HTTP ${resp.status} ${resp.statusText}` : "Received a login/redirect page."}</div>`);
          continue;
        }

        let cleaned = extractMainContent(rawHtml, { lenient: false });
        if (!cleaned || cleaned.replace(/\s+/g,'').length < 60) {
          cleaned = extractMainContent(rawHtml, { lenient: true });
        }

        wrap.querySelector(".text-muted")?.remove();
        wrap.insertAdjacentHTML("beforeend", cleaned);

        // If this was the Trends section, expand/resize charts now
        if (/^\s*6\.\s*Trends/i.test(s.title)) {
          normalizeCharts(wrap);
        }
      } catch (e) {
        wrap.querySelector(".text-muted")?.remove();
        wrap.insertAdjacentHTML("beforeend", `<div class="alert alert-danger">Error loading: ${e?.message || "Unknown error"}</div>`);
      }
    }

    statusEl.textContent = "All sections loaded.";
    printBtn.disabled = false;
  }

  // ------- Wire up -------
  document.addEventListener("DOMContentLoaded", () => {
    const genEl = document.getElementById("generatedTime");
    if (genEl) genEl.textContent = formatDate(new Date());

    document.getElementById("printBtn").addEventListener("click", () => {
      // one last resize nudge before printing
      window.dispatchEvent(new Event('resize'));
      setTimeout(() => window.print(), 20);
    });
    document.getElementById("refreshBtn").addEventListener("click", loadSections);

    loadSections();
  });
</script>
}

