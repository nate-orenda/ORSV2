@page "{handler?}"
@model ORSV2.Pages.GuidanceAlignment.ProtocolSections.IndicatorsModel
@{
    ViewData["Title"] = "Indicators";
    Layout = "~/Pages/Shared/_ProtocolLayout.cshtml";
}

<h4 class="mb-3">Indicators</h4>

<!-- Demographic Filter -->
<div class="row mb-4">
    <div class="col-md-4">
        <label class="form-label">Filter by Demographics:</label>
        <select id="demographicFilter" class="form-select" onchange="updateIndicatorTables()">
            @foreach (var option in Model.DemographicOptions)
            {
                <option value="@option.Value" selected="@(Model.DemographicFilter == option.Value)">
                    @option.Label
                </option>
            }
        </select>
    </div>
    <div class="col-md-8 d-flex align-items-end">
        <div id="loadingIndicator" class="text-muted" style="display: none;">
            <i class="spinner-border spinner-border-sm me-2"></i>
            Loading indicator data...
        </div>
    </div>
</div>

<!-- Success Message -->
@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Indicator Tables Container -->
<div id="indicatorTablesContainer">
    @await Html.PartialAsync("_IndicatorTables", Model)
</div>

<!-- Response Section -->
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">Analysis and Reflection</h5>
    </div>
    <div class="card-body">
        <form method="post" asp-page-handler="SaveResponse" asp-route-protocolId="@Model.ProtocolId">
            <div class="mb-3">
                <label class="form-label">Indicators Analysis and Reflection</label>
                <textarea asp-for="IndicatorsResponse" class="form-control" rows="8" 
                          placeholder="Enter your indicators analysis and reflection here..."></textarea>
                <div class="form-text">
                    Analyze the indicator performance data above. Consider trends, areas of concern, and successes.
                </div>
            </div>
            
            <input type="hidden" name="DemographicFilter" value="@Model.DemographicFilter" />
            <button type="submit" class="btn btn-primary">Save Response</button>
        </form>

        @if (!string.IsNullOrWhiteSpace(Model.LastUpdated))
        {
            <div class="mt-3 text-muted small">
                <i class="bi bi-clock"></i> Last updated: @Model.LastUpdated by @Model.LastUpdatedBy
            </div>
        }
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        async function updateIndicatorTables() {
            const select = document.getElementById('demographicFilter');
            const selectedValue = select.value;
            const loadingIndicator = document.getElementById('loadingIndicator');
            const tablesContainer = document.getElementById('indicatorTablesContainer');
            
            try {
                // Show loading indicator
                loadingIndicator.style.display = 'block';
                select.disabled = true;
                
                // Fetch updated tables
                const response = await fetch(`?handler=Tables&protocolId=@Model.ProtocolId&demographicFilter=${encodeURIComponent(selectedValue)}`);
                
                if (response.ok) {
                    const html = await response.text();
                    tablesContainer.innerHTML = html;
                } else {
                    console.error('Failed to load indicator tables');
                    tablesContainer.innerHTML = '<div class="alert alert-danger">Failed to load indicator data. Please refresh the page.</div>';
                }
            } catch (error) {
                console.error('Error updating tables:', error);
                tablesContainer.innerHTML = '<div class="alert alert-danger">Error loading data. Please refresh the page.</div>';
            } finally {
                // Hide loading indicator
                loadingIndicator.style.display = 'none';
                select.disabled = false;
            }
        }

        // Auto-save functionality (optional)
        let autoSaveTimeout;
        const responseTextarea = document.querySelector('textarea[name="IndicatorsResponse"]');
        
        if (responseTextarea) {
            responseTextarea.addEventListener('input', function() {
                clearTimeout(autoSaveTimeout);
                autoSaveTimeout = setTimeout(autoSaveResponse, 2000); // Auto-save after 2 seconds of inactivity
            });
        }

        async function autoSaveResponse() {
            const textarea = document.querySelector('textarea[name="IndicatorsResponse"]');
            if (!textarea) return;

            const formData = new FormData();
            formData.append('IndicatorsResponse', textarea.value);
            formData.append('DemographicFilter', document.getElementById('demographicFilter').value);
            formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

            try {
                const response = await fetch('?handler=SaveResponse', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    // Show subtle auto-save indicator
                    showAutoSaveStatus('Auto-saved', 'success');
                } else {
                    showAutoSaveStatus('Auto-save failed', 'error');
                }
            } catch (error) {
                console.error('Auto-save error:', error);
                showAutoSaveStatus('Auto-save error', 'error');
            }
        }

        function showAutoSaveStatus(message, type) {
            // Remove existing status
            const existing = document.getElementById('autoSaveStatus');
            if (existing) existing.remove();

            // Create new status indicator
            const status = document.createElement('small');
            status.id = 'autoSaveStatus';
            status.className = `text-${type === 'success' ? 'success' : 'danger'} ms-2`;
            status.textContent = message;

            // Add after the save button
            const saveButton = document.querySelector('button[type="submit"]');
            if (saveButton) {
                saveButton.parentNode.appendChild(status);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    if (status.parentNode) {
                        status.remove();
                    }
                }, 3000);
            }
        }
    </script>
}