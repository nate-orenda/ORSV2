@page "{handler?}"
@model ORSV2.Pages.GuidanceAlignment.ProtocolSections.WrapUpModel
@{
    ViewData["Title"] = "Wrap Up";
    Layout = "~/Pages/Shared/_ProtocolLayout.cshtml";
}

<div class="section-container">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="text-primary mb-0">Wrap Up</h3>
        @if (!string.IsNullOrEmpty(Model.LastUpdated))
        {
            <small class="text-muted">
                Last updated: @Model.LastUpdated by @Model.LastUpdatedBy
            </small>
        }
    </div>

    <!-- Next Session Information -->
    @if (!string.IsNullOrEmpty(Model.NextScheduledSession))
    {
        <div class="alert alert-info mb-4">
            <i class="bi bi-calendar-event me-2"></i>
            <strong>Upcoming Session:</strong> @Model.NextScheduledSession
        </div>
    }

    <form method="post" class="needs-validation" novalidate>
        @Html.AntiForgeryToken()
        
        <!-- Section Question -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-clipboard-check me-2"></i>
                    Reflection Session Feedback
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="wrapUpResponse" class="form-label fw-bold">
                        What was successful about this reflection session? What could be changed to make next session better?
                    </label>
                    <textarea asp-for="WrapUpResponse" 
                              id="wrapUpResponse"
                              class="form-control" 
                              rows="6" 
                              placeholder="Share your thoughts on what went well in this session and any suggestions for improvement..."
                              required></textarea>
                    <div class="invalid-feedback">
                        Please provide feedback about the reflection session.
                    </div>
                </div>
            </div>
        </div>

        <!-- Next Session Date -->
        <div class="card mb-4">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">
                    <i class="bi bi-calendar-plus me-2"></i>
                    Next Session Planning
                </h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label for="nextSessionDate" class="form-label fw-bold">
                        Schedule Next Session Date (Optional)
                    </label>
                    <input asp-for="NextSessionDate" 
                           id="nextSessionDate"
                           type="date" 
                           class="form-control" 
                           min="@DateTime.Today.ToString("yyyy-MM-dd")" />
                    <div class="form-text">
                        Leave blank if not scheduling at this time.
                    </div>
                </div>
            </div>
        </div>

        <!-- Finalization Section -->
        <div class="card mb-4">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-lock me-2"></i>
                    Protocol Finalization
                </h5>
            </div>
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <label for="finalizeProtocol" class="form-label fw-bold mb-1">
                            Mark this protocol as finalized
                        </label>
                        <div class="form-text text-danger">
                            <i class="bi bi-exclamation-triangle me-1"></i>
                            Warning: Once finalized, this protocol cannot be edited further. 
                            This action cannot be undone.
                        </div>
                    </div>
                    <div class="form-check form-switch">
                        <input asp-for="FinalizeProtocol" 
                               id="finalizeProtocol"
                               type="checkbox" 
                               class="form-check-input" 
                               role="switch" />
                        <label class="form-check-label" for="finalizeProtocol">
                            <span id="switchLabel">@(Model.FinalizeProtocol ? "Finalized" : "Active")</span>
                        </label>
                    </div>
                </div>
            </div>
        </div>

        <!-- Action Button -->
        <div class="d-flex justify-content-end">
            <button type="submit" class="btn btn-primary btn-lg">
                <i class="bi bi-floppy me-2"></i>Save and Exit Protocol
            </button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        // Bootstrap form validation
        (function() {
            'use strict';
            window.addEventListener('load', function() {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function(form) {
                    form.addEventListener('submit', function(event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();

        // Confirmation for finalize checkbox
        document.getElementById('finalizeProtocol').addEventListener('change', function() {
            const switchLabel = document.getElementById('switchLabel');
            
            if (this.checked) {
                if (!confirm('Are you sure you want to finalize this protocol? This action cannot be undone.')) {
                    this.checked = false;
                    switchLabel.textContent = 'Active';
                } else {
                    switchLabel.textContent = 'Finalized';
                }
            } else {
                switchLabel.textContent = 'Active';
            }
        });

        // Auto-save functionality (optional enhancement)
        let saveTimeout;
        const textarea = document.getElementById('wrapUpResponse');
        
        textarea.addEventListener('input', function() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(function() {
                // Auto-save after 2 seconds of no typing
                console.log('Auto-saving...');
                // Could implement AJAX auto-save here if desired
            }, 2000);
        });
    </script>
}