@page "{handler?}"
@model ORSV2.Pages.GuidanceAlignment.ProtocolSections.AbovethelineModel
@{
    ViewData["Title"] = "Above the Line";
    Layout = "~/Pages/Shared/_ProtocolLayout.cshtml";
}

<h4 class="mb-3">Above the Line</h4>

@if (Model.Protocol?.CP > 1)
{
    <div class="row mb-3">
        <div class="col-md-4">
            <label class="form-label">Compare to Previous Checkpoint:</label>
            <select id="compareCPSelect" class="form-select" onchange="updateComparisonTables()">
                <option value="">Select Checkpoint</option>
                @for (int i = 1; i < Model.Protocol.CP; i++)
                {
                    <option value="@i" selected="@(Model.CompareCP == i)">Checkpoint @i</option>
                }
            </select>
        </div>
        <div class="col-md-8 d-flex align-items-end">
            <div id="loadingIndicator" class="text-muted" style="display: none;">
                <i class="spinner-border spinner-border-sm me-2"></i>
                Loading comparison data...
            </div>
        </div>
    </div>
}

<!-- Tables Container -->
<div id="aboveLineTablesContainer">
    @await Html.PartialAsync("_AboveLineTableGroups", Model)
</div>

<h5 class="mt-4">Reflection / Notes</h5>
<form method="post" asp-page-handler="SaveComment" asp-route-protocolId="@Model.ProtocolId" asp-route-compareCP="@Model.CompareCP">
    <textarea asp-for="AboveLineComment" class="form-control" rows="4" placeholder="Enter reflection notes here..."></textarea>
    <button type="submit" class="btn btn-primary mt-2">Save Comment</button>
</form>

@section Scripts {
<script>
    async function updateComparisonTables() {
        const select = document.getElementById('compareCPSelect');
        const selectedValue = select.value;
        const loadingIndicator = document.getElementById('loadingIndicator');
        const tablesContainer = document.getElementById('aboveLineTablesContainer');
        
        try {
            // Show loading indicator
            loadingIndicator.style.display = 'block';
            select.disabled = true;
            
            // Build the URL with compareCP parameter
            const url = `?handler=Tables&protocolId=@Model.ProtocolId${selectedValue ? `&compareCP=${selectedValue}` : ''}`;
            
            // Fetch updated tables
            const response = await fetch(url);
            
            if (response.ok) {
                const html = await response.text();
                tablesContainer.innerHTML = html;
            } else {
                console.error('Failed to load comparison tables');
                tablesContainer.innerHTML = '<div class="alert alert-danger">Failed to load comparison data. Please refresh the page.</div>';
            }
        } catch (error) {
            console.error('Error updating tables:', error);
            tablesContainer.innerHTML = '<div class="alert alert-danger">Error loading data. Please refresh the page.</div>';
        } finally {
            // Hide loading indicator
            loadingIndicator.style.display = 'none';
            select.disabled = false;
        }
    }

    // Auto-save functionality for the comment
    let autoSaveTimeout;
    const commentTextarea = document.querySelector('textarea[name="AboveLineComment"]');
    
    if (commentTextarea) {
        commentTextarea.addEventListener('input', function() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(autoSaveComment, 2000); // Auto-save after 2 seconds of inactivity
        });
    }

    async function autoSaveComment() {
        const textarea = document.querySelector('textarea[name="AboveLineComment"]');
        if (!textarea) return;

        const formData = new FormData();
        formData.append('AboveLineComment', textarea.value);
        formData.append('CompareCP', document.getElementById('compareCPSelect')?.value || '');
        formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

        try {
            const response = await fetch('?handler=SaveComment', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                // Show subtle auto-save indicator
                showAutoSaveStatus('Auto-saved', 'success');
            } else {
                showAutoSaveStatus('Auto-save failed', 'error');
            }
        } catch (error) {
            console.error('Auto-save error:', error);
            showAutoSaveStatus('Auto-save error', 'error');
        }
    }

    function showAutoSaveStatus(message, type) {
        // Remove existing status
        const existing = document.getElementById('autoSaveStatus');
        if (existing) existing.remove();

        // Create new status indicator
        const status = document.createElement('small');
        status.id = 'autoSaveStatus';
        status.className = `text-${type === 'success' ? 'success' : 'danger'} ms-2`;
        status.textContent = message;

        // Add after the save button
        const saveButton = document.querySelector('button[type="submit"]');
        if (saveButton) {
            saveButton.parentNode.appendChild(status);
            
            // Remove after 3 seconds
            setTimeout(() => {
                if (status.parentNode) {
                    status.remove();
                }
            }, 3000);
        }
    }
</script>
}