@page "{handler?}"
@model ORSV2.Pages.GuidanceAlignment.ProtocolSections.TrendsModel
@{
    ViewData["Title"] = "Trends";
    Layout = "~/Pages/Shared/_ProtocolLayout.cshtml";
}

<style>
    .scroll-margin { scroll-margin-top: 100px; }
    .nav-pills .nav-link.active { background-color: #0d6efd !important; }
    .section-divider { border-top: 3px solid #dee2e6; margin: 2rem 0; }
    .data-table { font-size: 0.875rem; }
    .trend-section { min-height: 50vh; padding: 1rem 0; }
</style>

<div class="row">
    <!-- Floating Navigation -->
    <div class="col-lg-3">
        <div class="position-sticky" style="top: 20px;">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h6 class="mb-0">Navigate Trends</h6>
                </div>
                <div class="card-body p-2">
                    <nav class="nav nav-pills flex-column">
                        <a class="nav-link" href="#predictive-grades">
                            <i class="bi bi-graph-up me-2"></i>Predictive Grades
                        </a>
                        <a class="nav-link" href="#end-journey-grades">
                            <i class="bi bi-mortarboard me-2"></i>End of Journey
                        </a>
                        <a class="nav-link" href="#english-learners">
                            <i class="bi bi-translate me-2"></i>English Learners
                        </a>
                        <a class="nav-link" href="#rfep-students">
                            <i class="bi bi-check-circle me-2"></i>RFEP Students
                        </a>
                        <a class="nav-link" href="#african-american">
                            <i class="bi bi-people me-2"></i>African American
                        </a>
                        <a class="nav-link" href="#students-disabilities">
                            <i class="bi bi-universal-access me-2"></i>Students w/ Disabilities
                        </a>
                    </nav>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="col-lg-9">
        <h4 class="mb-3">Trends Analysis</h4>

        <!-- Success Message -->
        @if (TempData["Success"] != null)
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                @TempData["Success"]
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }

        <form method="post" asp-page-handler="Save" asp-route-protocolId="@Model.ProtocolId">
            
            <!-- Predictive Grades Section -->
            <section id="predictive-grades" class="scroll-margin trend-section">
                <h5 class="text-primary mb-3">
                    <i class="bi bi-graph-up me-2"></i>Predictive Grades Analysis
                </h5>

                <!-- Predictive Grades 6-8 Data -->
                @if (Model.PredictiveGrades6_8 != null)
                {
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <a class="text-decoration-none d-flex justify-content-between align-items-center" 
                               data-bs-toggle="collapse" href="#collapsePredictive6_8" role="button">
                                <span><i class="bi bi-table me-2"></i>@Model.PredictiveGrades6_8.Title (@Model.PredictiveGrades6_8.GradeRange)</span>
                                <i class="bi bi-chevron-down"></i>
                            </a>
                        </div>
                        <div class="collapse" id="collapsePredictive6_8">
                            <div class="card-body p-2">
                                @await Html.PartialAsync("_TrendDataTable", Model.PredictiveGrades6_8)
                            </div>
                        </div>
                    </div>
                }

                <!-- Predictive Grades 9-10 Data -->
                @if (Model.PredictiveGrades9_10 != null)
                {
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <a class="text-decoration-none d-flex justify-content-between align-items-center" 
                               data-bs-toggle="collapse" href="#collapsePredictive9_10" role="button">
                                <span><i class="bi bi-table me-2"></i>@Model.PredictiveGrades9_10.Title (@Model.PredictiveGrades9_10.GradeRange)</span>
                                <i class="bi bi-chevron-down"></i>
                            </a>
                        </div>
                        <div class="collapse" id="collapsePredictive9_10">
                            <div class="card-body p-2">
                                @await Html.PartialAsync("_TrendDataTable", Model.PredictiveGrades9_10)
                            </div>
                        </div>
                    </div>
                }

                <!-- Predictive Trends Questions -->
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white">
                        <h6 class="mb-0">Predictive Grades Trends (6-10)</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">@ORSV2.Pages.GuidanceAlignment.ProtocolSections.TrendsModel.TrendQuestions["GradeLevelPredictive"]</label>
                            <textarea name="TrendResponses[GradeLevelPredictive]" class="form-control" rows="4" 
                                      placeholder="Describe patterns, improvements, or concerns you observe in grades 6-10...">@Model.TrendResponses.GetValueOrDefault("GradeLevelPredictive", "")</textarea>
                        </div>
                        <div class="mb-0">
                            <label class="form-label fw-bold">@ORSV2.Pages.GuidanceAlignment.ProtocolSections.TrendsModel.TrendQuestions["GradeLevelPredictiveWhy"]</label>
                            <textarea name="TrendResponses[GradeLevelPredictiveWhy]" class="form-control" rows="4" 
                                      placeholder="Explain the possible causes or factors contributing to these trends...">@Model.TrendResponses.GetValueOrDefault("GradeLevelPredictiveWhy", "")</textarea>
                        </div>
                    </div>
                </div>
            </section>

            <div class="section-divider"></div>

            <!-- End of Journey Section -->
            <section id="end-journey-grades" class="scroll-margin trend-section">
                <h5 class="text-info mb-3">
                    <i class="bi bi-mortarboard me-2"></i>End of Journey Analysis
                </h5>

                <!-- End of Journey Data -->
                @if (Model.EndOfJourneyGrades != null)
                {
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <a class="text-decoration-none d-flex justify-content-between align-items-center" 
                               data-bs-toggle="collapse" href="#collapseEndJourney" role="button">
                                <span><i class="bi bi-table me-2"></i>@Model.EndOfJourneyGrades.Title (@Model.EndOfJourneyGrades.GradeRange)</span>
                                <i class="bi bi-chevron-down"></i>
                            </a>
                        </div>
                        <div class="collapse" id="collapseEndJourney">
                            <div class="card-body p-2">
                                @await Html.PartialAsync("_TrendDataTable", Model.EndOfJourneyGrades)
                            </div>
                        </div>
                    </div>
                }

                <!-- End of Journey Questions -->
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">End of Journey Trends (11-12)</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">@ORSV2.Pages.GuidanceAlignment.ProtocolSections.TrendsModel.TrendQuestions["GradeLevelEndJourney"]</label>
                            <textarea name="TrendResponses[GradeLevelEndJourney]" class="form-control" rows="4" 
                                      placeholder="Describe patterns, improvements, or concerns you observe in grades 11-12...">@Model.TrendResponses.GetValueOrDefault("GradeLevelEndJourney", "")</textarea>
                        </div>
                        <div class="mb-0">
                            <label class="form-label fw-bold">@ORSV2.Pages.GuidanceAlignment.ProtocolSections.TrendsModel.TrendQuestions["GradeLevelEndJourneyWhy"]</label>
                            <textarea name="TrendResponses[GradeLevelEndJourneyWhy]" class="form-control" rows="4" 
                                      placeholder="Explain the possible causes or factors contributing to these trends...">@Model.TrendResponses.GetValueOrDefault("GradeLevelEndJourneyWhy", "")</textarea>
                        </div>
                    </div>
                </div>
            </section>

            <div class="section-divider"></div>

            <!-- English Learners Section -->
            <section id="english-learners" class="scroll-margin trend-section">
                <h5 class="text-success mb-3">
                    <i class="bi bi-translate me-2"></i>English Learners Analysis
                </h5>

                <!-- English Learner Data -->
                @if (Model.EnglishLearnerData != null)
                {
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <a class="text-decoration-none d-flex justify-content-between align-items-center" 
                               data-bs-toggle="collapse" href="#collapseEL" role="button">
                                <span><i class="bi bi-table me-2"></i>@Model.EnglishLearnerData.Title (@Model.EnglishLearnerData.GradeRange) - @Model.EnglishLearnerData.Rows.FirstOrDefault()?.GradeData.Values.Sum(v => v.TotalCount) students</span>
                                <i class="bi bi-chevron-down"></i>
                            </a>
                        </div>
                        <div class="collapse" id="collapseEL">
                            <div class="card-body p-2">
                                @await Html.PartialAsync("_TrendDataTable", Model.EnglishLearnerData)
                            </div>
                        </div>
                    </div>
                }

                <!-- English Learner Questions -->
                <div class="card border-success">
                    <div class="card-header bg-success text-white">
                        <h6 class="mb-0">English Learner Trends</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">@ORSV2.Pages.GuidanceAlignment.ProtocolSections.TrendsModel.TrendQuestions["EnglishLearner"]</label>
                            <textarea name="TrendResponses[EnglishLearner]" class="form-control" rows="4" 
                                      placeholder="Describe performance patterns, progress, or challenges for English Learners...">@Model.TrendResponses.GetValueOrDefault("EnglishLearner", "")</textarea>
                        </div>
                        <div class="mb-0">
                            <label class="form-label fw-bold">@ORSV2.Pages.GuidanceAlignment.ProtocolSections.TrendsModel.TrendQuestions["EnglishLearnerWhy"]</label>
                            <textarea name="TrendResponses[EnglishLearnerWhy]" class="form-control" rows="4" 
                                      placeholder="Explain factors affecting English Learner performance...">@Model.TrendResponses.GetValueOrDefault("EnglishLearnerWhy", "")</textarea>
                        </div>
                    </div>
                </div>
            </section>

            <div class="section-divider"></div>

            <!-- RFEP Section -->
            <section id="rfep-students" class="scroll-margin trend-section">
                <h5 class="text-warning mb-3">
                    <i class="bi bi-check-circle me-2"></i>RFEP Students Analysis
                </h5>

                <!-- RFEP Data -->
                @if (Model.RFEPData != null)
                {
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <a class="text-decoration-none d-flex justify-content-between align-items-center" 
                               data-bs-toggle="collapse" href="#collapseRFEP" role="button">
                                <span><i class="bi bi-table me-2"></i>@Model.RFEPData.Title (@Model.RFEPData.GradeRange) - @Model.RFEPData.Rows.FirstOrDefault()?.GradeData.Values.Sum(v => v.TotalCount) students</span>
                                <i class="bi bi-chevron-down"></i>
                            </a>
                        </div>
                        <div class="collapse" id="collapseRFEP">
                            <div class="card-body p-2">
                                @await Html.PartialAsync("_TrendDataTable", Model.RFEPData)
                            </div>
                        </div>
                    </div>
                }

                <!-- RFEP Questions -->
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h6 class="mb-0">RFEP Student Trends</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">@ORSV2.Pages.GuidanceAlignment.ProtocolSections.TrendsModel.TrendQuestions["RFEP"]</label>
                            <textarea name="TrendResponses[RFEP]" class="form-control" rows="4" 
                                      placeholder="Describe performance patterns for reclassified students...">@Model.TrendResponses.GetValueOrDefault("RFEP", "")</textarea>
                        </div>
                        <div class="mb-0">
                            <label class="form-label fw-bold">@ORSV2.Pages.GuidanceAlignment.ProtocolSections.TrendsModel.TrendQuestions["RFEPWhy"]</label>
                            <textarea name="TrendResponses[RFEPWhy]" class="form-control" rows="4" 
                                      placeholder="Explain factors affecting RFEP student performance...">@Model.TrendResponses.GetValueOrDefault("RFEPWhy", "")</textarea>
                        </div>
                    </div>
                </div>
            </section>

            <div class="section-divider"></div>

            <!-- African American Section -->
            <section id="african-american" class="scroll-margin trend-section">
                <h5 class="text-secondary mb-3">
                    <i class="bi bi-people me-2"></i>African American Students Analysis
                </h5>

                <!-- African American Data -->
                @if (Model.AfricanAmericanData != null)
                {
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <a class="text-decoration-none d-flex justify-content-between align-items-center" 
                               data-bs-toggle="collapse" href="#collapseAA" role="button">
                                <span><i class="bi bi-table me-2"></i>@Model.AfricanAmericanData.Title (@Model.AfricanAmericanData.GradeRange) - @Model.AfricanAmericanData.Rows.FirstOrDefault()?.GradeData.Values.Sum(v => v.TotalCount) students</span>
                                <i class="bi bi-chevron-down"></i>
                            </a>
                        </div>
                        <div class="collapse" id="collapseAA">
                            <div class="card-body p-2">
                                @await Html.PartialAsync("_TrendDataTable", Model.AfricanAmericanData)
                            </div>
                        </div>
                    </div>
                }

                <!-- African American Questions -->
                <div class="card border-secondary">
                    <div class="card-header bg-secondary text-white">
                        <h6 class="mb-0">African American Student Trends</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">@ORSV2.Pages.GuidanceAlignment.ProtocolSections.TrendsModel.TrendQuestions["AfricanAmerican"]</label>
                            <textarea name="TrendResponses[AfricanAmerican]" class="form-control" rows="4" 
                                      placeholder="Describe performance patterns, achievements, or challenges for African American students...">@Model.TrendResponses.GetValueOrDefault("AfricanAmerican", "")</textarea>
                        </div>
                        <div class="mb-0">
                            <label class="form-label fw-bold">@ORSV2.Pages.GuidanceAlignment.ProtocolSections.TrendsModel.TrendQuestions["AfricanAmericanWhy"]</label>
                            <textarea name="TrendResponses[AfricanAmericanWhy]" class="form-control" rows="4" 
                                      placeholder="Explain factors affecting African American student performance...">@Model.TrendResponses.GetValueOrDefault("AfricanAmericanWhy", "")</textarea>
                        </div>
                    </div>
                </div>
            </section>

            <div class="section-divider"></div>

            <!-- Students with Disabilities Section -->
            <section id="students-disabilities" class="scroll-margin trend-section">
                <h5 class="text-dark mb-3">
                    <i class="bi bi-universal-access me-2"></i>Students with Disabilities Analysis
                </h5>

                <!-- Students with Disabilities Data -->
                @if (Model.StudentsWithDisabilitiesData != null)
                {
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <a class="text-decoration-none d-flex justify-content-between align-items-center" 
                               data-bs-toggle="collapse" href="#collapseSWD" role="button">
                                <span><i class="bi bi-table me-2"></i>@Model.StudentsWithDisabilitiesData.Title (@Model.StudentsWithDisabilitiesData.GradeRange) - @Model.StudentsWithDisabilitiesData.Rows.FirstOrDefault()?.GradeData.Values.Sum(v => v.TotalCount) students</span>
                                <i class="bi bi-chevron-down"></i>
                            </a>
                        </div>
                        <div class="collapse" id="collapseSWD">
                            <div class="card-body p-2">
                                @await Html.PartialAsync("_TrendDataTable", Model.StudentsWithDisabilitiesData)
                            </div>
                        </div>
                    </div>
                }

                <!-- Students with Disabilities Questions -->
                <div class="card border-dark">
                    <div class="card-header bg-dark text-white">
                        <h6 class="mb-0">Students with Disabilities Trends</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label fw-bold">@ORSV2.Pages.GuidanceAlignment.ProtocolSections.TrendsModel.TrendQuestions["StudentsWithDisabilities"]</label>
                            <textarea name="TrendResponses[StudentsWithDisabilities]" class="form-control" rows="4" 
                                      placeholder="Describe performance patterns, progress, or challenges for students with disabilities...">@Model.TrendResponses.GetValueOrDefault("StudentsWithDisabilities", "")</textarea>
                        </div>
                        <div class="mb-0">
                            <label class="form-label fw-bold">@ORSV2.Pages.GuidanceAlignment.ProtocolSections.TrendsModel.TrendQuestions["StudentsWithDisabilitiesWhy"]</label>
                            <textarea name="TrendResponses[StudentsWithDisabilitiesWhy]" class="form-control" rows="4" 
                                      placeholder="Explain factors affecting students with disabilities performance...">@Model.TrendResponses.GetValueOrDefault("StudentsWithDisabilitiesWhy", "")</textarea>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Save Button - Sticky -->
            <div class="position-sticky bottom-0 bg-white border-top py-3 mt-4">
                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-save me-2"></i>Save All Trends Analysis
                    </button>
                </div>
            </div>

        </form>

        <!-- Last Updated Information -->
        @if (!string.IsNullOrWhiteSpace(Model.LastUpdated))
        {
            <div class="mt-4 p-3 bg-light rounded">
                <small class="text-muted">
                    <i class="bi bi-clock"></i> Last updated: @Model.LastUpdated by @Model.LastUpdatedBy
                </small>
            </div>
        }
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Smooth scrolling navigation
            const navLinks = document.querySelectorAll('.nav-pills .nav-link');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetId = this.getAttribute('href');
                    const targetElement = document.querySelector(targetId);
                    
                    if (targetElement) {
                        // Update active nav link
                        navLinks.forEach(l => l.classList.remove('active'));
                        this.classList.add('active');
                        
                        // Smooth scroll to target
                        targetElement.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });

            // Intersection Observer for nav highlighting
            const sections = document.querySelectorAll('.trend-section');
            const observer = new IntersectionObserver(
                (entries) => {
                    entries.forEach(entry => {
                        if (entry.isIntersecting) {
                            const id = entry.target.id;
                            navLinks.forEach(link => {
                                link.classList.remove('active');
                                if (link.getAttribute('href') === `#${id}`) {
                                    link.classList.add('active');
                                }
                            });
                        }
                    });
                },
                { 
                    rootMargin: '-20% 0px -70% 0px',
                    threshold: 0.1
                }
            );

            sections.forEach(section => observer.observe(section));

            // Auto-expand data tables if questions have content
            const textareas = document.querySelectorAll('textarea');
            textareas.forEach(textarea => {
                if (textarea.value.trim()) {
                    const section = textarea.closest('.trend-section');
                    if (section) {
                        // Find and expand any collapsed data table in this section
                        const collapseElement = section.querySelector('.collapse');
                        if (collapseElement) {
                            collapseElement.classList.add('show');
                        }
                        
                        // Add visual indicator
                        const card = textarea.closest('.card');
                        if (card) {
                            card.classList.add('border-success');
                            card.style.boxShadow = '0 0 0 0.2rem rgba(25, 135, 84, 0.25)';
                        }
                    }
                }
            });

            // Auto-save functionality
            let autoSaveTimeout;
            
            textareas.forEach(textarea => {
                textarea.addEventListener('input', function() {
                    clearTimeout(autoSaveTimeout);
                    autoSaveTimeout = setTimeout(autoSave, 3000);
                });
            });

            async function autoSave() {
                const form = document.querySelector('form');
                const formData = new FormData(form);
                
                try {
                    const response = await fetch('?handler=Save', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        showAutoSaveStatus('Auto-saved', 'success');
                    } else {
                        showAutoSaveStatus('Auto-save failed', 'error');
                    }
                } catch (error) {
                    console.error('Auto-save error:', error);
                    showAutoSaveStatus('Auto-save error', 'error');
                }
            }

            function showAutoSaveStatus(message, type) {
                // Remove existing status
                const existing = document.getElementById('autoSaveStatus');
                if (existing) existing.remove();

                // Create new status indicator
                const status = document.createElement('small');
                status.id = 'autoSaveStatus';
                status.className = `text-${type === 'success' ? 'success' : 'danger'} ms-2`;
                status.innerHTML = `<i class="bi bi-check-circle"></i> ${message}`;

                // Add to save button
                const saveButton = document.querySelector('button[type="submit"]');
                if (saveButton) {
                    saveButton.parentNode.appendChild(status);
                    
                    setTimeout(() => {
                        if (status.parentNode) {
                            status.remove();
                        }
                    }, 3000);
                }
            }

            // Toggle chevron icons on collapse
            document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(trigger => {
                trigger.addEventListener('click', function() {
                    const chevron = this.querySelector('.bi-chevron-down, .bi-chevron-up');
                    if (chevron) {
                        setTimeout(() => {
                            const target = document.querySelector(this.getAttribute('href'));
                            if (target && target.classList.contains('show')) {
                                chevron.className = chevron.className.replace('bi-chevron-down', 'bi-chevron-up');
                            } else {
                                chevron.className = chevron.className.replace('bi-chevron-up', 'bi-chevron-down');
                            }
                        }, 300);
                    }
                });
            });
        });
    </script>
}