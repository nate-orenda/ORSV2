@page "EditProtocol/{id:int}"
@model ORSV2.Pages.GuidanceAlignment.EditProtocolModel
@{
    ViewData["Title"] = "Edit GA Protocol";
}
@await Html.PartialAsync("_Breadcrumbs", Model.Breadcrumbs)

<div class="container-fluid">
    <div class="row">
        <!-- Sidebar Navigation -->
        <nav class="col-md-3 col-lg-2 d-md-block bg-light sidebar position-sticky"
            style="top: 0; height: 100vh; overflow-y: auto;">
            <div class="pt-3">
                <ul class="nav flex-column">
                    <li class="nav-item"><a class="nav-link" href="#introduction">1. Introduction</a></li>
                    <li class="nav-item"><a class="nav-link" href="#targets">2. Targets</a></li>
                    <li class="nav-item"><a class="nav-link" href="#above">3. Above the Line</a></li>
                    <li class="nav-item"><a class="nav-link" href="#demographics">4. Demographics</a></li>
                    <li class="nav-item"><a class="nav-link" href="#indicators">5. Indicators</a></li>
                    <li class="nav-item"><a class="nav-link" href="#trends">6. Trends</a></li>
                    <li class="nav-item"><a class="nav-link" href="#agreements">7. Common Agreements</a></li>
                    <li class="nav-item"><a class="nav-link" href="#action">8. Action Plan</a></li>
                    <li class="nav-item"><a class="nav-link" href="#wrapup">9. Wrap Up</a></li>
                </ul>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4">
            <h1 class="mt-3">Edit GA Protocol</h1>

            <form method="post">
                @for (int i = 1; i <= 9; i++)
                {
                    var sectionId = i switch
                    {
                        1 => "introduction",
                        2 => "targets",
                        3 => "above",
                        4 => "demographics",
                        5 => "indicators",
                        6 => "trends",
                        7 => "agreements",
                        8 => "action",
                        9 => "wrapup",
                        _ => $"section{i}"
                    };

                    <section id="@sectionId" class="ga-section @(i == 1 ? "visible" : "d-none") my-5">
                        <h3>@i. @Model.SectionTitles[i]</h3>

                        @if (i == 1)
                        {
                            <p class="mb-3">
                                Welcome to the Guidance Alignment Protocol Module. This module is designed to help you save and
                                organize your team’s reflections on the data presented in PROMOTE. Each section below
                                corresponds to a step in the Guidance Alignment (GA) Protocol and presents the relevant data for
                                review.
                            </p>
                            <p class="mb-3">
                                Every step includes a text editor where you can enter your observations, reflections, and plans.
                                These entries will be saved and reviewed in future GA sessions, allowing for ongoing
                                collaboration and continuous improvement.
                            </p>
                            <p class="mb-3">
                                The editor supports pasting formatted data tables directly from PROMOTE. You can also use the
                                toolbar above each editor for helpful formatting features—hover over each icon to see tooltips.
                            </p>
                            <p class="mb-4">
                                In some steps, you will be asked to set performance targets based on the data. These targets can
                                be revisited and adjusted during later GA sessions. Don’t forget to save your responses at the
                                end of each step.
                            </p>

                        }

                        @if (i == 2)
                        {
                            <h5>Existing Above the Line Targets</h5>
                            @if (Model.GradeLevelTargets.Any())
                            {
                                <table class="table table-striped w-auto">
                                    <thead>
                                        <tr>
                                            <th>Grade Level</th>
                                            <th>Target %</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var target in Model.GradeLevelTargets)
                                        {
                                            <tr>
                                                <td>
                                                    @(target.GradeLevel == 0 ? "K" : $"Grade {target.GradeLevel}")
                                                </td>
                                                <td>
                                                    @target.TargetValue.ToString("0.##")%
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            }
                            else
                            {
                                <p class="text-muted">No targets entered yet.</p>
                            }

                            <h5 class="mt-4">Add New Target</h5>

                            <form method="post">
                                <input type="hidden" asp-for="Id" />

                                <table class="table w-auto">
                                    <thead>
                                        <tr>
                                            <th>Grade</th>
                                            <th>Target Type</th>
                                            <th>Target Value (%)</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td>
                                                <select asp-for="NewTarget.GradeLevel" class="form-select">
                                                    <option value="0">K</option>
                                                    @for (int j = 1; j <= 12; j++)
                                                    {
                                                        <option value="@j">@j</option>
                                                    }
                                                </select>
                                            </td>
                                            <td>
                                                <select asp-for="NewTarget.TargetType" class="form-select">
                                                    <option value="AboveLine">Above the Line</option>
                                                </select>
                                            </td>
                                            <td>
                                                <input asp-for="NewTarget.TargetValue"
                                                    class="form-control"
                                                    type="number"
                                                    min="0"
                                                    max="100"
                                                    step="1" />
                                            </td>
                                            <td>
                                                <button type="submit" name="insertButton" class="btn btn-primary">Insert</button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </form>
                        }

                    @if (i != 1 && i != 2)
                    {
                        @if (Model.Protocol != null &&
                                            Model.Protocol.SectionResponses.FirstOrDefault(r => r.SectionNumber == i) is { } sectionMeta)
                        {
                            <small class="text-muted d-block mb-2">
                                Last updated by @sectionMeta.UpdatedBy on @sectionMeta.UpdatedAt.ToLocalTime().ToString("g")
                            </small>
                        }
                        <form method="post" asp-page-handler="SaveSection" class="mb-4">
                            <input type="hidden" name="Section" value="@i" />
                            <textarea class="form-control mb-2" rows="6" name="Content"
                            placeholder="Enter response...">@Model.Responses.GetValueOrDefault(i)</textarea>
                            <button type="submit" class="btn btn-sm btn-outline-success">Save Section</button>
                        </form>
                    }

                    @if (i < 9)
                    {
                        <div class="text-end mt-3">
                            <button type="button" class="btn btn-outline-primary" onclick="goToNextSection(@i)">Next:
                                @Model.SectionTitles[i + 1]</button>
                        </div>
                    }
                </section>
                                }

            </form>

        </main>
    </div>
</div>

@section Scripts {
    <script>
        const sectionMap = {
            1: "introduction",
            2: "targets",
            3: "above",
            4: "demographics",
            5: "indicators",
            6: "trends",
            7: "agreements",
            8: "action",
            9: "wrapup"
        };

        function goToNextSection(currentIndex) {
            const nextId = sectionMap[currentIndex + 1];
            const next = document.getElementById(nextId);
            if (next) {
                next.classList.remove("d-none");
                setTimeout(() => next.classList.add("visible"), 10); // triggers animation
                next.scrollIntoView({ behavior: "smooth" });
            }
        }

        document.querySelectorAll('.nav-link').forEach(link => {
            link.addEventListener('click', function (e) {
                e.preventDefault();
                const id = this.getAttribute('href').substring(1);
                const section = document.getElementById(id);
                if (section && !section.classList.contains('visible')) {
                    section.classList.remove('d-none');
                    setTimeout(() => section.classList.add("visible"), 10);
                }
                section.scrollIntoView({ behavior: 'smooth' });
            });
        });

    </script>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const input = document.querySelector('input[name="NewTarget.TargetValue"]');
            input.addEventListener("input", function () {
                if (this.value > 100) this.value = 100;
                if (this.value < 0) this.value = 0;
            });
        });
    </script>

}
