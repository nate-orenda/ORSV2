@page
@model ORSV2.Pages.GuidanceAlignment.OverviewModel
@using System.Text.Json
@{
    ViewData["Title"] = "Guidance Alignment - Overview";
}
@await Html.PartialAsync("_Breadcrumbs", Model.Breadcrumbs)
<div class="card shadow-sm mb-4 p-4">
    <div class="text-center mb-4">
        <h5 class="mb-1">@Model.School?.Name</h5>
        <h6 class="text-muted">Quadrant Summary â€“ Checkpoint @Model.CurrentCheckpoint</h6>
    </div>
    @if (Model.QuadrantCounts != null && Model.QuadrantCounts.Any())
    {
    <div class="row align-items-start">
        <!-- Left Column: Stats -->
        <div class="col-md-6 mb-4 mb-md-0 text-center">
            <div class="row text-center mb-3">
                <div class="col-6 mb-2">
                    <span class="badge bg-primary w-100">
                        Challenge: @Model.QuadrantCounts.GetValueOrDefault("Challenge", 0)
                        (@Model.FormatPercentage(Model.QuadrantCounts.GetValueOrDefault("Challenge", 0)))
                    </span>
                </div>
                <div class="col-6 mb-2">
                    <span class="badge bg-success w-100">
                        Benchmark: @Model.QuadrantCounts.GetValueOrDefault("Benchmark", 0)
                        (@Model.FormatPercentage(Model.QuadrantCounts.GetValueOrDefault("Benchmark", 0)))
                    </span>
                </div>
                <div class="col-6 mb-2">
                    <span class="badge bg-warning text-dark w-100">
                        Strategic: @Model.QuadrantCounts.GetValueOrDefault("Strategic", 0)
                        (@Model.FormatPercentage(Model.QuadrantCounts.GetValueOrDefault("Strategic", 0)))
                    </span>
                </div>
                <div class="col-6 mb-2">
                    <span class="badge bg-danger w-100">
                        Intensive: @Model.QuadrantCounts.GetValueOrDefault("Intensive", 0)
                        (@Model.FormatPercentage(Model.QuadrantCounts.GetValueOrDefault("Intensive", 0)))
                    </span>
                </div>
            </div>

            <div>
                <strong>Above the Line:</strong>
                @Model.AboveTheLineCount (@Model.FormatPercentage(Model.AboveTheLineCount))<br />
                <strong>Below the Line:</strong>
                @Model.BelowTheLineCount (@Model.FormatPercentage(Model.BelowTheLineCount))<br />
                <strong>Total:</strong> @Model.TotalCount students
                <div class="mt-3">
                    <strong>Select a Grade:</strong>
                    <div class="d-flex flex-wrap justify-content-center gap-2 mt-2">
                        @* This section now uses the School's LowGrade and HighGrade properties to generate links *@
                        @{
                            if (Model.School != null)
                            {
                                // Explicitly cast the short? to int to resolve the method ambiguity.
                                var startGrade = Math.Max(0, (int)(Model.School.LowGrade ?? 0));
                                var endGrade = Math.Min(12, (int)(Model.School.HighGrade ?? 12));

                                // Loop through the calculated grade range and create a button for each grade.
                                for (var grade = startGrade; grade <= endGrade; grade++)
                                {
                                    // Set the display text. Grade 0 is shown as "K".
                                    var gradeText = grade == 0 ? "K" : grade.ToString();
                                    <a class="btn btn-orenda-primary btn-sm"
                                       asp-page="/GuidanceAlignment/Students"
                                       asp-route-schoolId="@Model.School.Id"
                                       asp-route-grade="@grade">
                                        Grade @gradeText
                                    </a>
                                }
                            }
                        }
                    </div>
                </div>
                <div class="d-flex flex-wrap justify-content-center gap-2 mt-2">
                    <a asp-page="/GuidanceAlignment/Protocols" asp-route-schoolId="@Model.School?.Id" class="btn btn-orenda-primary btn-sm">
                        View Protocols
                    </a>
                    <a class="btn btn-orenda-primary btn-sm"
                        asp-page="/GuidanceAlignment/ViewTargetGroups"
                        asp-route-schoolId="@Model.SchoolId">
                        Target Groups
                    </a>
                </div>
            </div>
        </div>

        <!-- Right Column: Chart -->
        <div class="col-md-6 d-flex justify-content-center">
            <div style="max-width: 100%; width: 100%; max-height: 400px;">
                <canvas id="quadrantChart"></canvas>
            </div>
        </div>
    </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            Quadrant data is not yet available for this checkpoint at @Model.School?.Name.
        </div>
    }
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
    // Pull model data
    const quadrantCounts = @Html.Raw(JsonSerializer.Serialize(Model.QuadrantCounts));
    const total = @Model.TotalCount;

    // Safe getters for values
    const challenge = quadrantCounts["Challenge"] ?? 0;
    const benchmark = quadrantCounts["Benchmark"] ?? 0;
    const strategic = quadrantCounts["Strategic"] ?? 0;
    const intensive = quadrantCounts["Intensive"] ?? 0;

    // Color palette (matching your badges)
    const COLORS = {
        challenge: '#0d6efd', // Bootstrap 5 primary
        benchmark: '#198754', // Bootstrap 5 success
        strategic: '#ffc107', // Bootstrap 5 warning
        intensive: '#dc3545'  // Bootstrap 5 danger
    };

    // Helper functions
    function pct(value) {
        return total > 0 ? ((value / total) * 100) : 0;
    }
    function labelPct(value) {
        const p = pct(value);
        return p >= 3 ? `${p.toFixed(0)}%` : '';
    }
    function pickTextColor(bg) {
        const c = bg.substring(1); // strip #
        const rgb = parseInt(c, 16);
        const r = (rgb >> 16) & 0xff;
        const g = (rgb >> 8) & 0xff;
        const b = (rgb >> 0) & 0xff;
        const luma = 0.2126 * r + 0.7152 * g + 0.0722 * b;
        return luma < 150 ? 'white' : '#333';
    }

    /**
     * Custom plugin to draw "Above/Below the Line" labels and a dividing line.
     */
    const lineLabelsPlugin = {
        id: 'lineLabels',
        afterDraw: (chart, args, options) => {
            const { ctx, chartArea: { top, bottom }, data } = chart;
            
            // Check if there's enough data to draw the line
            if (chart.getDatasetMeta(1).hidden || data.datasets[1].data[0] === 0 || total === 0) return;

            // The dividing line is the top of the 'Strategic' bar (dataset at index 1)
            const strategicMeta = chart.getDatasetMeta(1);
            const lineY = strategicMeta.data[0].y;
            
            const bar = chart.getDatasetMeta(0).data[0];
            const barRight = bar.x + bar.width / 2;
            const labelX = barRight + 20; // Position labels to the right of the bar

            ctx.save();
            
            // --- 1. Draw the Dividing Line ---
            ctx.beginPath();
            ctx.strokeStyle = '#343a40'; // Darker gray for prominence
            ctx.lineWidth = 2; // Thicker line
            ctx.setLineDash([]); // Solid line
            ctx.moveTo(bar.x - bar.width / 2, lineY);
            ctx.lineTo(labelX - 10, lineY);
            ctx.stroke();

            // --- 2. Calculate and Draw the Labels with Percentages ---
            ctx.font = '600 0.8rem sans-serif';
            ctx.fillStyle = '#343a40'; // Darker text
            ctx.textAlign = 'left';
            ctx.textBaseline = 'middle';
            
            // Calculate "Below the Line" totals
            const belowTheLineCount = intensive + strategic;
            const belowTheLinePct = pct(belowTheLineCount).toFixed(0);
            const belowMidpointY = lineY + (bottom - lineY) / 2;
            ctx.fillText(`Below the Line (${belowTheLinePct}%)`, labelX, belowMidpointY);
            
            // Calculate "Above the Line" totals
            const aboveTheLineCount = benchmark + challenge;
            const aboveTheLinePct = pct(aboveTheLineCount).toFixed(0);
            const aboveMidpointY = top + (lineY - top) / 2;
            ctx.fillText(`Above the Line (${aboveTheLinePct}%)`, labelX, aboveMidpointY);

            ctx.restore();
        }
    };
    
    // Get canvas context
    const ctx = document.getElementById('quadrantChart').getContext('2d');

    // Register plugins
    Chart.register(ChartDataLabels, lineLabelsPlugin);

    const quadrantChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Students'],
            datasets: [
                { label: 'Intensive', data: [intensive], backgroundColor: COLORS.intensive },
                { label: 'Strategic', data: [strategic], backgroundColor: COLORS.strategic },
                { label: 'Benchmark', data: [benchmark], backgroundColor: COLORS.benchmark },
                { label: 'Challenge', data: [challenge], backgroundColor: COLORS.challenge }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false },
                title: { display: false },
                tooltip: {
                    callbacks: {
                        label: (ctx) => {
                            const val = ctx.parsed.y ?? 0;
                            const p = pct(val).toFixed(1);
                            return `${ctx.dataset.label}: ${val} (${p}%)`;
                        }
                    }
                },
                datalabels: {
                    anchor: 'center',
                    align: 'center',
                    formatter: (value) => labelPct(value),
                    color: (ctx) => pickTextColor(ctx.dataset.backgroundColor),
                    font: { weight: 'bold' }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    grid: { display: false, drawBorder: false },
                    ticks: { display: false }
                },
                y: {
                    stacked: true,
                    grid: { display: false, drawBorder: false },
                    ticks: { display: false },
                    max: total
                }
            },
            layout: {
                padding: { top: 15, bottom: 15, right: 120, left: 10 } // Increased right padding for longer labels
            }
        }
    });
</script>