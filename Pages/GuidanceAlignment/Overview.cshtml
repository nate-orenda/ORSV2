@page
@model ORSV2.Pages.GuidanceAlignment.OverviewModel
@using System.Text.Json
@{
    ViewData["Title"] = "Guidance Alignment - Overview";
}
@await Html.PartialAsync("_Breadcrumbs", Model.Breadcrumbs)
<div class="card shadow-sm mb-4 p-4">
    <div class="text-center mb-4">
        <h5 class="mb-1">@Model.School?.Name</h5>
        <h6 class="text-muted">Quadrant Summary â€“ Checkpoint @Model.CurrentCheckpoint</h6>
    </div>
    @if (Model.QuadrantCounts != null && Model.QuadrantCounts.Any())
    {
    <div class="row align-items-start">
        <!-- Left Column: Stats -->
        <div class="col-md-6 mb-4 mb-md-0 text-center">
            <div class="row text-center mb-3">
                <div class="col-6 mb-2">
                    <span class="badge bg-primary w-100">
                        Challenge: @Model.QuadrantCounts.GetValueOrDefault("Challenge", 0)
                        (@Model.FormatPercentage(Model.QuadrantCounts.GetValueOrDefault("Challenge", 0)))
                    </span>
                </div>
                <div class="col-6 mb-2">
                    <span class="badge bg-success w-100">
                        Benchmark: @Model.QuadrantCounts.GetValueOrDefault("Benchmark", 0)
                        (@Model.FormatPercentage(Model.QuadrantCounts.GetValueOrDefault("Benchmark", 0)))
                    </span>
                </div>
                <div class="col-6 mb-2">
                    <span class="badge bg-warning text-dark w-100">
                        Strategic: @Model.QuadrantCounts.GetValueOrDefault("Strategic", 0)
                        (@Model.FormatPercentage(Model.QuadrantCounts.GetValueOrDefault("Strategic", 0)))
                    </span>
                </div>
                <div class="col-6 mb-2">
                    <span class="badge bg-danger w-100">
                        Intensive: @Model.QuadrantCounts.GetValueOrDefault("Intensive", 0)
                        (@Model.FormatPercentage(Model.QuadrantCounts.GetValueOrDefault("Intensive", 0)))
                    </span>
                </div>
            </div>

            <div>
                <strong>Above the Line:</strong>
                @Model.AboveTheLineCount (@Model.FormatPercentage(Model.AboveTheLineCount))<br />
                <strong>Below the Line:</strong>
                @Model.BelowTheLineCount (@Model.FormatPercentage(Model.BelowTheLineCount))<br />
                <strong>Total:</strong> @Model.TotalCount students
                <div class="mt-3">
                    <strong>Select a Grade:</strong>
                    <div class="d-flex flex-wrap justify-content-center gap-2 mt-2">
                        @* This section now uses the School's LowGrade and HighGrade properties to generate links *@
                        @{
                            if (Model.School != null)
                            {
                                // Explicitly cast the short? to int to resolve the method ambiguity.
                                var startGrade = Math.Max(0, (int)(Model.School.LowGrade ?? 0));
                                var endGrade = Math.Min(12, (int)(Model.School.HighGrade ?? 12));

                                // Loop through the calculated grade range and create a button for each grade.
                                for (var grade = startGrade; grade <= endGrade; grade++)
                                {
                                    // Set the display text. Grade 0 is shown as "K".
                                    var gradeText = grade == 0 ? "K" : grade.ToString();
                                    <a class="btn btn-orenda-primary btn-sm"
                                       asp-page="/GuidanceAlignment/Students"
                                       asp-route-schoolId="@Model.School.Id"
                                       asp-route-grade="@grade">
                                        Grade @gradeText
                                    </a>
                                }
                            }
                        }
                    </div>
                </div>
                <div class="d-flex flex-wrap justify-content-center gap-2 mt-2">
                    <a asp-page="/GuidanceAlignment/Protocols" asp-route-schoolId="@Model.School?.Id" class="btn btn-orenda-primary btn-sm">
                        View Protocols
                    </a>
                    <a class="btn btn-orenda-primary btn-sm"
                        asp-page="/GuidanceAlignment/ViewTargetGroups"
                        asp-route-schoolId="@Model.SchoolId">
                        Target Groups
                    </a>
                </div>
            </div>
        </div>

        <!-- Right Column: Chart -->
        <div class="col-md-6 d-flex justify-content-center">
            <div style="max-width: 100%; width: 100%; max-height: 400px;">
                <canvas id="quadrantChart"></canvas>
            </div>
        </div>
    </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            Quadrant data is not yet available for this checkpoint at @Model.School?.Name.
        </div>
    }
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script>
    // Pull model data
    const quadrantCounts = @Html.Raw(JsonSerializer.Serialize(Model.QuadrantCounts));
    const total = @Model.TotalCount;

    // Safe getters
    const challenge = quadrantCounts["Challenge"] ?? 0;
    const benchmark = quadrantCounts["Benchmark"] ?? 0;
    const strategic = quadrantCounts["Strategic"] ?? 0;
    const intensive = quadrantCounts["Intensive"] ?? 0;

    // color palette (matching your badges)
    const COLORS = {
        challenge: '#007bff', // primary
        benchmark: '#28a745', // success
        strategic: '#ffc107', // warning
        intensive: '#dc3545'  // danger
    };

    // Helpers
    function pct(value) {
        return total > 0 ? ((value / total) * 100) : 0;
    }
    function labelPct(value) {
        const p = pct(value);
        // Only show a label if the slice is at least ~2% to reduce clutter
        return p >= 2 ? `${p.toFixed(1)}%` : '';
    }
    function pickTextColor(bg) {
        // Simple luminance heuristic for contrast
        // Returns '#000' for light backgrounds (e.g., yellow), otherwise '#fff'
        const c = bg.replace('#','');
        const r = parseInt(c.substr(0,2),16), g = parseInt(c.substr(2,2),16), b = parseInt(c.substr(4,2),16);
        const luminance = (0.2126*r + 0.7152*g + 0.0722*b);
        return luminance > 160 ? '#000' : '#fff';
    }

    const ctx = document.getElementById('quadrantChart').getContext('2d');

    // Register plugin
    Chart.register(ChartDataLabels);

    const quadrantChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Students'],
            datasets: [
                {
                    label: 'Challenge',
                    data: [challenge],
                    backgroundColor: COLORS.challenge
                },
                {
                    label: 'Benchmark',
                    data: [benchmark],
                    backgroundColor: COLORS.benchmark
                },
                {
                    label: 'Strategic',
                    data: [strategic],
                    backgroundColor: COLORS.strategic
                },
                {
                    label: 'Intensive',
                    data: [intensive],
                    backgroundColor: COLORS.intensive
                }
            ]
        },
        options: {
            // Vertical stacked bar (default indexAxis is 'x')
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { display: false }, // minimalist, legend not needed (labels shown on page)
                title: { display: false },
                tooltip: {
                    enabled: true,
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: (ctx) => {
                            const val = ctx.parsed.y ?? ctx.raw ?? 0;
                            const p = pct(val).toFixed(1);
                            return `${ctx.dataset.label}: ${val} (${p}%)`;
                        },
                        footer: () => `Total: ${total}`
                    }
                },
                datalabels: {
                    anchor: 'center',
                    align: 'center',
                    clip: true,
                    formatter: (value) => labelPct(value),
                    color: (ctx) => {
                        const bg = ctx.dataset.backgroundColor;
                        return pickTextColor(bg);
                    },
                    font: {
                        weight: 600
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    grid: { display: false, drawBorder: false },
                    ticks: { display: false }
                },
                y: {
                    stacked: true,
                    grid: { display: false, drawBorder: false },
                    ticks: { display: false }
                }
            },
            elements: {
                bar: {
                    borderWidth: 0,
                    // slightly slimmer bar to give breathing room
                    categoryPercentage: 0.6,
                    barPercentage: 0.9
                }
            },
            layout: {
                padding: { top: 8, bottom: 8 }
            }
        }
    });
</script>
