@page
@model ORSV2.Pages.GuidanceAlignment.OverviewModel
@using System.Text.Json
@{
    ViewData["Title"] = "Guidance Alignment - Overview";
}
@await Html.PartialAsync("_Breadcrumbs", Model.Breadcrumbs)
<div class="card shadow-sm mb-4 p-4">
    <div class="text-center mb-4">
        <h5 class="mb-1">@Model.School.Name</h5>
        <h6 class="text-muted">Quadrant Summary â€“ Checkpoint @Model.CurrentCheckpoint</h6>
    </div>
    @if (Model.QuadrantCounts != null && Model.QuadrantCounts.Any())
    {
    <div class="row align-items-start">
        <!-- Left Column: Stats -->
        <div class="col-md-6 mb-4 mb-md-0 text-center">
            <div class="row text-center mb-3">
                <div class="col-6 mb-2">
                    <span class="badge bg-primary w-100">
                        Challenge: @Model.QuadrantCounts.GetValueOrDefault("Challenge", 0)
                        (@Model.FormatPercentage(Model.QuadrantCounts.GetValueOrDefault("Challenge", 0)))
                    </span>
                </div>
                <div class="col-6 mb-2">
                    <span class="badge bg-success w-100">
                        Benchmark: @Model.QuadrantCounts.GetValueOrDefault("Benchmark", 0)
                        (@Model.FormatPercentage(Model.QuadrantCounts.GetValueOrDefault("Benchmark", 0)))
                    </span>
                </div>
                <div class="col-6 mb-2">
                    <span class="badge bg-warning text-dark w-100">
                        Strategic: @Model.QuadrantCounts.GetValueOrDefault("Strategic", 0)
                        (@Model.FormatPercentage(Model.QuadrantCounts.GetValueOrDefault("Strategic", 0)))
                    </span>
                </div>
                <div class="col-6 mb-2">
                    <span class="badge bg-danger w-100">
                        Intensive: @Model.QuadrantCounts.GetValueOrDefault("Intensive", 0)
                        (@Model.FormatPercentage(Model.QuadrantCounts.GetValueOrDefault("Intensive", 0)))
                    </span>
                </div>
            </div>

            <div>
                <strong>Above the Line:</strong>
                @Model.AboveTheLineCount (@Model.FormatPercentage(Model.AboveTheLineCount))<br />
                <strong>Below the Line:</strong>
                @Model.BelowTheLineCount (@Model.FormatPercentage(Model.BelowTheLineCount))<br />
                <strong>Total:</strong> @Model.TotalCount students
                <div class="mt-3">
                    <strong>Select a Grade:</strong>
                    <div class="d-flex flex-wrap justify-content-center gap-2 mt-2">
                        @foreach (var grade in Model.GradeDistribution.Select(g => g.Grade).OrderBy(g => g))
                        {
                            <a class="btn btn-sm btn-outline-primary"
                            asp-page="/GuidanceAlignment/Students"
                            asp-route-schoolId="@Model.School.Id"
                            asp-route-grade="@grade">
                                Grade @grade
                            </a>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column: Chart -->
        <div class="col-md-6 d-flex justify-content-center">
            <div style="max-width: 100%; width: 100%; max-height: 400px;">
                <canvas id="quadrantPie"></canvas>
            </div>
        </div>
    </div>
    }
    else
    {
        <div class="alert alert-info text-center">
            Quadrant data is not yet available for this checkpoint at @Model.School.Name.
        </div>
    }
</div>


<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const quadrantCounts = @Html.Raw(JsonSerializer.Serialize(Model.QuadrantCounts));
    const aboveCount = @Model.AboveTheLineCount;
    const belowCount = @Model.BelowTheLineCount;
    const total = @Model.TotalCount;

    const quadrantPie = new Chart(document.getElementById('quadrantPie'), {
        type: 'pie',
        data: {
            labels: [
                `Challenge (${quadrantCounts["Challenge"] || 0})`,
                `Benchmark (${quadrantCounts["Benchmark"] || 0})`,
                `Strategic (${quadrantCounts["Strategic"] || 0})`,
                `Intensive (${quadrantCounts["Intensive"] || 0})`
            ],
            datasets: [{
                data: [
                    quadrantCounts["Challenge"] || 0,
                    quadrantCounts["Benchmark"] || 0,
                    quadrantCounts["Strategic"] || 0,
                    quadrantCounts["Intensive"] || 0
                ],
                backgroundColor: ['#007bff', '#28a745', '#ffc107', '#dc3545'], // Blue, Green, Yellow, Red
                borderColor: '#fff',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                title: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.parsed;
                            const percent = ((value / total) * 100).toFixed(1);
                            return `${context.label}: ${value} (${percent}%)`;
                        }
                    }
                }
            }
        }
    });
</script>
