@page
@model ORSV2.Pages.GuidanceAlignment.GAProfileCardModel
@{
    Layout = null;
}
@functions {
    bool HasIndicator(string name) => Model.StudentIndicators.Any(i => i.Name == name);
    string GetRequirementText(string name) =>
        Model.IndicatorRequirements.FirstOrDefault(r => r.Name == name)?.RequirementText ?? "";
}

<div class="p-3">

    <!-- Mini indicator cards (Requirement text from GAMatrix.ReadableValue) -->
    <div class="row g-3">
        @foreach (var card in new[] {
            new { Name = "Attendance", Met = Model.Student.Attendance == true },
            new { Name = "GPA", Met = Model.Student.GPA == true },
            new { Name = "Affiliation", Met = Model.Student.Affiliation == true },
            new { Name = "OnTrack", Met = Model.Student.OnTrack == true },
            new { Name = "AGGrades", Met = Model.Student.AGGrades == true },
            new { Name = "AGSchedule", Met = Model.Student.AGSchedule == true },
            new { Name = "FAFSA", Met = Model.Student.FAFSA == true },
            new { Name = "CollegeApplication", Met = Model.Student.CollegeApplication == true }
        })
        {
            var req = Model.GetRequirementText(card.Name);
            <div class="col-12 col-md-6 col-lg-4">
                <div class="orenda-card shadow-orenda h-100">
                    <div class="orenda-card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <h6 class="mb-2">@card.Name</h6>
                            <span class="badge @(card.Met ? "bg-success" : "bg-danger")">
                                @(card.Met ? "Met" : "Not Met")
                            </span>
                        </div>
                        @if (!string.IsNullOrWhiteSpace(req))
                        {
                            <div class="small text-muted">@req</div>
                        }
                    </div>
                </div>
            </div>
        }
    </div>

    <!-- A–G GRADES -->
    <h5 class="mt-4 mb-2">A–G Grades</h5>

    @foreach (var grp in Model.SubjectGradesByArea)
    {
        var code = grp.SubjectCode;
        var label = Model.SubjectMap[code];
        var collapseId = $"ag-grades-{code}";
        var gt = Model.GetEarnedTarget(code, "Grades");
        var pct = GAProfileCardModel.PctVal(gt.earned, gt.target);

        <div class="orenda-card shadow-orenda mb-2">
            <div class="orenda-card-body">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <strong class="me-2">@code. @label</strong>
                    <button class="btn btn-link btn-sm text-decoration-none" type="button"
                            data-bs-toggle="collapse" data-bs-target="#@collapseId" aria-expanded="false">
                        Show details
                    </button>
                </div>

                <!-- Progress bar + Earned/Target line -->
                <div class="small text-muted mb-1">
                    Earned: <strong>@GAProfileCardModel.Fmt(gt.earned)</strong>
                    &nbsp;/&nbsp;
                    Target: <strong>@GAProfileCardModel.Fmt(gt.target)</strong>
                </div>
                <div class="progress" style="height:6px;">
                    <div class="progress-bar" role="progressbar"
                         style="width:@pct%"></div>
                </div>

                <div id="@collapseId" class="collapse mt-2">
                    @if (grp.Grades?.Any() == true)
                    {
                        <div class="table-responsive">
                            <table class="table table-sm mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Year</th><th>Term</th><th>Course</th><th>Title</th><th>Grade Lvl</th><th>Mark</th><th>Type</th><th>CC</th>
                                    </tr>
                                </thead>
                                <tbody>
                                @foreach (var g in grp.Grades)
                                {
                                    <tr>
                                        <td>@g.SchoolYear</td>
                                        <td>@g.Term</td>
                                        <td>@g.CourseNumber</td>
                                        <td>@g.Title</td>
                                        <td>@g.GradeLevel</td>
                                        <td>@g.Mark</td>
                                        <td>@g.Type</td>
                                        <td>@g.CreditsEarned</td>
                                    </tr>
                                }
                                </tbody>
                            </table>
                        </div>
                    }
                    else { <div class="text-muted small">No transcript grades.</div> }
                </div>
            </div>
        </div>
    }

    @* Non–A–G Grades inside Grades section *@
    @if (Model.NonAGGrades?.Any() == true)
    {
        <div class="orenda-card shadow-orenda mt-3">
            <div class="orenda-card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <strong>Non–A–G Grades</strong>
                    <button class="btn btn-link btn-sm text-decoration-none" type="button"
                            data-bs-toggle="collapse" data-bs-target="#nonag-grades" aria-expanded="false">
                        Show details
                    </button>
                </div>
                <div id="nonag-grades" class="collapse mt-2">
                    <div class="table-responsive">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Year</th><th>Term</th><th>Course</th><th>Title</th><th>Grade Lvl</th><th>Mark</th><th>Type</th><th>CC</th>
                                </tr>
                            </thead>
                            <tbody>
                            @foreach (var g in Model.NonAGGrades)
                            {
                                <tr>
                                    <td>@g.SchoolYear</td>
                                    <td>@g.Term</td>
                                    <td>@g.CourseNumber</td>
                                    <td>@g.Title</td>
                                    <td>@g.GradeLevel</td>
                                    <td>@g.Mark</td>
                                    <td>@g.Type</td>
                                    <td>@g.CreditsEarned</td>
                                </tr>
                            }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- A–G SCHEDULE -->
    <h5 class="mt-4 mb-2">A–G Schedule</h5>

    @foreach (var grp in Model.AGScheduleByArea)
    {
        var code = grp.SubjectCode;
        var label = Model.SubjectMap[code];
        var collapseId = $"ag-sched-{code}";
        var gt = Model.GetEarnedTarget(code, "Schedule");
        var pct = GAProfileCardModel.PctVal(gt.earned, gt.target);

        <div class="orenda-card shadow-orenda mb-2">
            <div class="orenda-card-body">
                <div class="d-flex justify-content-between align-items-center mb-1">
                    <strong class="me-2">@code. @label</strong>
                    <button class="btn btn-link btn-sm text-decoration-none" type="button"
                            data-bs-toggle="collapse" data-bs-target="#@collapseId" aria-expanded="false">
                        Show details
                    </button>
                </div>

                <!-- Progress bar + Earned/Target line -->
                <div class="small text-muted mb-1">
                    Scheduled: <strong>@GAProfileCardModel.Fmt(gt.earned)</strong>
                    &nbsp;/&nbsp;
                    Target: <strong>@GAProfileCardModel.Fmt(gt.target)</strong>
                </div>
                <div class="progress" style="height:6px;">
                    <div class="progress-bar" role="progressbar"
                         style="width:@pct%"></div>
                </div>

                <div id="@collapseId" class="collapse mt-2">
                    @if (grp.Grades?.Any() == true)
                    {
                        <ul class="mb-0 small">
                            @foreach (var c in grp.Grades.OrderBy(x => x.Term).ThenBy(x => x.Title))
                            {
                                <li><strong>@c.Term</strong> – @c.CourseNumber @c.Title <span class="text-muted">(@c.Type)</span></li>
                            }
                        </ul>
                    }
                    else { <div class="text-muted small">No scheduled courses.</div> }
                </div>
            </div>
        </div>
    }

    @* Non–A–G Schedule inside Schedule section *@
    @if (Model.NonAGSchedule?.Any() == true)
    {
        <div class="orenda-card shadow-orenda mt-3">
            <div class="orenda-card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <strong>Non–A–G Schedule</strong>
                    <button class="btn btn-link btn-sm text-decoration-none" type="button"
                            data-bs-toggle="collapse" data-bs-target="#nonag-sched" aria-expanded="false">
                        Show details
                    </button>
                </div>
                <div id="nonag-sched" class="collapse mt-2">
                    <ul class="mb-0 small">
                        @foreach (var c in Model.NonAGSchedule)
                        {
                            <li><strong>@c.Term</strong> – @c.CourseNumber @c.Title</li>
                        }
                    </ul>
                </div>
            </div>
        </div>
    }

</div>
