@page
@model ORSV2.Pages.Admin.FileImport.Assessments.LennectionsModel
@{
    ViewData["Title"] = "Lennections Import";
}

<h2 class="mb-3">Lennections Import</h2>

<form method="post" enctype="multipart/form-data">
    @Html.AntiForgeryToken()
    <div asp-validation-summary="ModelOnly" class="text-danger"></div>
    <div class="row g-3">
        <div class="col-md-3">
            <label class="form-label">District</label>
            <select asp-for="DistrictId" class="form-select" asp-items="Model.DistrictOptions"></select>
            <span class="text-danger" asp-validation-for="DistrictId"></span>
        </div>
        <div class="col-md-3">
            <label class="form-label">Subject</label>
            <input asp-for="Subject" class="form-control" placeholder="ELA / Math / Science / Social Science" />
            <span class="text-danger" asp-validation-for="Subject"></span>
        </div>
        <div class="col-md-2">
            <label class="form-label">Unit Cycle (1â€“5)</label>
            <input asp-for="UnitCycle" type="number" class="form-control" min="1" max="5" />
            <span class="text-danger" asp-validation-for="UnitCycle"></span>
        </div>
        <div class="col-md-4">
            <label class="form-label">Test Id</label>
            <input asp-for="TestId" class="form-control" placeholder="Auto-detected from first data row" />
            @if (!string.IsNullOrWhiteSpace(Model.AutoDetectedTestId))
            {
                <div class="form-text">Auto-detected: <strong>@Model.AutoDetectedTestId</strong></div>
            }
        </div>
        <div class="col-md-5">
            <label class="form-label">Upload Lennections CSV</label>
            <input asp-for="Upload" type="file" class="form-control" />
            <span class="text-danger" asp-validation-for="Upload"></span>
            <div class="form-text">Student local id must be in a column named <code>StudentId</code>.</div>
        </div>
        <div class="col-md-3">
            <label class="form-label">Delimiter</label>
            <select asp-for="Delimiter" class="form-select">
                <option value="comma">Comma (,)</option>
                <option value="tab">Tab (\t)</option>
            </select>
        </div>
        <div class="col-12">
            <button type="submit" class="btn btn-primary" asp-page-handler="Preview">Preview</button>
            @if (Model.HasPreview)
            {
                <button type="submit" class="btn btn-success" asp-page-handler="Import">Import</button>
            }
        </div>
    </div>
</form>

@if (Model.HasPreview)
{
    <hr />

    <div class="card mb-3">
        <div class="card-header">Detected Standards</div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm table-striped mb-0">
                    <thead>
                        <tr>
                            <th>Standard ID (from file)</th>
                            <th>HumanCodingScheme (from DB)</th>
                            <th>Exists in Standards?</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var p in Model.Preview)
                        {
                            <tr>
                                <td>@p.StandardId</td>
                                <td>@p.HumanCodingScheme</td>
                                <td>
                                    @if (p.ExistsInStandards) { <span class="text-success">Yes</span> }
                                    else { <span class="text-danger fw-bold">No</span> }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    @if (Model.MissingIds.Any())
    {
        <div class="alert alert-warning">
            <strong>Validation:</strong> The following Standard IDs from the file were not found in the <code>Standards</code> table:
            <div class="small mt-2">
                @string.Join(", ", Model.MissingIds.OrderBy(x => x))
            </div>
            <div class="mt-2">You can still import; rows with these Standard IDs will be skipped.</div>
        </div>
    }

    @if (!string.IsNullOrWhiteSpace(Model.StudentValidationSummary))
    {
        <div class="alert alert-info">@Model.StudentValidationSummary</div>
    }

    <form method="post" class="mb-5">
        @Html.AntiForgeryToken()
        <input type="hidden" name="TempPath" value="@Model.TempPath" />
        <input type="hidden" name="Delimiter" value="@Model.Delimiter" />
        <input type="hidden" name="DistrictId" value="@Model.DistrictId" />
        <input type="hidden" name="TestId" value="@Model.TestId" />
        <input type="hidden" name="Subject" value="@Model.Subject" />
        <input type="hidden" name="UnitCycle" value="@Model.UnitCycle" />
        <button type="submit" class="btn btn-success" asp-page-handler="Import">Import to Database</button>
    </form>
}

@* ***FIXED***: This now correctly displays the detailed success message after an import. *@
@if (TempData["ImportSuccessMessage"] is string msg)
{
    <div class="alert alert-success">
        @msg
        @if (TempData["ImportBatchId"] is string batchId && !string.IsNullOrEmpty(batchId))
        {
            <a class="ms-2" asp-page="/Admin/FileImport/Assessments/Results" asp-route-BatchId="@batchId">View results</a>
        }
    </div>
}

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}