@page
@model ORSV2.Pages.Admin.FileImport.Assessments.MasteryConnectModel
@{
    ViewData["Title"] = "MasteryConnect Import";
}

<div class="container my-4">
    <h2 class="mb-3">
        <i class="fas fa-file-upload text-primary me-2"></i>
        MasteryConnect Assessment Import
    </h2>

    <!-- Step 1: File Upload & Auto-Analysis -->
    <div class="card mb-4">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-cloud-upload-alt me-2"></i>
                Step 1: Upload & Analyze File
            </h5>
        </div>
        <div class="card-body position-relative">
            <div id="loadingOverlay" class="loading-overlay d-none">
                <div class="text-center">
                    <div class="spinner-border text-primary mb-3" role="status"></div>
                    <div>Analyzing file...</div>
                </div>
            </div>

            <form id="uploadForm" method="post" enctype="multipart/form-data" asp-page-handler="AnalyzeFile">
                @Html.AntiForgeryToken()
                
                <div class="upload-zone" id="uploadZone">
                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                    <h5>Drop your MasteryConnect CSV file here or click to browse</h5>
                    <p class="text-muted mb-3">
                        Expected format: Row 0 = Standards, Row 1 = Headers, Row 2+ = Student Data
                    </p>
                    <input asp-for="Upload" type="file" id="fileInput" class="d-none" accept=".csv">
                    <button type="button" class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-folder-open me-2"></i>
                        Choose File
                    </button>
                </div>

                <div id="fileInfo" class="mt-3 d-none">
                    <div class="alert alert-info d-flex justify-content-between align-items-center">
                        <div>
                            <i class="fas fa-file me-2"></i>
                            <strong id="fileName"></strong> 
                            (<span id="fileSize"></span>)
                        </div>
                        <button type="button" class="btn btn-sm btn-primary" id="analyzeBtn">
                            <i class="fas fa-search me-1"></i>
                            Analyze File
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Analysis Results -->
    @if (Model.AnalysisResults != null)
    {
        <div class="card mb-4" id="analysisResultsCard">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-analytics me-2"></i>
                    File Analysis Results
                    <small class="text-muted ms-2">Analyzed: @Model.AnalysisResults.AnalyzedAt.ToString("HH:mm:ss")</small>
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-info-circle me-2"></i>File Structure</h6>
                        <div class="mb-2">
                            <strong>Total Student Rows:</strong> @Model.AnalysisResults.TotalStudentRows
                        </div>
                        <div class="mb-2">
                            <strong>Question Columns:</strong> @Model.AnalysisResults.QuestionCount
                        </div>
                        <div class="mb-2">
                            <strong>Distinct Standards:</strong> @Model.AnalysisResults.DistinctStandards.Count
                        </div>
                        <div class="mb-2">
                            <strong>Assessment Name:</strong> 
                            @if (!string.IsNullOrWhiteSpace(Model.AnalysisResults.DetectedTestName))
                            {
                                <span class="text-success">@Model.AnalysisResults.DetectedTestName</span>
                            }
                            else
                            {
                                <em class="text-muted">Not detected</em>
                            }
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        @if (Model.AnalysisResults.HasStudentIdColumn)
                        {
                            <div class="alert alert-success py-2 mb-2">
                                <i class="fas fa-check me-2"></i>
                                <strong>Student ID Column Found</strong><br>
                                <small>Column: @Model.AnalysisResults.StudentIdColumnName</small>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-danger py-2 mb-2">
                                <i class="fas fa-times me-2"></i>
                                <strong>Missing student_id Column</strong><br>
                                <small>Required column not found in row 1</small>
                            </div>
                        }
                        
                        @if (Model.AnalysisResults.ValidationMessages?.Count > 0)
                        {
                            <div class="alert alert-warning py-2">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>Issues:</strong><br>
                                <small>@Html.Raw(string.Join("<br>", Model.AnalysisResults.ValidationMessages))</small>
                            </div>
                        }
                    </div>
                </div>

                @if (Model.AnalysisResults.DistinctStandards.Any())
                {
                    <div class="mt-3">
                        <h6>Standards Found in File:</h6>
                        <div class="badge-container">
                            @foreach (var std in Model.AnalysisResults.DistinctStandards.Take(20))
                            {
                                <span class="badge bg-secondary me-1 mb-1">@std</span>
                            }
                            @if (Model.AnalysisResults.DistinctStandards.Count > 20)
                            {
                                <span class="badge bg-info">+@(Model.AnalysisResults.DistinctStandards.Count - 20) more</span>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Step 2: Import Configuration -->
    <div class="card" id="configCard">
        <div class="card-header">
            <h5 class="mb-0">
                <i class="fas fa-cog me-2"></i>
                Step 2: Import Configuration
            </h5>
        </div>
        <div class="card-body">
            <form method="post" enctype="multipart/form-data" id="importForm">
                @Html.AntiForgeryToken()
                <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                
                <input type="hidden" asp-for="TempPath" />
                <input type="file" name="Upload" id="hiddenFileInput" style="display: none;" />
                
                <div class="row g-3">
                    <div class="col-md-3">
                        <div class="field-group">
                            <label asp-for="DistrictId" class="form-label">District</label>
                            <select asp-for="DistrictId" class="form-select" asp-items="Model.DistrictOptions">
                                <option value="">Select a district...</option>
                            </select>
                            <span class="text-danger" asp-validation-for="DistrictId"></span>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <div class="field-group">
                            <label asp-for="Subject" class="form-label">Subject</label>
                            <select asp-for="Subject" asp-items="Model.SubjectOptions" class="form-select"></select>
                            @if (!string.IsNullOrWhiteSpace(Model.AnalysisResults?.DetectedSubject))
                            {
                                <div class="form-text text-success">
                                    Auto-detected: <strong>@Model.AnalysisResults.DetectedSubject</strong>
                                </div>
                            }
                            <span class="text-danger" asp-validation-for="Subject"></span>
                        </div>
                    </div>

                    <div class="col-md-2">
                        <div class="field-group">
                            <label asp-for="UnitCycle" class="form-label">Unit Cycle (1-5)</label>
                            <input asp-for="UnitCycle" type="number" class="form-control" min="1" max="5" />
                            @if (Model.AnalysisResults?.DetectedUnitCycle.HasValue == true)
                            {
                                <div class="form-text text-success">
                                    Auto-detected: <strong>@Model.AnalysisResults.DetectedUnitCycle</strong>
                                </div>
                            }
                            <span class="text-danger" asp-validation-for="UnitCycle"></span>
                        </div>
                    </div>

                    <div class="col-md-4">
                        <div class="field-group">
                            <label asp-for="TestId" class="form-label">Test ID</label>
                            <input asp-for="TestId" class="form-control" placeholder="Auto-generated from file" readonly />
                            @if (!string.IsNullOrWhiteSpace(Model.AnalysisResults?.DetectedTestId))
                            {
                                <div class="form-text text-success">
                                    <strong>@Model.AnalysisResults.DetectedTestId</strong> (8-char hash)
                                </div>
                            }
                        </div>
                    </div>

                    <div class="col-12">
                        <div class="d-flex gap-2">
                            <button type="submit" class="btn btn-primary" asp-page-handler="Preview" id="previewBtn">
                                <i class="fas fa-eye me-2"></i>
                                Preview Import
                            </button>
                            @if (Model.HasPreview)
                            {
                                <button type="submit" class="btn btn-success" asp-page-handler="Import">
                                    <i class="fas fa-upload me-2"></i>
                                    Import Data
                                </button>
                            }
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Step 3: Preview Results -->
    @if (Model.HasPreview)
    {
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-table me-2"></i>
                    Preview Results
                    <span class="badge bg-secondary ms-2">@Model.Preview.Count Standards</span>
                    <span class="badge bg-info ms-2">@Model.TotalStudentStandardRecords Records</span>
                </h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Standard Code (from file)</th>
                                <th>Matched Standard ID</th>
                                <th>Questions</th>
                                <th>Students</th>
                                <th>Exists in DB?</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var p in Model.Preview.OrderBy(x => x.StandardCode))
                            {
                                <tr class="@(!p.ExistsInDatabase ? "table-warning" : "")">
                                    <td>
                                        <code class="small">@p.StandardCode</code>
                                    </td>
                                    <td>
                                        @if (p.StandardId.HasValue)
                                        {
                                            <small class="text-muted">@p.StandardId.Value.ToString().Substring(0, 8)...</small>
                                        }
                                        else if (!string.IsNullOrWhiteSpace(p.FallbackCode))
                                        {
                                            <em class="text-warning">Fallback: @p.FallbackCode</em>
                                        }
                                        else
                                        {
                                            <em class="text-muted">Not mapped</em>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge bg-primary">@p.QuestionCount</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">@p.StudentCount</span>
                                    </td>
                                    <td>
                                        @if (p.ExistsInDatabase)
                                        {
                                            <span class="text-success"><i class="fas fa-check"></i> Yes</span>
                                        }
                                        else if (!string.IsNullOrWhiteSpace(p.FallbackCode))
                                        {
                                            <span class="text-warning"><i class="fas fa-exclamation-triangle"></i> Using raw code</span>
                                        }
                                        else
                                        {
                                            <span class="text-danger"><i class="fas fa-times"></i> No</span>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        @if (Model.MissingStandards.Any())
        {
            <div class="alert alert-warning mt-3">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Warning:</strong> @Model.MissingStandards.Count standard codes could not be mapped to database IDs. 
                These will be included as raw codes in the results JSON if ALLOW_RAW_CODES_IN_RESULTS is enabled.
                <div class="small mt-2">
                    <code>@string.Join("</code>, <code>", Model.MissingStandards.Take(10))</code>
                    @if (Model.MissingStandards.Count > 10)
                    {
                        <span>... and @(Model.MissingStandards.Count - 10) more</span>
                    }
                </div>
            </div>
        }
    }

    <!-- Success Message -->
    @if (TempData["ImportSuccessMessage"] is string msg)
    {
        <div class="alert alert-success mt-4">
            <i class="fas fa-check-circle me-2"></i>
            @msg
        </div>
    }
</div>

@section Styles {
<style>
    .upload-zone {
        border: 2px dashed #dee2e6;
        border-radius: 0.375rem;
        padding: 2rem;
        text-align: center;
        background: #f8f9fa;
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .upload-zone:hover {
        border-color: #0d6efd;
        background: #e7f1ff;
    }
    .upload-zone.dragover {
        border-color: #0d6efd;
        background: #e7f1ff;
    }
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.95);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10;
        border-radius: 0.375rem;
    }
    .badge-container {
        max-height: 150px;
        overflow-y: auto;
        padding: 0.5rem;
        background: #f8f9fa;
        border-radius: 0.375rem;
    }
    code {
        font-size: 0.8em;
        padding: 0.125rem 0.25rem;
        background-color: rgba(13, 110, 253, 0.1);
        border-radius: 0.25rem;
    }
</style>
}

@section Scripts {
<partial name="_ValidationScriptsPartial" />
<script>
class MasteryConnectImporter {
    constructor() {
        this.setupEventListeners();
        this.selectedFile = null;
    }

    setupEventListeners() {
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const analyzeBtn = document.getElementById('analyzeBtn');

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('dragover');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('dragover');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('dragover');
            if (e.dataTransfer.files.length > 0) {
                this.handleFile(e.dataTransfer.files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                this.handleFile(e.target.files[0]);
            }
        });

        if (analyzeBtn) {
            analyzeBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.analyzeFile();
            });
        }
    }

    handleFile(file) {
        this.selectedFile = file;
        
        document.getElementById('fileName').textContent = file.name;
        document.getElementById('fileSize').textContent = this.formatFileSize(file.size);
        document.getElementById('fileInfo').classList.remove('d-none');
        
        const analyzeBtn = document.getElementById('analyzeBtn');
        if (analyzeBtn) {
            analyzeBtn.disabled = false;
        }
        
        const previewBtn = document.getElementById('previewBtn');
        if (previewBtn) {
            previewBtn.disabled = false;
        }
        
        this.updateFileInput(file);
    }

    updateFileInput(file) {
        const dt = new DataTransfer();
        dt.items.add(file);
        document.getElementById('fileInput').files = dt.files;
        
        const hiddenInput = document.getElementById('hiddenFileInput');
        if (hiddenInput) {
            hiddenInput.files = dt.files;
        }
    }

    async analyzeFile() {
        if (!this.selectedFile) {
            this.showError('Please select a file first.');
            return;
        }

        const loadingOverlay = document.getElementById('loadingOverlay');
        const analyzeBtn = document.getElementById('analyzeBtn');
        
        loadingOverlay.classList.remove('d-none');
        analyzeBtn.disabled = true;

        try {
            const formData = new FormData();
            formData.append('Upload', this.selectedFile);
            
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;

            const response = await fetch('?handler=AnalyzeFile', {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': token
                },
                body: formData
            });

            if (!response.ok) {
                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
            }

            const result = await response.json();

            if (result.success) {
                // Store temp path
                const tempPathInput = document.querySelector('input[name="TempPath"]');
                if (result.tempPath && tempPathInput) {
                    tempPathInput.value = result.tempPath;
                }
                
                // Populate form fields WITHOUT reloading
                if (result.analysis.detectedSubject) {
                    const subjectSelect = document.querySelector('[name="Subject"]');
                    if (subjectSelect) {
                        subjectSelect.value = result.analysis.detectedSubject;
                    }
                }
                
                if (result.analysis.detectedUnitCycle) {
                    const unitCycleInput = document.querySelector('[name="UnitCycle"]');
                    if (unitCycleInput) {
                        unitCycleInput.value = result.analysis.detectedUnitCycle;
                    }
                }
                
                if (result.analysis.detectedTestId) {
                    const testIdInput = document.querySelector('[name="TestId"]');
                    if (testIdInput) {
                        testIdInput.value = result.analysis.detectedTestId;
                    }
                }
                
                // Show success message with analysis info
                const analysisInfo = `
                    <strong>Analysis Complete!</strong><br>
                    <small>
                    • Test ID: ${result.analysis.detectedTestId || 'Not detected'}<br>
                    • Subject: ${result.analysis.detectedSubject || 'Not detected'}<br>
                    • Unit/Cycle: ${result.analysis.detectedUnitCycle || 'Not detected'}<br>
                    • Students: ${result.analysis.totalStudentRows}<br>
                    • Questions: ${result.analysis.questionCount}<br>
                    • Standards: ${result.analysis.distinctStandards?.length || 0}
                    </small>
                `;
                this.showSuccess(analysisInfo);
                
                // Enable preview button
                const previewBtn = document.getElementById('previewBtn');
                if (previewBtn) {
                    previewBtn.disabled = false;
                }
            } else {
                this.showError(result.message || 'Analysis failed');
            }
        } catch (error) {
            console.error('Analysis failed:', error);
            this.showError('Failed to analyze file: ' + error.message);
        } finally {
            loadingOverlay.classList.add('d-none');
            analyzeBtn.disabled = false;
        }
    }

    showError(message) {
        const alertHtml = `
            <div class="alert alert-danger alert-dismissible fade show mt-3" role="alert">
                <i class="fas fa-exclamation-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        const container = document.querySelector('#uploadForm .card-body');
        if (container) {
            // Remove any existing alerts
            const existingAlerts = container.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            container.insertAdjacentHTML('afterbegin', alertHtml);
        }
    }

    showSuccess(message) {
        const alertHtml = `
            <div class="alert alert-success alert-dismissible fade show mt-3" role="alert">
                <i class="fas fa-check-circle me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        const container = document.querySelector('#uploadForm .card-body');
        if (container) {
            // Remove any existing alerts
            const existingAlerts = container.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());
            
            container.insertAdjacentHTML('afterbegin', alertHtml);
        }
    }

    formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new MasteryConnectImporter();
});
</script>
}