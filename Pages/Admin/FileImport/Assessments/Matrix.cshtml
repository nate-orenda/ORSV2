@page
@model ORSV2.Pages.Admin.FileImport.Assessments.MatrixModel
@{
    ViewData["Title"] = "Assessment Matrix";
}

<div class="container my-4">
    <h2>Assessment Matrix</h2>

    <form method="get" class="row g-3 align-items-end mb-3">
        <div class="col-md-6">
            <label class="form-label">Batch Id (GUID)</label>
            <input asp-for="BatchId" class="form-control" placeholder="e.g. 5e63..."/>
        </div>
        <div class="col-md-2">
            <button class="btn btn-secondary">Load</button>
        </div>
    </form>

    @if (Model.Columns.Count > 0)
    {
        <div class="card">
            <div class="card-header">Batch @Model.BatchId</div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 70vh; overflow: auto;">
                    <table class="table table-sm table-bordered align-middle mb-0 matrix-table">
                        <thead class="table-light">
                            <tr>
                                <th class="sticky-col" rowspan="2" style="min-width: 220px;">Student Name</th>
                                <th class="sticky-col-2" rowspan="2" style="min-width: 140px;">Student Local ID</th>
                                @foreach (var col in Model.Columns)
                                {
                                    <th class="text-center">@col.Code</th>
                                }
                                <th rowspan="2" class="text-center" style="min-width: 120px;">Total Passed</th>
                            </tr>
                            <tr>
                                @* second header row: short statements *@
                                @foreach (var col in Model.Columns)
                                {
                                    <th class="small fw-normal text-muted">
                                        @col.ShortStatement
                                    </th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var row in Model.Rows)
                        {
                            <tr>
                                <td class="sticky-col">@row.StudentName</td>
                                <td class="sticky-col-2">@row.LocalId</td>
                                @for (int i = 0; i < Model.Columns.Count; i++)
                                {
                                    var val = row.Points[i];
                                    <td class="text-center">@((val.HasValue) ? val.Value.ToString("0.##") : "")</td>
                                }
                                <td class="text-center fw-semibold">@row.TotalPassed</td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    }
    else if (!string.IsNullOrWhiteSpace(Model.BatchId))
    {
        <div class="alert alert-warning mt-3">
            No standards found for this batch, or invalid Batch Id.
        </div>
    }
</div>

<style>
/* Pretty + scrollable + sticky first two columns */
.matrix-table thead th { position: sticky; top: 0; z-index: 2; }
.matrix-table .sticky-col     { position: sticky; left: 0; background: #fff; z-index: 3; }
.matrix-table .sticky-col-2   { position: sticky; left: 220px; background: #fff; z-index: 3; }
.matrix-table tbody td, .matrix-table thead th { white-space: nowrap; }
.matrix-table thead tr:nth-child(2) th { white-space: normal; max-width: 320px; }
</style>
