@page
@model ORSV2.Pages.CurriculumAlignment.Form1Model
@{
    ViewData["Title"] = "Curriculum Alignment - Form 1";
}

<div class="curriculum-alignment-container">
    <!-- Header Section -->
    <div class="ca-header mb-4">
        <h2 class="mb-2">
            <i class="bi bi-mortarboard me-2"></i>
            Curriculum Alignment Analysis
        </h2>
        <p class="text-muted mb-0">
            Analyze student assessment results by curriculum alignment factors
        </p>
    </div>

    <!-- Filter Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">
                <i class="bi bi-funnel me-2"></i>
                Filter Options
            </h5>
        </div>
        <div class="card-body">
            <form method="post" id="filterForm">
                <div class="row g-3">
                    <!-- District Filter -->
                    <div class="col-md-6 col-lg-3">
                        <label asp-for="SelectedDistrictId" class="form-label fw-bold">District</label>
                        <select asp-for="SelectedDistrictId" asp-items="Model.Districts" 
                                class="form-select" id="districtSelect" onchange="onDistrictChange()">
                        </select>
                    </div>

                    <!-- Cycle/Unit Filter -->
                    <div class="col-md-6 col-lg-3">
                        <label asp-for="SelectedCycle" class="form-label fw-bold">Cycle/Unit</label>
                        <select asp-for="SelectedCycle" asp-items="Model.Cycles" 
                                class="form-select" id="cycleSelect" onchange="onCycleChange()">
                        </select>
                    </div>

                    <!-- Test Name Filter -->
                    <div class="col-md-6 col-lg-3">
                        <label asp-for="SelectedTestName" class="form-label fw-bold">Test Name</label>
                        <select asp-for="SelectedTestName" asp-items="Model.TestNames" 
                                class="form-select" id="testNameSelect" onchange="onTestNameChange()">
                        </select>
                    </div>

                    <!-- School Filter -->
                    <div class="col-md-6 col-lg-3">
                        <label asp-for="SelectedSchoolId" class="form-label fw-bold">School</label>
                        <select asp-for="SelectedSchoolId" asp-items="Model.Schools" 
                                class="form-select" id="schoolSelect" onchange="onSchoolChange()">
                        </select>
                    </div>

                    <!-- Teacher Filter -->
                    <div class="col-md-8 col-lg-9">
                        <label asp-for="SelectedTeacherId" class="form-label fw-bold">Teacher</label>
                        <select asp-for="SelectedTeacherId" asp-items="Model.Teachers" 
                                class="form-select" id="teacherSelect">
                        </select>
                    </div>

                    <!-- Action Buttons -->
                    <div class="col-md-4 col-lg-3 d-flex align-items-end">
                        <div class="w-100">
                            <button type="submit" class="btn btn-success w-100 mb-1">
                                <i class="bi bi-search me-1"></i>
                                Apply Filters
                            </button>
                            <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                                <i class="bi bi-x-circle me-1"></i>
                                Clear
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    @if (Model.StudentResults.Any())
    {
        <!-- Summary Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <h4 class="text-primary mb-1">@Model.TotalCount</h4>
                        <p class="text-muted mb-0">Total Students</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <h4 class="text-success mb-1">@Model.SubjectCounts.Count</h4>
                        <p class="text-muted mb-0">Subject Areas</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <h4 class="text-info mb-1">@Model.QuadrantCounts.Count</h4>
                        <p class="text-muted mb-0">Quadrants</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 bg-light">
                    <div class="card-body text-center">
                        <h4 class="text-warning mb-1">@Model.ProficiencyCounts.Count</h4>
                        <p class="text-muted mb-0">Proficiency Levels</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Student Results Table -->
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-table me-2"></i>
                    Student Assessment Results
                </h5>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-primary" onclick="exportToCSV()">
                        <i class="bi bi-download me-1"></i>
                        Export CSV
                    </button>
                    <button class="btn btn-sm btn-outline-secondary" onclick="printTable()">
                        <i class="bi bi-printer me-1"></i>
                        Print
                    </button>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-container-wrapper">
                    <div class="table-scroll-container">
                        <table class="table table-hover table-striped mb-0" id="studentsTable">
                            <thead class="table-dark">
                                <tr>
                                    <th class="draggable-header" style="min-width: 150px;">Student Name</th>
                                    <th class="draggable-header" style="min-width: 120px;">Student ID</th>
                                    <th class="draggable-header" style="min-width: 100px;">Subject</th>
                                    <th class="draggable-header" style="min-width: 120px;">Test Name</th>
                                    <th class="draggable-header" style="min-width: 100px;">Unit</th>
                                    <th class="draggable-header" style="min-width: 80px;">Score</th>
                                    <th class="draggable-header" style="min-width: 100px;">Proficiency</th>
                                    <th class="draggable-header" style="min-width: 100px;">Quadrant</th>
                                    <th class="draggable-header" style="min-width: 150px;">Course</th>
                                    <th class="draggable-header" style="min-width: 150px;">Teacher</th>
                                    <th class="draggable-header" style="min-width: 120px;">Department</th>
                                    <th class="draggable-header" style="min-width: 80px;">Primary</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var student in Model.StudentResults)
                                {
                                    <tr>
                                        <td class="fw-medium">@student.FullName</td>
                                        <td class="font-monospace">@student.LocalStudentId</td>
                                        <td>
                                            <span class="badge @(student.Subject switch 
                                            {
                                                "ELA" => "bg-primary",
                                                "Math" => "bg-success", 
                                                _ => "bg-secondary"
                                            })">
                                                @student.Subject
                                            </span>
                                        </td>
                                        <td>@student.TestName</td>
                                        <td>@student.Unit</td>
                                        <td class="text-end">
                                            @if (student.Results.HasValue)
                                            {
                                                @student.Results.Value.ToString("F1")
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                        <td>
                                            <span class="badge @(student.Proficiency switch 
                                            {
                                                "Proficient" or "Advanced" => "bg-success",
                                                "Approaching" or "Developing" => "bg-warning text-dark",
                                                "Below" or "Beginning" => "bg-danger",
                                                _ => "bg-secondary"
                                            })">
                                                @(student.Proficiency ?? "-")
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge @(student.Quadrant switch 
                                            {
                                                "Challenge" => "bg-primary",
                                                "Benchmark" => "bg-success",
                                                "Strategic" => "bg-warning text-dark",
                                                "Intensive" => "bg-danger",
                                                _ => "bg-secondary"
                                            })" style="font-size: 0.7rem; padding: 2px 6px;">
                                                @(student.Quadrant ?? "-")
                                            </span>
                                        </td>
                                        <td class="text-truncate" style="max-width: 150px;" title="@student.CourseTitle">
                                            @student.CourseTitle
                                        </td>
                                        <td>@student.TeacherFullName</td>
                                        <td>@student.DepartmentName</td>
                                        <td class="text-center">
                                            @if (student.IsPrimaryTeacher)
                                            {
                                                <i class="bi bi-check-circle-fill text-success" title="Primary Teacher"></i>
                                            }
                                            else
                                            {
                                                <i class="bi bi-dash-circle text-muted" title="Secondary Teacher"></i>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    }
    else if (Model.SelectedDistrictId > 0 && !string.IsNullOrEmpty(Model.SelectedCycle) && !string.IsNullOrEmpty(Model.SelectedTestName))
    {
        <!-- No Results Message -->
        <div class="card border-0 bg-light">
            <div class="card-body text-center py-5">
                <i class="bi bi-search text-muted" style="font-size: 3rem;"></i>
                <h4 class="text-muted mt-3">No Results Found</h4>
                <p class="text-muted">
                    No student assessment results match your current filter criteria.
                    Try adjusting your filters or selecting different options.
                </p>
            </div>
        </div>
    }
    else if (!Model.Districts.Any() || Model.Districts.Count == 1)
    {
        <!-- No Districts Available Message -->
        <div class="card border-0 bg-light">
            <div class="card-body text-center py-5">
                <i class="bi bi-exclamation-triangle text-warning" style="font-size: 3rem;"></i>
                <h4 class="text-muted mt-3">No Assessment Data Available</h4>
                <p class="text-muted">
                    No districts with assessment data are available for your account.
                    Please contact your administrator if you believe this is an error.
                </p>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Loading indicator functions
        function showLoading(selectId) {
            const select = document.getElementById(selectId);
            select.innerHTML = '<option value="">Loading...</option>';
            select.disabled = true;
        }

        function hideLoading(selectId) {
            const select = document.getElementById(selectId);
            select.disabled = false;
        }

        // Enhanced error handling for AJAX calls
        async function handleApiCall(url, errorMessage) {
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error(errorMessage, error);
                // Show user-friendly error message
                alert(`${errorMessage}. Please try again or contact support if the problem persists.`);
                return [];
            }
        }

        // Cascading dropdown functions
        async function onDistrictChange() {
            const districtId = document.getElementById('districtSelect').value;
            
            if (!districtId) {
                document.getElementById('cycleSelect').innerHTML = '<option value="">Select Cycle/Unit...</option>';
                document.getElementById('testNameSelect').innerHTML = '<option value="">Select Test Name...</option>';
                document.getElementById('schoolSelect').innerHTML = '<option value="">All Schools</option>';
                document.getElementById('teacherSelect').innerHTML = '<option value="">All Teachers</option>';
                return;
            }

            // Load cycles
            showLoading('cycleSelect');
            const cycles = await handleApiCall(
                `/CurriculumAlignment/Form1?handler=Cycles&districtId=${districtId}`,
                'Error loading cycles'
            );
            
            let options = '<option value="">Select Cycle/Unit...</option>';
            cycles.forEach(cycle => {
                options += `<option value="${escapeHtml(cycle)}">${escapeHtml(cycle)}</option>`;
            });
            
            document.getElementById('cycleSelect').innerHTML = options;
            hideLoading('cycleSelect');

            // Load schools (server-side loaded, but reset selection)
            // Reset dependent dropdowns
            document.getElementById('testNameSelect').innerHTML = '<option value="">Select Test Name...</option>';
            document.getElementById('teacherSelect').innerHTML = '<option value="">All Teachers</option>';
        }

        async function onCycleChange() {
            const districtId = document.getElementById('districtSelect').value;
            const cycle = document.getElementById('cycleSelect').value;
            
            if (!districtId) return;

            showLoading('testNameSelect');
            const testNames = await handleApiCall(
                `/CurriculumAlignment/Form1?handler=TestNames&districtId=${districtId}&cycle=${encodeURIComponent(cycle)}`,
                'Error loading test names'
            );
            
            let options = '<option value="">Select Test Name...</option>';
            testNames.forEach(testName => {
                options += `<option value="${escapeHtml(testName)}">${escapeHtml(testName)}</option>`;
            });
            
            document.getElementById('testNameSelect').innerHTML = options;
            hideLoading('testNameSelect');

            // Reset teacher dropdown
            document.getElementById('teacherSelect').innerHTML = '<option value="">All Teachers</option>';
        }

        async function onTestNameChange() {
            await loadTeachers();
        }

        async function onSchoolChange() {
            await loadTeachers();
        }

        async function loadTeachers() {
            const districtId = document.getElementById('districtSelect').value;
            const cycle = document.getElementById('cycleSelect').value;
            const testName = document.getElementById('testNameSelect').value;
            const schoolId = document.getElementById('schoolSelect').value;
            
            if (!districtId || !cycle || !testName) return;

            showLoading('teacherSelect');
            
            let url = `/CurriculumAlignment/Form1?handler=Teachers&districtId=${districtId}&cycle=${encodeURIComponent(cycle)}&testName=${encodeURIComponent(testName)}`;
            if (schoolId) url += `&schoolId=${schoolId}`;
            
            const teachers = await handleApiCall(url, 'Error loading teachers');
            
            let options = '<option value="">All Teachers</option>';
            teachers.forEach(teacher => {
                options += `<option value="${teacher.id}">${escapeHtml(teacher.name)}</option>`;
            });
            
            document.getElementById('teacherSelect').innerHTML = options;
            hideLoading('teacherSelect');
        }

        // Utility functions
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function clearFilters() {
            document.getElementById('districtSelect').value = '';
            document.getElementById('cycleSelect').innerHTML = '<option value="">Select Cycle/Unit...</option>';
            document.getElementById('testNameSelect').innerHTML = '<option value="">Select Test Name...</option>';
            document.getElementById('schoolSelect').innerHTML = '<option value="">All Schools</option>';
            document.getElementById('teacherSelect').innerHTML = '<option value="">All Teachers</option>';
        }

        function exportToCSV() {
            const table = document.getElementById('studentsTable');
            const rows = Array.from(table.querySelectorAll('tr'));
            
            const csvContent = rows.map(row => {
                const cells = Array.from(row.querySelectorAll('th, td'));
                return cells.map(cell => {
                    // Clean text content and handle special characters
                    const text = cell.textContent.trim().replace(/"/g, '""');
                    return `"${text}"`;
                }).join(',');
            }).join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `curriculum_alignment_results_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function printTable() {
            const printWindow = window.open('', '_blank');
            const table = document.getElementById('studentsTable').cloneNode(true);
            
            printWindow.document.write(`
                <html>
                <head>
                    <title>Curriculum Alignment Results</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body { font-size: 10px; }
                        table { width: 100%; }
                        .badge { padding: 2px 4px; font-size: 8px; }
                        @@media print {
                            .btn { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <h3>Curriculum Alignment Results</h3>
                    <p>Generated: ${new Date().toLocaleDateString()}</p>
                    ${table.outerHTML}
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // Initialize sticky headers and other table features
        document.addEventListener('DOMContentLoaded', function() {
            initStickyHeaders();
            
            // Auto-submit form when filters change (optional)
            const autoSubmitElements = ['districtSelect', 'cycleSelect', 'testNameSelect'];
            autoSubmitElements.forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', function() {
                        // Only auto-submit if we have the minimum required filters
                        const district = document.getElementById('districtSelect').value;
                        const cycle = document.getElementById('cycleSelect').value;
                        const testName = document.getElementById('testNameSelect').value;
                        
                        if (district && cycle && testName) {
                            // Small delay to allow cascading dropdowns to update
                            setTimeout(() => {
                                document.getElementById('filterForm').submit();
                            }, 500);
                        }
                    });
                }
            });
        });

        // Enhanced sticky header functionality
        function initStickyHeaders() {
            const table = document.getElementById('studentsTable');
            if (!table) return;
            
            const thead = table.querySelector('thead');
            const scrollContainer = document.querySelector('.table-scroll-container');
            
            let isSticky = false;
            let originalColumnWidths = [];
            
            function captureColumnWidths() {
                const headerCells = thead.querySelectorAll('th');
                originalColumnWidths = Array.from(headerCells).map(th => {
                    return th.getBoundingClientRect().width;
                });
            }
            
            function applyColumnWidths() {
                const headerCells = thead.querySelectorAll('th');
                headerCells.forEach((th, index) => {
                    if (originalColumnWidths[index]) {
                        th.style.width = originalColumnWidths[index] + 'px';
                        th.style.minWidth = originalColumnWidths[index] + 'px';
                        th.style.maxWidth = originalColumnWidths[index] + 'px';
                    }
                });
            }
            
            function removeColumnWidths() {
                const headerCells = thead.querySelectorAll('th');
                headerCells.forEach(th => {
                    th.style.width = '';
                    th.style.minWidth = '';
                    th.style.maxWidth = '';
                });
            }
            
            function updateStickyHeader() {
                const tableRect = table.getBoundingClientRect();
                const shouldBeSticky = tableRect.top <= 95;
                
                if (shouldBeSticky && !isSticky) {
                    captureColumnWidths();
                    thead.classList.add('sticky-active');
                    thead.style.width = table.offsetWidth + 'px';
                    thead.style.left = tableRect.left + 'px';
                    applyColumnWidths();
                    isSticky = true;
                } else if (!shouldBeSticky && isSticky) {
                    thead.classList.remove('sticky-active');
                    thead.style.width = '';
                    thead.style.left = '';
                    removeColumnWidths();
                    isSticky = false;
                }
            }
            
            // Event listeners
            window.addEventListener('scroll', updateStickyHeader);
            window.addEventListener('resize', () => {
                if (isSticky) {
                    removeColumnWidths();
                    isSticky = false;
                    setTimeout(updateStickyHeader, 50);
                }
            });
        }
    </script>
}