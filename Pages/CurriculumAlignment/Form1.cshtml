@page
@model ORSV2.Pages.CurriculumAlignment.Form1Model
@{
    ViewData["Title"] = "DRS Form 1";
    // Group the rows by Teacher and then by Period for display
    var groupedRows = Model.Rows.GroupBy(r => r.TeacherName).Select(g => new 
    {
        TeacherName = g.Key,
        Periods = g.GroupBy(p => p.Period).Select(pGroup => new 
        {
            Period = pGroup.Key,
            Students = pGroup.ToList()
        }).OrderBy(p => p.Period)
    }).OrderBy(t => t.TeacherName);
}

<div class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="mb-0">DRS Form 1</h2>
    </div>

    <!-- Main Filter Form -->
    <div class="orenda-card mb-4">
        <div class="orenda-card-body">
            <h5 class="mb-3">Filters</h5>
            <form id="filterForm" method="get" class="row g-3 align-items-end">
                <input type="hidden" asp-for="DistrictId" />
                @if (Model.AvailableUnitCycles.Any())
                {
                    <div class="col-md-2">
                        <label asp-for="UnitCycle" class="form-label fw-semibold">Unit / Cycle</label>
                        <select asp-for="UnitCycle" asp-items="Model.AvailableUnitCycles" class="form-select" onchange="this.form.submit()"></select>
                    </div>
                }
                @if (Model.AvailableBatches.Any())
                {
                    <div class="col-md-3">
                        <label asp-for="BatchId" class="form-label fw-semibold">Assessment</label>
                        <select asp-for="BatchId" asp-items="Model.AvailableBatches" class="form-select" onchange="this.form.submit()"></select>
                    </div>
                }
                @if (Model.AvailableSchools.Any())
                {
                    <div class="col-md-3">
                        <label asp-for="SchoolId" class="form-label fw-semibold">School</label>
                        <select asp-for="SchoolId" asp-items="Model.AvailableSchools" class="form-select" onchange="this.form.submit()"></select>
                    </div>
                }
                @if (Model.AvailableTeachers.Any())
                {
                    <div class="col-md-2">
                        <label asp-for="TeacherId" class="form-label fw-semibold">Teacher</label>
                        <select asp-for="TeacherId" asp-items="Model.AvailableTeachers" class="form-select" onchange="this.form.submit()"></select>
                    </div>
                }
                <div class="col-md-2">
                    <label class="form-label">&nbsp;</label>
                    <button class="btn btn-orenda w-100">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </form>
        </div>
    </div>

    @if (Model.Rows.Any())
    {
        <div class="orenda-card">
            <div class="p-3 border-bottom" style="background-color: #f8f9fb;">
                <h5 class="mb-0 fw-semibold">Assessment: <span class="fw-normal text-muted">@Model.AvailableBatches.FirstOrDefault(b => b.Value == Model.BatchId)?.Text</span></h5>
            </div>
            <div class="table-responsive">
                <table class="orenda-table matrix-table mb-0">
                    <thead>
                        <tr>
                            <th class="sticky-col" rowspan="2" style="min-width: 220px;">Student Name</th>
                            <th class="sticky-col-2" rowspan="2" style="min-width: 140px;">Student Local ID</th>
                            @foreach (var col in Model.Columns)
                            {
                                <th class="text-center">@col.Code</th>
                            }
                            <th rowspan="2" class="text-center" style="min-width: 120px;">Total Passed</th>
                        </tr>
                        <tr>
                            @foreach (var col in Model.Columns)
                            {
                                <th class="fw-normal text-muted">@col.ShortStatement</th>
                            }
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var teacherGroup in groupedRows)
                    {
                        <tr class="group-header">
                            <td colspan="@(Model.Columns.Count + 3)">
                                <strong>Teacher:</strong> @teacherGroup.TeacherName
                            </td>
                        </tr>
                        @foreach (var periodGroup in teacherGroup.Periods)
                        {
                            <tr class="group-header period-header">
                                <td colspan="@(Model.Columns.Count + 3)">
                                    <strong>Period:</strong> @periodGroup.Period
                                </td>
                            </tr>
                            @foreach (var row in periodGroup.Students)
                            {
                                <tr>
                                    <td class="sticky-col fw-medium">@row.StudentName</td>
                                    <td class="sticky-col-2">@row.LocalId</td>
                                    @for (int i = 0; i < Model.Columns.Count; i++)
                                    {
                                        var val = row.Points[i];
                                        <td class="text-center">@((val.HasValue) ? val.Value.ToString("0.##") : "")</td>
                                    }
                                    <td class="text-center fw-bold text-orenda-primary">@row.TotalPassed</td>
                                </tr>
                            }
                        }
                    }
                    </tbody>
                </table>
            </div>
        </div>
    }
    else if (Model.SchoolId.HasValue) // Show message if a school was selected but no rows were found
    {
        <div class="alert alert-warning mt-3">
            No results found for the selected filters.
        </div>
    }
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

<style>
.matrix-table { font-size: 0.875rem; }
.table-responsive { overflow-x: auto; }
.matrix-table thead th { position: sticky; top: 0; z-index: 2; }
.matrix-table thead tr:nth-child(2) th { top: 48px; }
.matrix-table .sticky-col, .matrix-table .sticky-col-2 { position: sticky; left: 0; background-color: #fff; z-index: 1; }
.matrix-table .sticky-col-2 { left: 220px; }
.matrix-table thead .sticky-col, .matrix-table thead .sticky-col-2 { z-index: 3; }
.matrix-table tbody tr:hover .sticky-col, .matrix-table tbody tr:hover .sticky-col-2 { background-color: #f8f9ff; }
.matrix-table tbody td, .matrix-table thead th { white-space: nowrap; }
.matrix-table thead tr:nth-child(2) th { white-space: normal; max-width: 320px; vertical-align: top; font-size: 0.7rem; line-height: 1.3; }
.group-header td { background-color: #e9ecef; font-weight: bold; padding: 0.5rem 1rem; position: sticky; left: 0; }
.period-header td { background-color: #f8f9fa; padding-left: 2rem; }
</style>