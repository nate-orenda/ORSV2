@page
@model ORSV2.Pages.CurriculumAlignment.Form1Model
@{
    ViewData["Title"] = "Student Assessment Results";
}

<div class="form1-container">
    <!-- Header Section -->
    <div class="form1-header">
        <h1 class="mb-0">
            <i class="fas fa-chart-line me-2"></i>
            Student Assessment Results
        </h1>
        <p class="mb-0">Analyze and filter student performance data</p>
    </div>

    <!-- Filter Section -->
    <div class="form1-card">
        <div class="form1-card-header">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>
                Filter Options
            </h5>
        </div>
        <div class="form1-card-body">
            <form method="post" id="filterForm">
                <div class="row g-3">
                    <!-- District Filter -->
                    <div class="col-md-6 col-lg-3">
                        <label asp-for="SelectedDistrictId" class="form-label fw-semibold">
                            <i class="fas fa-building me-1"></i>District
                        </label>
                        <select asp-for="SelectedDistrictId" asp-items="Model.Districts" 
                                class="form-select" id="districtSelect" onchange="onDistrictChange()">
                        </select>
                    </div>

                    <!-- Cycle/Unit Filter -->
                    <div class="col-md-6 col-lg-3">
                        <label asp-for="SelectedCycle" class="form-label fw-semibold">
                            <i class="fas fa-layer-group me-1"></i>Unit
                        </label>
                        <select asp-for="SelectedCycle" asp-items="Model.Cycles" 
                                class="form-select" id="cycleSelect" onchange="onCycleChange()">
                        </select>
                    </div>

                    <!-- Test Name Filter -->
                    <div class="col-md-6 col-lg-3">
                        <label asp-for="SelectedTestName" class="form-label fw-semibold">
                            <i class="fas fa-clipboard-check me-1"></i>Test Name
                        </label>
                        <select asp-for="SelectedTestName" asp-items="Model.TestNames" 
                                class="form-select" id="testNameSelect" onchange="onTestNameChange()">
                        </select>
                    </div>

                    <!-- School Filter -->
                    <div class="col-md-6 col-lg-3">
                        <label asp-for="SelectedSchoolId" class="form-label fw-semibold">
                            <i class="fas fa-school me-1"></i>School
                        </label>
                        <select asp-for="SelectedSchoolId" asp-items="Model.Schools" 
                                class="form-select" id="schoolSelect" onchange="onSchoolChange()">
                        </select>
                    </div>
                </div>

                <div class="row g-3 mt-2">
                    <!-- Teacher Filter -->
                    <div class="col-md-8 col-lg-9">
                        <label asp-for="SelectedTeacherId" class="form-label fw-semibold">
                            <i class="fas fa-user-graduate me-1"></i>Teacher
                        </label>
                        <select asp-for="SelectedTeacherId" asp-items="Model.Teachers" 
                                class="form-select" id="teacherSelect">
                        </select>
                    </div>

                    <!-- Action Buttons -->
                    <div class="col-md-4 col-lg-3 d-flex align-items-end">
                        <div class="w-100">
                            <button type="button" class="form1-btn-secondary w-100" onclick="clearFilters()">
                                <i class="fas fa-times me-1"></i>Clear Filters
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading indicator -->
                <div class="form1-loading" id="loadingIndicator">
                    <div class="form1-spinner"></div>
                    <div class="mt-2">Loading data...</div>
                </div>
            </form>
        </div>
    </div>

    <!-- Results Section -->
    <div class="form1-card">
        <div class="form1-card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">
                <i class="fas fa-table me-2"></i>Student Results
            </h5>
            <div class="d-flex gap-2">
                <span id="resultsCount" class="text-light">No results to display</span>
                <button type="button" class="btn btn-success btn-sm no-print" onclick="exportToExcel()">
                    <i class="fas fa-file-excel me-1"></i>Excel
                </button>
                <button type="button" class="btn btn-info btn-sm no-print" onclick="exportToCsv()">
                    <i class="fas fa-file-csv me-1"></i>CSV
                </button>
                <button type="button" class="btn btn-secondary btn-sm no-print" onclick="window.print()">
                    <i class="fas fa-print me-1"></i>Print
                </button>
            </div>
        </div>
        <div class="form1-card-body p-0">
            <div id="resultsContainer">
                <div class="text-center py-5">
                    <i class="fas fa-filter fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Select Filters to View Data</h5>
                    <p class="text-muted">Please select District and Test Name above to load student assessment results.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Include the CSS from the previous artifact -->
<style>
.form1-container {
    max-width: 100%;
    margin: 0 auto;
    padding: 1rem;
}

.form1-header {
    background: linear-gradient(135deg, #0022C5, #1a4fb8);
    color: white;
    padding: 2rem;
    border-radius: 0.5rem;
    margin-bottom: 1.5rem;
}

.form1-header h1 {
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.form1-header p {
    margin-bottom: 0;
    opacity: 0.9;
}

.form1-card {
    background: white;
    border-radius: 0.5rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    border: 1px solid #dee2e6;
    margin-bottom: 1.5rem;
}

.form1-card-header {
    background: linear-gradient(135deg, #0022C5 0%, #1a4fb8 100%);
    color: white;
    padding: 1rem 1.5rem;
    border-bottom: none;
    border-radius: 0.5rem 0.5rem 0 0;
}

.form1-card-body {
    padding: 1.5rem;
}

.form1-btn-secondary {
    background: #6c757d;
    border: none;
    border-radius: 0.375rem;
    padding: 0.5rem 1rem;
    color: white;
    font-weight: 500;
    transition: all 0.2s ease;
}

.form1-btn-secondary:hover {
    background: #5a6268;
    transform: translateY(-1px);
    color: white;
}

.form1-loading {
    display: none;
    text-align: center;
    padding: 2rem;
    color: #6c757d;
}

.form1-loading.show {
    display: block;
}

.form1-spinner {
    display: inline-block;
    width: 2rem;
    height: 2rem;
    border: 0.25em solid #f3f3f3;
    border-top: 0.25em solid #0022C5;
    border-radius: 50%;
    animation: form1-spin 1s linear infinite;
}

@@keyframes form1-spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.form1-table-wrapper {
    border-radius: 0.5rem;
    overflow: hidden;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    background: white;
}

.form1-table-scroll {
    overflow-x: auto;
    max-height: 600px;
    overflow-y: auto;
}

.form1-results-table {
    width: 100%;
    margin-bottom: 0;
    font-size: 0.875rem;
    border-collapse: collapse;
}

.form1-results-table th {
    background: linear-gradient(135deg, #343a40 0%, #495057 100%);
    color: white;
    font-weight: 600;
    padding: 0.75rem 0.5rem;
    border: none;
    text-align: left;
    white-space: nowrap;
    position: sticky;
    top: 0;
    z-index: 10;
}

.form1-results-table td {
    padding: 0.75rem 0.5rem;
    border-bottom: 1px solid #e9ecef;
    white-space: nowrap;
    vertical-align: middle;
}

.form1-results-table tbody tr:hover {
    background-color: #f8f9fa;
}

.form1-badge {
    font-size: 0.75em;
    padding: 0.35em 0.65em;
    border-radius: 0.25rem;
    font-weight: 500;
    text-align: center;
    white-space: nowrap;
    display: inline-block;
}

.form1-badge-primary { background-color: #0d6efd; color: white; }
.form1-badge-success { background-color: #198754; color: white; }
.form1-badge-warning { background-color: #ffc107; color: #000; }
.form1-badge-danger { background-color: #dc3545; color: white; }
.form1-badge-secondary { background-color: #6c757d; color: white; }

.form1-alert {
    padding: 0.75rem 1rem;
    margin-bottom: 1rem;
    border: 1px solid transparent;
    border-radius: 0.375rem;
}

.form1-alert-danger {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
}

@@media (max-width: 768px) {
    .form1-container { padding: 0.5rem; }
    .form1-header { padding: 1rem; text-align: center; }
    .form1-card-body { padding: 1rem; }
    .form1-results-table { font-size: 0.75rem; }
    .mobile-hide { display: none; }
}
</style>

@section Scripts {
<script>
// Complete JavaScript for Form1 cascading dropdowns and results

function onDistrictChange() {
    const districtId = document.getElementById('districtSelect').value;
    
    // Clear dependent dropdowns
    clearDropdown('cycleSelect', 'Select Unit...');
    clearDropdown('testNameSelect', 'Select Test...');
    clearDropdown('schoolSelect', 'All Schools');
    clearDropdown('teacherSelect', 'All Teachers');
    clearResults();
    
    if (!districtId) return;
    
    showLoading(true);
    
    // Load cycles for selected district
    fetch(`/CurriculumAlignment/Form1?handler=Cycles&districtId=${districtId}`)
        .then(response => response.json())
        .then(data => {
            populateDropdown('cycleSelect', data, 'Select Unit...');
        })
        .catch(error => {
            console.error('Error loading cycles:', error);
            showError('Failed to load units');
        })
        .finally(() => {
            showLoading(false);
        });
}

function onCycleChange() {
    const districtId = document.getElementById('districtSelect').value;
    const cycle = document.getElementById('cycleSelect').value;
    
    // Clear dependent dropdowns
    clearDropdown('testNameSelect', 'Select Test...');
    clearDropdown('schoolSelect', 'All Schools');
    clearDropdown('teacherSelect', 'All Teachers');
    clearResults();
    
    if (!districtId || !cycle) return;
    
    showLoading(true);
    
    // Load test names for selected district and cycle
    fetch(`/CurriculumAlignment/Form1?handler=TestNames&districtId=${districtId}&cycle=${cycle}`)
        .then(response => response.json())
        .then(data => {
            populateDropdown('testNameSelect', data, 'Select Test...');
        })
        .catch(error => {
            console.error('Error loading test names:', error);
            showError('Failed to load test names');
        })
        .finally(() => {
            showLoading(false);
        });
}

function onTestNameChange() {
    const districtId = document.getElementById('districtSelect').value;
    const testId = document.getElementById('testNameSelect').value;
    
    // Clear dependent dropdowns
    clearDropdown('schoolSelect', 'All Schools');
    clearDropdown('teacherSelect', 'All Teachers');
    clearResults();
    
    if (!districtId || !testId) return;
    
    showLoading(true);
    
    // Load schools AND teachers for the selected test, then show results
    Promise.all([
        fetch(`/CurriculumAlignment/Form1?handler=Schools&districtId=${districtId}&testId=${testId}`),
        fetch(`/CurriculumAlignment/Form1?handler=Teachers&districtId=${districtId}&testId=${testId}`)
    ])
    .then(responses => Promise.all(responses.map(r => r.json())))
    .then(([schoolsData, teachersData]) => {
        // Populate schools dropdown
        populateDropdown('schoolSelect', schoolsData, 'All Schools');
        
        // Populate teachers dropdown (from all schools for this test)
        populateDropdown('teacherSelect', teachersData, 'All Teachers');
        
        // Automatically load results since we have enough filters
        loadResultsDirectly();
    })
    .catch(error => {
        console.error('Error loading schools and teachers:', error);
        showError('Failed to load schools and teachers');
    })
    .finally(() => {
        showLoading(false);
    });
}

function onSchoolChange() {
    const districtId = document.getElementById('districtSelect').value;
    const testId = document.getElementById('testNameSelect').value;
    const schoolId = document.getElementById('schoolSelect').value;
    
    if (!districtId || !testId) return;
    
    if (schoolId) {
        // School selected - filter teachers for this specific school
        showLoading(true);
        
        fetch(`/CurriculumAlignment/Form1?handler=Teachers&districtId=${districtId}&testId=${testId}&schoolId=${schoolId}`)
            .then(response => response.json())
            .then(data => {
                populateDropdown('teacherSelect', data, 'All Teachers');
            })
            .catch(error => {
                console.error('Error loading teachers for school:', error);
                showError('Failed to load teachers for selected school');
            })
            .finally(() => {
                showLoading(false);
            });
    } else {
        // "All Schools" selected - reload all teachers for the test
        fetch(`/CurriculumAlignment/Form1?handler=Teachers&districtId=${districtId}&testId=${testId}`)
            .then(response => response.json())
            .then(data => {
                populateDropdown('teacherSelect', data, 'All Teachers');
            })
            .catch(error => {
                console.error('Error loading all teachers:', error);
            });
    }
    
    // Auto-refresh results when school changes
    loadResultsDirectly();
}

function onTeacherChange() {
    // Auto-refresh results when teacher changes
    loadResultsDirectly();
}

// Load results without form submission
function loadResultsDirectly() {
    const districtId = document.getElementById('districtSelect').value;
    const testId = document.getElementById('testNameSelect').value;
    const schoolId = document.getElementById('schoolSelect').value || null;
    const teacherId = document.getElementById('teacherSelect').value || null;

    if (!districtId || !testId) {
        showNoResults('Please select District and Test Name to view results.');
        return;
    }

    showLoading(true);
    
    const params = new URLSearchParams({
        districtId,
        testId
    });
    
    if (schoolId) params.append('schoolId', schoolId);
    if (teacherId) params.append('teacherId', teacherId);

    fetch(`/CurriculumAlignment/Form1?handler=StudentResults&${params}`)
        .then(response => response.json())
        .then(data => {
            displayResults(data);
            updateResultsInfo(data);
        })
        .catch(error => {
            console.error('Error loading student results:', error);
            showError('Failed to load student results');
        })
        .finally(() => {
            showLoading(false);
        });
}

function displayResults(data) {
    const container = document.getElementById('resultsContainer');
    
    if (!data || !data.length) {
        showNoResults('No student results found for the selected filters.');
        return;
    }

    // Create table HTML
    const tableHTML = `
        <div class="form1-table-wrapper">
            <div class="form1-table-scroll">
                <table class="form1-results-table">
                    <thead>
                        <tr>
                            <th>Student ID</th>
                            <th>Student Name</th>
                            <th>Test</th>
                            <th>Subject</th>
                            <th>Score</th>
                            <th>Proficiency</th>
                            <th>Quadrant</th>
                            <th class="mobile-hide">Course</th>
                            <th class="mobile-hide">Teacher</th>
                            <th class="mobile-hide">Department</th>
                            <th class="mobile-hide">Primary</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(student => `
                            <tr>
                                <td>${student.LocalStudentId || ''}</td>
                                <td class="fw-medium">${student.LastName}, ${student.FirstName}</td>
                                <td>${student.TestName || ''}</td>
                                <td>
                                    <span class="form1-badge ${getSubjectBadgeClass(student.Subject)}">
                                        ${student.Subject || ''}
                                    </span>
                                </td>
                                <td>${student.Results ? student.Results.toFixed(1) : '-'}</td>
                                <td>
                                    <span class="form1-badge ${getProficiencyBadgeClass(student.Proficiency)}">
                                        ${student.Proficiency || ''}
                                    </span>
                                </td>
                                <td>
                                    <span class="form1-badge ${getQuadrantBadgeClass(student.Quadrant)}">
                                        ${student.Quadrant || ''}
                                    </span>
                                </td>
                                <td class="mobile-hide">${student.CourseTitle || ''}</td>
                                <td class="mobile-hide">${student.TeacherLastName}, ${student.TeacherFirstName}</td>
                                <td class="mobile-hide">${student.DepartmentName || ''}</td>
                                <td class="mobile-hide">
                                    ${student.IsPrimaryTeacher ? 
                                        '<i class="fas fa-check text-success"></i>' : 
                                        '<i class="fas fa-times text-muted"></i>'
                                    }
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;

    container.innerHTML = tableHTML;
}

function updateResultsInfo(data) {
    const countElement = document.getElementById('resultsCount');
    if (countElement) {
        countElement.textContent = `Showing ${data.length} student results`;
    }

    // Update summary stats if they exist
    updateSummaryStats(data);
}

function updateSummaryStats(data) {
    // Update total count
    const totalElement = document.querySelector('.form1-stats-number');
    if (totalElement) {
        totalElement.textContent = data.length;
    }

    // Update proficient count
    const proficientCount = data.filter(s => 
        s.Proficiency === 'Proficient' || s.Proficiency === 'Advanced'
    ).length;
    const proficientElements = document.querySelectorAll('.form1-stats-number');
    if (proficientElements[1]) {
        proficientElements[1].textContent = proficientCount;
    }

    // Update average score
    const scoresWithValues = data.filter(s => s.Results && s.Results > 0);
    const avgScore = scoresWithValues.length > 0 
        ? (scoresWithValues.reduce((sum, s) => sum + s.Results, 0) / scoresWithValues.length).toFixed(1)
        : 'N/A';
    if (proficientElements[2]) {
        proficientElements[2].textContent = avgScore;
    }

    // Update subject count
    const subjectCount = [...new Set(data.map(s => s.Subject))].length;
    if (proficientElements[3]) {
        proficientElements[3].textContent = subjectCount;
    }
}

function showNoResults(message) {
    const container = document.getElementById('resultsContainer');
    if (container) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No Results</h5>
                <p class="text-muted">${message}</p>
            </div>
        `;
    }
    
    const countElement = document.getElementById('resultsCount');
    if (countElement) {
        countElement.textContent = 'No results to display';
    }
}

function clearResults() {
    const container = document.getElementById('resultsContainer');
    if (container) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-filter fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">Select Filters to View Data</h5>
                <p class="text-muted">Please select District and Test Name above to load student assessment results.</p>
            </div>
        `;
    }
    
    const countElement = document.getElementById('resultsCount');
    if (countElement) {
        countElement.textContent = 'No results to display';
    }
}

function showLoading(show) {
    const spinner = document.getElementById('loadingIndicator');
    if (spinner) {
        spinner.style.display = show ? 'block' : 'none';
    }
}

function clearDropdown(selectId, placeholder) {
    const select = document.getElementById(selectId);
    if (select) {
        select.innerHTML = `<option value="">${placeholder}</option>`;
    }
}

function populateDropdown(selectId, items, placeholder) {
    const select = document.getElementById(selectId);
    if (select) {
        select.innerHTML = `<option value="">${placeholder}</option>`;
        
        items.forEach(item => {
            const option = document.createElement('option');
            option.value = item.value;
            option.textContent = item.text;
            select.appendChild(option);
        });
    }
}

function clearFilters() {
    // Reset all dropdowns
    const districtSelect = document.getElementById('districtSelect');
    if (districtSelect) districtSelect.value = '';
    
    clearDropdown('cycleSelect', 'Select Unit...');
    clearDropdown('testNameSelect', 'Select Test...');
    clearDropdown('schoolSelect', 'All Schools');
    clearDropdown('teacherSelect', 'All Teachers');
    
    // Clear results
    clearResults();
    
    // Clear any error messages
    const errorMessages = document.querySelectorAll('.form1-alert-danger');
    errorMessages.forEach(msg => msg.remove());
}

function showError(message) {
    // Remove existing error messages
    const existingErrors = document.querySelectorAll('.form1-alert-danger');
    existingErrors.forEach(error => error.remove());
    
    // Create new error message
    const alert = document.createElement('div');
    alert.className = 'form1-alert form1-alert-danger mt-3';
    alert.innerHTML = `
        <i class="fas fa-exclamation-circle me-2"></i>${message}
        <button type="button" class="btn-close float-end" onclick="this.parentElement.remove()"></button>
    `;
    
    // Insert at top of container
    const container = document.querySelector('.form1-container');
    if (container) {
        container.insertBefore(alert, container.firstChild);
    }
}

// Helper functions for badge classes
function getSubjectBadgeClass(subject) {
    switch(subject) {
        case 'ELA': return 'form1-badge-primary';
        case 'Math': return 'form1-badge-success';
        default: return 'form1-badge-secondary';
    }
}

function getProficiencyBadgeClass(proficiency) {
    switch(proficiency) {
        case 'Proficient':
        case 'Advanced': return 'form1-badge-success';
        case 'Approaching':
        case 'Developing': return 'form1-badge-warning';
        case 'Below':
        case 'Beginning': return 'form1-badge-danger';
        default: return 'form1-badge-secondary';
    }
}

function getQuadrantBadgeClass(quadrant) {
    switch(quadrant) {
        case 'Challenge': return 'form1-badge-primary';
        case 'Benchmark': return 'form1-badge-success';
        case 'Strategic': return 'form1-badge-warning';
        case 'Intensive': return 'form1-badge-danger';
        default: return 'form1-badge-secondary';
    }
}

// Export functions (placeholder - implement server-side export)
function exportToExcel() {
    const districtId = document.getElementById('districtSelect').value;
    const testId = document.getElementById('testNameSelect').value;
    const schoolId = document.getElementById('schoolSelect').value || '';
    const teacherId = document.getElementById('teacherSelect').value || '';
    
    if (!districtId || !testId) {
        showError('Please select filters before exporting');
        return;
    }
    
    const params = new URLSearchParams({
        districtId,
        testId,
        schoolId,
        teacherId,
        format: 'excel'
    });
    
    // This would call a server export endpoint
    window.open(`/CurriculumAlignment/Form1?handler=Export&${params}`, '_blank');
}

function exportToCsv() {
    const districtId = document.getElementById('districtSelect').value;
    const testId = document.getElementById('testNameSelect').value;
    const schoolId = document.getElementById('schoolSelect').value || '';
    const teacherId = document.getElementById('teacherSelect').value || '';
    
    if (!districtId || !testId) {
        showError('Please select filters before exporting');
        return;
    }
    
    const params = new URLSearchParams({
        districtId,
        testId,
        schoolId,
        teacherId,
        format: 'csv'
    });
    
    // This would call a server export endpoint
    window.open(`/CurriculumAlignment/Form1?handler=Export&${params}`, '_blank');
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('Form1 JavaScript loaded successfully');
    
    // Add onchange event to teacher select if it exists
    const teacherSelect = document.getElementById('teacherSelect');
    if (teacherSelect) {
        teacherSelect.addEventListener('change', onTeacherChange);
    }
});
</script>
}