@page
@model ORSV2.Pages.CurriculumAlignment.Form1Model
@{
    ViewData["Title"] = "Student Assessment Results";
}

<div class="form1-container">
    <div class="form1-header">
        <h1 class="mb-0">
            <i class="fas fa-chart-line me-2"></i>
            Student Assessment Results
        </h1>
        <p class="mb-0">Select filters to view a list of students.</p>
    </div>

    <div class="form1-card">
        <div class="form1-card-header">
            <h5 class="mb-0">
                <i class="fas fa-filter me-2"></i>
                Filter Options
            </h5>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label asp-for="SelectedDistrictId" class="form-label fw-semibold">District</label>
                    <select asp-for="SelectedDistrictId" asp-items="Model.Districts" class="form-select" id="districtSelect">
                        <option value="">-- Select District --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label asp-for="SelectedUnit" class="form-label fw-semibold">Unit</label>
                    <select asp-for="SelectedUnit" asp-items="Model.Units" class="form-select" id="unitSelect" disabled>
                        <option value="">-- Select Unit --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label asp-for="SelectedTestId" class="form-label fw-semibold">Test Name</label>
                    <select asp-for="SelectedTestId" asp-items="Model.TestNames" class="form-select" id="testIdSelect" disabled>
                        <option value="">-- Select Test --</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label asp-for="SelectedSchoolId" class="form-label fw-semibold">School</label>
                    <select asp-for="SelectedSchoolId" asp-items="Model.Schools" class="form-select" id="schoolSelect" disabled>
                        <option value="">-- Select School --</option>
                    </select>
                </div>
            </div>
            <div class="row g-3 mt-3">
                 <div class="col-md-6">
                    <label asp-for="SelectedTeacherId" class="form-label fw-semibold">Teacher</label>
                    <select asp-for="SelectedTeacherId" asp-items="Model.Teachers" class="form-select" id="teacherSelect" disabled>
                        <option value="">-- All Teachers --</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <div class="form1-card">
        <div class="form1-card-header">
             <h5 class="mb-0">
                <i class="fas fa-users me-2"></i>
                Student Results
            </h5>
        </div>
        <div class="card-body">
            <div id="resultsContainer">
                <p class="text-muted">Please make a selection to view student data.</p>
            </div>
            <div class="loading-spinner" id="loadingIndicator">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <div class="mt-2 text-muted">Loading...</div>
            </div>
        </div>
    </div>
</div>

<style>
    .form1-container { max-width: 100%; margin: 0 auto; padding: 1rem; }
    .form1-header { background: linear-gradient(135deg, #0022C5, #1a4fb8); color: white; padding: 2rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
    .form1-header h1 { margin-bottom: 0.5rem; font-weight: 600; }
    .form1-header p { margin-bottom: 0; opacity: 0.9; }
    .form1-card { background: white; border-radius: 0.5rem; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); border: 1px solid #dee2e6; margin-bottom: 1.5rem; }
    .form1-card-header { background-color: #f8f9fa; color: #212529; padding: 1rem 1.5rem; border-bottom: 1px solid #dee2e6; border-radius: 0.5rem 0.5rem 0 0; }
    .form1-card-header h5 { font-weight: 600; }
    .card-body { padding: 1.5rem; }
    .loading-spinner { display: none; text-align: center; padding: 2rem; }
</style>

@section Scripts {
<script>
document.addEventListener('DOMContentLoaded', function () {
    const districtSelect = document.getElementById('districtSelect');
    const unitSelect = document.getElementById('unitSelect');
    const testIdSelect = document.getElementById('testIdSelect');
    const schoolSelect = document.getElementById('schoolSelect');
    const teacherSelect = document.getElementById('teacherSelect');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const resultsContainer = document.getElementById('resultsContainer');

    function fetchAndPopulate(url, selectElement, placeholder) {
        showLoading(true);
        return fetch(url)
            .then(response => {
                if(response.status === 403) {
                    alert("You are not authorized to view this data.");
                    return Promise.reject("Forbidden");
                }
                return response.json();
            })
            .then(data => {
                resetSelect(selectElement, placeholder);
                data.forEach(item => {
                    selectElement.add(new Option(item.text, item.value));
                });
                selectElement.disabled = false;
                showLoading(false);
            })
            .catch(error => {
                console.error("Fetch Error:", error);
                showLoading(false);
            });
    }

    function loadStudentResults() {
        const districtId = districtSelect.value;
        const testId = testIdSelect.value;
        const schoolId = schoolSelect.value;
        const teacherId = teacherSelect.value;

        // Only fetch if we have the main filters up to the school level
        if (!districtId || !testId || !schoolId) {
            resultsContainer.innerHTML = '<p class="text-muted">Please select a District, Unit, Test, and School to see results.</p>';
            return;
        }

        showLoading(true);
        let url = `/CurriculumAlignment/Form1?handler=StudentResults&districtId=${districtId}&testId=${testId}&schoolId=${schoolId}`;
        if (teacherId) url += `&teacherId=${teacherId}`;
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                if (!data || data.length === 0) {
                    resultsContainer.innerHTML = '<p class="text-muted">No students found for the current selection.</p>';
                } else {
                    let listHtml = `<p><strong>Showing ${data.length} students:</strong></p><ul class="list-group">`;
                    data.forEach(student => {
                        listHtml += `<li class="list-group-item">${student.fullName}</li>`;
                    });
                    listHtml += '</ul>';
                    resultsContainer.innerHTML = listHtml;
                }
                showLoading(false);
            });
    }

    districtSelect.addEventListener('change', function () {
        const districtId = this.value;
        resetSelect(unitSelect, '-- Select Unit --', true);
        resetSelect(testIdSelect, '-- Select Test --', true);
        resetSelect(schoolSelect, '-- Select School --', true);
        resetSelect(teacherSelect, '-- All Teachers --', true);
        clearResults();
        if (districtId) {
            fetchAndPopulate(`/CurriculumAlignment/Form1?handler=Units&districtId=${districtId}`, unitSelect, '-- Select Unit --');
        }
    });

    unitSelect.addEventListener('change', function () {
        const districtId = districtSelect.value;
        const unit = this.value;
        resetSelect(testIdSelect, '-- Select Test --', true);
        resetSelect(schoolSelect, '-- Select School --', true);
        resetSelect(teacherSelect, '-- All Teachers --', true);
        clearResults();
        if (districtId && unit) {
            fetchAndPopulate(`/CurriculumAlignment/Form1?handler=TestNames&districtId=${districtId}&unit=${unit}`, testIdSelect, '-- Select Test --');
        }
    });

    testIdSelect.addEventListener('change', function() {
        const districtId = districtSelect.value;
        const testId = this.value;
        resetSelect(schoolSelect, '-- Select School --', true);
        resetSelect(teacherSelect, '-- All Teachers --', true);
        clearResults("Please select a school to continue.");
        if (districtId && testId) {
            fetchAndPopulate(`/CurriculumAlignment/Form1?handler=Schools&districtId=${districtId}&testId=${testId}`, schoolSelect, '-- Select School --');
            // **CHANGE**: We no longer load results here.
        }
    });

    schoolSelect.addEventListener('change', function() {
        const districtId = districtSelect.value;
        const testId = testIdSelect.value;
        const schoolId = this.value;
        resetSelect(teacherSelect, '-- All Teachers --', true);
        clearResults();
        if (districtId && testId && schoolId) {
            fetchAndPopulate(`/CurriculumAlignment/Form1?handler=Teachers&districtId=${districtId}&testId=${testId}&schoolId=${schoolId}`, teacherSelect, '-- All Teachers --');
            // **CHANGE**: We now load results for the school here.
            loadStudentResults(); 
        }
    });

    teacherSelect.addEventListener('change', loadStudentResults);

    function resetSelect(selectElement, placeholder, disabled = false) {
        selectElement.innerHTML = '';
        selectElement.add(new Option(placeholder, ''));
        selectElement.disabled = disabled;
    }
    
    function showLoading(show) {
        loadingIndicator.style.display = show ? 'block' : 'none';
        if (show) resultsContainer.innerHTML = '';
    }

    function clearResults(message = "Please make a selection to view student data.") {
        resultsContainer.innerHTML = `<p class="text-muted">${message}</p>`;
    }
});
</script>
}