@page
@model ORSV2.Pages.CurriculumAlignment.Form1Model

@{
    ViewData["Title"] = "DRS Form 1";
    // Group the rows by Teacher and then by Period for display
    var groupedRows = Model.Rows.GroupBy(r => r.TeacherName).Select(g => new 
    {
        TeacherName = g.Key,
        Periods = g.GroupBy(p => p.Period).Select(pGroup => new 
        {
            Period = pGroup.Key,
            Students = pGroup.ToList()
        }).OrderBy(p => p.Period)
    }).OrderBy(t => t.TeacherName);
}

@await Html.PartialAsync("_Breadcrumbs", Model.Breadcrumbs)

<style>
    /* Custom styles for Form 1 */
    .form1-table {
        font-size: 0.8rem;
    }
    
    .form1-table th {
        font-size: 0.75rem;
        padding: 0.4rem 0.3rem;
        vertical-align: middle;
    }
    
    .form1-table td {
        font-size: 0.75rem;
        padding: 0.3rem 0.25rem;
        vertical-align: middle;
    }
    
    .std-head {
        text-align: center;
        vertical-align: middle;
        white-space: normal !important;
        word-break: break-word;
        overflow-wrap: break-word;
        max-width: 140px;
        line-height: 1.2;
    }
    
    .std-head .std-code {
        display: block;
        font-weight: 700;
        margin-bottom: 2px;
        font-size: 0.8rem;
    }
    
    .std-head .std-statement {
        display: block;
        font-size: 0.6rem;
        line-height: 1.1;
        color: #6b7280;
        font-weight: normal;
    }
    
    .sticky-col {
        font-size: 0.75rem;
        white-space: nowrap;
        padding: 0.3rem 0.25rem;
    }
    
    .sticky-col-2 {
        font-size: 0.75rem;
        white-space: nowrap;
        padding: 0.3rem 0.25rem;
    }
    
    .group-header td {
        background-color: #e9ecef;
        font-weight: bold;
        padding: 0.5rem 1rem;
        font-size: 0.8rem;
    }
    
    .period-header td {
        background-color: #f8f9fa;
        padding-left: 2rem;
        font-size: 0.75rem;
    }
    
    .summary-row td {
        border-top: 2px solid #e2e8f0;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .grand-row td {
        background: #f3f4f6;
        font-weight: 700;
        border-top: 2px solid #e2e8f0;
        font-size: 0.75rem;
    }
    
    .quad-row td {
        border-top: 3px solid #fdba74;
        vertical-align: top;
        padding: 0.5rem;
    }
    
    .quad-title {
        font-weight: 700;
        font-size: 0.8rem;
        margin-bottom: 2px;
    }
    
    .quad-metric {
        font-weight: 700;
        font-size: 0.9rem;
    }
    
    .quad-detail {
        font-size: 0.7rem;
        color: #374151;
    }
    
    .quad-total-row td {
        background: #fffbeb;
        border-top: 2px dashed #f59e0b;
        text-align: right;
        font-size: 0.75rem;
    }
    
    .quad-total-label {
        font-weight: 600;
        margin-right: 6px;
    }
    
    .quad-total-value {
        font-weight: 800;
    }
    
    /* Quadrant theming */
    .quad-cell {
        border-radius: 8px;
        padding: 0.5rem;
    }
    
    .quadrant-challenge {
        background: var(--quad-benchmark-bg, #eff6ff);
        color: var(--quad-benchmark-fg, #1e40af);
    }
    
    .quadrant-benchmark {
        background: var(--quad-challenge-bg, #ecfdf5);
        color: var(--quad-challenge-fg, #065f46);
    }
    
    .quadrant-strategic {
        background: var(--quad-strategic-bg, #fffbeb);
        color: var(--quad-strategic-fg, #92400e);
    }
    
    .quadrant-intensive {
        background: var(--quad-intensive-bg, #fef2f2);
        color: var(--quad-intensive-fg, #991b1b);
    }
    
    /* Table styling */
    .form1-table {
        border-collapse: separate;
        border-spacing: 0;
        width: 100%;
    }
    
    .form1-table th,
    .form1-table td {
        border: 1px solid #e5e7eb;
    }
    
    .form1-table thead th {
        background-color: #f3f4f6;
    }
    
    /* Print styles */
    .print-button {
        margin-bottom: 1rem;
    }
    
    /* Print title (hidden on screen, visible in print) */
    .print-title {
        display: none;
    }
    
    @@media print {
        /* Print page setup - portrait orientation */
        @@page {
            margin: 0.5in !important;
            size: portrait !important;
        }
        
        /* Hide non-essential elements */
        .print-button,
        .orenda-header,
        form,
        .alert,
        .row,
        .col-md-2,
        .col-md-3,
        nav,
        .navbar,
        .sidebar,
        .breadcrumb,
        .breadcrumbs,
        header,
        .header,
        .navigation,
        .nav {
            display: none !important;
        }
        
        /* Force everything to start from left edge */
        * {
            margin-left: 0 !important;
            padding-left: 0 !important;
            left: 0 !important;
        }
        
        /* Reset containers for full width */
        body, html {
            margin: 0 !important;
            padding: 0 !important;
            width: 100% !important;
            overflow-x: visible !important;
        }
        
        .orenda-container,
        .card,
        .card-body,
        .table-responsive,
        .container,
        .container-fluid {
            margin: 0 !important;
            padding: 0 !important;
            border: none !important;
            box-shadow: none !important;
            background: white !important;
            width: 100% !important;
            max-width: none !important;
            left: 0 !important;
            right: 0 !important;
            position: static !important;
        }
        
        /* Show and position print title */
        .print-title {
            display: block !important;
            text-align: center !important;
            font-size: 14pt !important;
            font-weight: bold !important;
            margin-bottom: 0.2in !important;
            padding: 0 !important;
        }
        
        /* Hide screen title */
        .mb-2 h5 {
            display: none !important;
        }
        
        /* Table sizing for portrait */
        .form1-table {
            width: 100% !important;
            font-size: 8pt !important;
            margin: 0 !important;
            border-collapse: collapse !important;
            table-layout: fixed !important;
        }
        
        .form1-table th,
        .form1-table td {
            font-size: 7pt !important;
            padding: 0.05in !important;
            border: 1px solid #000 !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
        }
        
        /* Column widths for portrait fit */
        .form1-table .sticky-col {
            width: 1.2in !important;
            text-align: center !important;
        }
        
        .form1-table .sticky-col-2 {
            width: 0.7in !important;
            text-align: center !important;
        }
        
        .form1-table .std-head,
        .form1-table .std-cell {
            width: 0.9in !important;
        }
        
        .form1-table th:last-child,
        .form1-table td:last-child {
            width: 0.8in !important;
        }
        
        /* Only center student data cells, not group headers */
        .form1-table tbody tr:not(.group-header):not(.period-header):not(.summary-row):not(.grand-row) .sticky-col,
        .form1-table tbody tr:not(.group-header):not(.period-header):not(.summary-row):not(.grand-row) .sticky-col-2 {
            text-align: center !important;
        }
        
        /* Keep group headers left-aligned */
        .group-header td,
        .period-header td,
        .summary-row td,
        .grand-row td {
            text-align: left !important;
        }
        
        /* Standard headers for print */
        .std-head .std-code {
            font-size: 8pt !important;
            font-weight: bold !important;
            display: block !important;
            margin-bottom: 2px !important;
        }
        
        .std-head .std-statement {
            font-size: 6pt !important;
            font-weight: normal !important;
            display: block !important;
            line-height: 1.1 !important;
        }
        
        /* Ensure headers repeat on each page */
        .form1-table thead {
            display: table-header-group !important;
        }
        
        .form1-table tbody {
            display: table-row-group !important;
        }
        
        /* Page breaks by teacher */
        .teacher-page-break-row {
            page-break-after: always !important;
            break-after: page !important;
            height: 0 !important;
            border: none !important;
        }
        
        .teacher-page-break-row td {
            padding: 0 !important;
            margin: 0 !important;
            border: none !important;
            height: 0 !important;
        }
        
        /* Prevent page breaks within groups */
        .group-header,
        .period-header,
        .summary-row {
            page-break-inside: avoid !important;
            break-inside: avoid !important;
        }
        
        /* Keep student rows together when possible */
        .form1-table tbody tr {
            page-break-inside: avoid !important;
        }
        
        /* Footer note */
        .form3-footer-note {
            font-size: 8pt !important;
            margin-top: 0.1in !important;
        }
    }
</style>

<div class="orenda-container">
    <div class="orenda-header shadow-orenda">
        <h2 class="mb-1">Data Reflection</h2>
        <p class="mb-0">Form 1</p>
    </div>

    <!-- Main Filter Form -->
    <form id="filterForm" method="get" class="row g-3 mt-3">
        <input type="hidden" asp-for="DistrictId" />
        <div class="col-md-3">
            <label asp-for="UnitCycle" class="form-label fw-semibold">Unit / Cycle</label>
            <select asp-for="UnitCycle" asp-items="Model.AvailableUnitCycles" class="form-select" onchange="this.form.submit()"></select>
        </div>
        <div class="col-md-3">
            <label asp-for="BatchId" class="form-label fw-semibold">Assessment</label>
            <select asp-for="BatchId" asp-items="Model.AvailableBatches" class="form-select" onchange="this.form.submit()"></select>
        </div>
        <div class="col-md-3">
            <label asp-for="SchoolId" class="form-label fw-semibold">School</label>
            <select asp-for="SchoolId" asp-items="Model.AvailableSchools" class="form-select" onchange="this.form.submit()"></select>
        </div>
        <div class="col-md-3">
            <label asp-for="TeacherId" class="form-label fw-semibold">Teacher</label>
            <select asp-for="TeacherId" asp-items="Model.AvailableTeachers" class="form-select" onchange="this.form.submit()"></select>
        </div>
    </form>

    @if (Model.Rows.Any())
    {
        <div class="card shadow-sm mt-4">
            <div class="card-body">
                <!-- Print Button -->
                <div class="print-button mb-3">
                    <button type="button" class="btn btn-primary" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>Print Report
                    </button>
                </div>
                
                <!-- Print Title (hidden on screen, visible in print) -->
                <div class="print-title">
                    @(Model.AvailableBatches.FirstOrDefault(b => b.Value == Model.BatchId)?.Text ?? "Assessment") - Form 1
                </div>

                <!-- Test Name Header for screen -->
                <div class="mb-2">
                    <h5 class="mb-0 text-center">@(Model.AvailableBatches.FirstOrDefault(b => b.Value == Model.BatchId)?.Text ?? "Assessment") - Form 1</h5>
                </div>

                <div class="table-responsive">
                    <table class="table form1-table table-compact align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="sticky-col text-center" style="width: 140px;">Student Name</th>
                                <th class="sticky-col-2 text-center" style="width: 85px;">Student Local ID</th>
                                @foreach (var col in Model.Columns)
                                {
                                    <th class="std-head">
                                        <span class="std-code">@col.Code</span>
                                        <span class="std-statement">@col.ShortStatement</span>
                                    </th>
                                }
                                <th class="text-center" style="width: 100px;">Total Passed</th>
                            </tr>
                        </thead>

                        <tbody>
                        @foreach (var teacherGroup in groupedRows)
                        {
                            <tr class="group-header teacher-page-break">
                                <td colspan="@(Model.Columns.Count + 3)">
                                    <strong>Teacher:</strong> @teacherGroup.TeacherName
                                </td>
                            </tr>
                            @foreach (var periodGroup in teacherGroup.Periods)
                            {
                                <tr class="group-header period-header">
                                    <td colspan="@(Model.Columns.Count + 3)">
                                        <strong>Period:</strong> @periodGroup.Period
                                    </td>
                                </tr>

                                @* Student rows *@
                                @foreach (var row in periodGroup.Students)
                                {
                                    <tr>
                                        <td class="sticky-col fw-medium">@row.StudentName</td>
                                        <td class="sticky-col-2">@row.LocalId</td>
                                        @for (int i = 0; i < Model.Columns.Count; i++)
                                        {
                                            var val = row.Points[i];
                                            <td class="text-center std-cell">@((val.HasValue) ? val.Value.ToString("0.##") : "")</td>
                                        }
                                        <td class="text-center fw-bold text-orenda-primary">@row.TotalPassed</td>
                                    </tr>
                                }

                                @* Group summary for this Teacher×Period *@
                                var gs = Model.GroupSummaries.FirstOrDefault(
                                    x => x.Key.TeacherName == teacherGroup.TeacherName && x.Key.Period == periodGroup.Period
                                );
                                if (gs != null)
                                {
                                    <tr class="bg-gray-50 fw-semibold summary-row group-passed">
                                        <td class="sticky-col" colspan="2">Passed</td>
                                        @for (int i = 0; i < Model.Columns.Count; i++)
                                        {
                                            var c = gs.PassedPerStd[i];
                                            var d = Math.Max(1, gs.DenomPerStd[i]);
                                            <td class="text-center">@c (@String.Format("{0:P2}", (double)c / d))</td>
                                        }
                                        <td class="text-center fw-semibold">
                                            @gs.PassedByTotal (@String.Format("{0:P2}", (double)gs.PassedByTotal / Math.Max(1, gs.PassedByTotal + gs.NotPassedByTotal)))
                                        </td>
                                    </tr>
                                    <tr class="bg-gray-50 summary-row group-notpassed">
                                        <td class="sticky-col" colspan="2">Not Passed</td>
                                        @for (int i = 0; i < Model.Columns.Count; i++)
                                        {
                                            var c = gs.NotPassedPerStd[i];
                                            var d = Math.Max(1, gs.DenomPerStd[i]);
                                            <td class="text-center">@c (@String.Format("{0:P2}", (double)c / d))</td>
                                        }
                                        <td class="text-center">
                                            @gs.NotPassedByTotal (@String.Format("{0:P2}", (double)gs.NotPassedByTotal / Math.Max(1, gs.PassedByTotal + gs.NotPassedByTotal)))
                                        </td>
                                    </tr>

                                    <!-- No page break after periods anymore -->
                                }
                            }
                            <!-- Page break after each teacher (except the last one) -->
                            @if (teacherGroup != groupedRows.Last())
                            {
                                <tr class="teacher-page-break-row">
                                    <td colspan="@(Model.Columns.Count + 3)" style="height: 0; padding: 0; border: none; page-break-after: always;"></td>
                                </tr>
                            }
                        }
                        
                        @if (Model.GrandTotals is not null)
                        {
                            <tr class="bg-slate-100 fw-bold grand-row grand-passed">
                                <td class="sticky-col" colspan="2">Grand Total — Passed</td>
                                @for (int i = 0; i < Model.Columns.Count; i++)
                                {
                                    var c = Model.GrandTotals.PassedPerStd[i];
                                    var d = Math.Max(1, Model.GrandTotals.DenomPerStd[i]);
                                    <td class="text-center">@c (@String.Format("{0:P2}", (double)c / d))</td>
                                }
                                <td class="text-center fw-bold">
                                    @Model.GrandTotals.PassedByTotal (@String.Format("{0:P2}", (double)Model.GrandTotals.PassedByTotal / Math.Max(1, Model.GrandTotals.PassedByTotal + Model.GrandTotals.NotPassedByTotal)))
                                </td>
                            </tr>
                            <tr class="bg-slate-100 grand-row grand-notpassed">
                                <td class="sticky-col" colspan="2">Grand Total — Not Passed</td>
                                @for (int i = 0; i < Model.Columns.Count; i++)
                                {
                                    var c = Model.GrandTotals.NotPassedPerStd[i];
                                    var d = Math.Max(1, Model.GrandTotals.DenomPerStd[i]);
                                    <td class="text-center">@c (@String.Format("{0:P2}", (double)c / d))</td>
                                }
                                <td class="text-center">
                                    @Model.GrandTotals.NotPassedByTotal (@String.Format("{0:P2}", (double)Model.GrandTotals.NotPassedByTotal / Math.Max(1, Model.GrandTotals.PassedByTotal + Model.GrandTotals.NotPassedByTotal)))
                                </td>
                            </tr>
                        }
                        
                        @if (Model.Quadrants is not null)
                        {
                            var qt = Model.Quadrants;
                            int totalCols = Model.Columns.Count + 3; // 2 sticky + standards + Total Passed column
                            int span = Math.Max(1, totalCols / 4);
                            int remainder = Math.Max(0, totalCols - (span * 4));
                            <tr class="quad-row">
                                <td class="quad-cell quadrant-challenge" colspan="@span">
                                    <div class="quad-title quadrant-challenge">Challenge</div>
                                    <div class="quad-metric">@String.Format("{0:P2}", (double)qt.Challenge / Math.Max(1, qt.TotalTested))</div>
                                    <div class="quad-detail">@qt.Challenge students</div>
                                </td>
                                <td class="quad-cell quadrant-benchmark" colspan="@span">
                                    <div class="quad-title quadrant-benchmark">Benchmark</div>
                                    <div class="quad-metric">@String.Format("{0:P2}", (double)qt.Benchmark / Math.Max(1, qt.TotalTested))</div>
                                    <div class="quad-detail">@qt.Benchmark students</div>
                                </td>
                                <td class="quad-cell quadrant-strategic" colspan="@span">
                                    <div class="quad-title quadrant-strategic">Strategic</div>
                                    <div class="quad-metric">@String.Format("{0:P2}", (double)qt.Strategic / Math.Max(1, qt.TotalTested))</div>
                                    <div class="quad-detail">@qt.Strategic students</div>
                                </td>
                                <td class="quad-cell quadrant-intensive" colspan="@(span + remainder)">
                                    <div class="quad-title quadrant-intensive">Intensive</div>
                                    <div class="quad-metric">@String.Format("{0:P2}", (double)qt.Intensive / Math.Max(1, qt.TotalTested))</div>
                                    <div class="quad-detail">@qt.Intensive students</div>
                                </td>
                            </tr>
                            <tr class="quad-total-row">
                                <td colspan="@(totalCols)">
                                    <span class="quad-total-label">Total Tested:</span> <span class="quad-total-value">@qt.TotalTested</span>
                                </td>
                            </tr>
                        }
                        </tbody>
                    </table>
                </div>

                <div class="form3-footer-note text-muted mt-3" style="font-size: 0.7rem;">
                    PASS cutoff = score ≥ 4 (per standard). Overall Proficiency = student passed ≥ 3 standards.
                </div>
            </div>
        </div>
    }
    else if (Model.SchoolId.HasValue) // Show message if a school was selected but no rows were found
    {
        <div class="alert alert-warning mt-3">
            No results found for the selected filters.
        </div>
    }
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">