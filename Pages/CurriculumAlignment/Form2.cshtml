@page
@model ORSV2.Pages.CurriculumAlignment.Form2Model
@{
    ViewData["Title"] = "Curriculum Alignment – Quadrant Breakdown (Form 2)";
}

@await Html.PartialAsync("_Breadcrumbs", Model.Breadcrumbs)

@section Styles {
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/rowgroup/1.4.0/css/rowGroup.bootstrap5.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

    <style>
        /* =================================================================== */
        /* QUADRANT-SPECIFIC STYLES (from site.css)                            */
        /* =================================================================== */

        /* Group Row Backgrounds */
        .quadrant-challenge {
            background-color: var(--quad-challenge-bg) !important;
        }

        .quadrant-benchmark {
            background-color: var(--quad-benchmark-bg) !important;
        }

        .quadrant-strategic {
            background-color: var(--quad-strategic-bg) !important;
        }

        .quadrant-intensive {
            background-color: var(--quad-intensive-bg) !important;
        }

        /* Group Header Text/Background */
        .dtrg-start.challenge td {
            --group-color: #1e40af;
            --group-color-dark: #1e3a8a;
        }

        .dtrg-start.benchmark td {
            --group-color: #16a34a;
            --group-color-dark: #15803d;
        }

        .dtrg-start.strategic td {
            --group-color: #FEC401;
            --group-color-dark: #F59E0B;
            color: #111827 !important;
        }

        .dtrg-start.intensive td {
            --group-color: #dc2626;
            --group-color-dark: #b91c1c;
        }

        /* Group Footer Backgrounds */
        .dtrg-end.challenge td {
            --group-color: #1e40af;
            background-color: #ddd6fe !important;
        }

        .dtrg-end.benchmark td {
            --group-color: #16a34a;
            background-color: #d1fae5 !important;
        }

        .dtrg-end.strategic td {
            --group-color: #FEC401;
            background-color: #fef3c7 !important;
        }

        .dtrg-end.intensive td {
            --group-color: #dc2626;
            background-color: #fee2e2 !important;
        }

        /* Student Attribute Highlights */
        .hi-aa {
            background-color: var(--quad-challenge-bg) !important;
            color: var(--quad-challenge-fg) !important;
        }

        .hi-el {
            background-color: #fbcfe8 !important;
        }

        /* Retaining unique color not in site.css */
        .hi-swd {
            background-color: var(--quad-strategic-bg) !important;
            color: var(--quad-strategic-fg) !important;
        }

        .student-multi-flag {
            color: #c2410c !important;
            font-weight: 600;
        }

        /* Generic Group Header/Footer styling (can be moved to site.css) */
        .dtrg-start td {
            background: linear-gradient(135deg, var(--group-color) 0%, var(--group-color-dark) 100%) !important;
            color: white !important;
            font-weight: 600 !important;
            font-size: 0.95rem !important;
            text-align: left !important;
            border: none !important;
            padding: 0.6rem 1rem !important;
        }

        .dtrg-end td {
            border-top: 3px solid var(--group-color) !important;
            font-weight: 600 !important;
            font-style: italic !important;
            padding: 0.75rem !important;
        }

        .dt-buttons {
            margin-bottom: 1.5rem;
        }

        /* Custom title for the table card */
        .table-title {
            padding: 0 1.5rem;
            font-weight: 600;
            color: #334155;
        }

        .dataTables_wrapper {
            padding: 1.5rem;
            padding-top: 1rem;
        }

        /* Center all table headers */
        #quadrantTable thead th {
            text-align: center !important;
        }

        /* Center all table data cells */
        #quadrantTable tbody td {
            text-align: center !important;
        }

        /* Keep group headers left-aligned since they're descriptive */
        .dtrg-start td {
            text-align: left !important;
        }

        /* Keep totals footer left-aligned since it contains descriptive text */
        .dtrg-end td {
            text-align: left !important;
        }

        @@media print {
            /* Hide elements that shouldn't be printed */
            .orenda-header,
            .orenda-card,
            .dataTables_wrapper .dt-buttons,
            .dataTables_wrapper .dataTables_filter,
            .dataTables_wrapper .dataTables_info,
            .dataTables_wrapper .dataTables_paginate {
                display: none !important;
            }

            /* Ensure the table container is visible and clean */
            .orenda-table-wrapper {
                display: block !important;
                box-shadow: none !important;
                border: none !important;
            }

            /* Enhanced print styling for repeating quadrant headers */
            @@page {
                size: A4;
                margin: 0.5in;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                font-size: 11px;
                line-height: 1.3;
                color: #333;
            }

            /* Table styling */
            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 10px;
            }

            th, td {
                padding: 6px 4px;
                border: 1px solid #ddd;
                text-align: center;
            }

            th {
                background-color: #f8f9fa !important;
                font-weight: 600;
                border-bottom: 2px solid #dee2e6;
            }

            /* Quadrant group headers */
            .dtrg-start td {
                font-weight: 600 !important;
                font-size: 12px !important;
                padding: 10px !important;
                border: none !important;
                text-align: left !important;
                page-break-after: avoid !important;
            }

            .dtrg-start.challenge td { 
                background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%) !important; 
                color: white !important; 
            }
            .dtrg-start.benchmark td { 
                background: linear-gradient(135deg, #16a34a 0%, #15803d 100%) !important; 
                color: white !important; 
            }
            .dtrg-start.strategic td { 
                background: linear-gradient(135deg, #FEC401 0%, #F59E0B 100%) !important; 
                color: #111827 !important; 
            }
            .dtrg-start.intensive td { 
                background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important; 
                color: white !important; 
            }

            /* Column headers after quadrant headers */
            .print-column-header {
                background-color: #f8f9fa !important;
                font-weight: 600 !important;
                font-size: 10px !important;
                padding: 8px 4px !important;
                border: 1px solid #ddd !important;
                text-align: center !important;
                page-break-after: avoid !important;
            }

            /* Quadrant group footers */
            .dtrg-end td {
                font-weight: 600 !important;
                font-style: italic !important;
                padding: 8px !important;
                border-top: 3px solid !important;
                text-align: left !important;
                page-break-before: avoid !important;
                page-break-after: always !important;
            }

            .dtrg-end.challenge td { 
                background-color: #ddd6fe !important; 
                border-top-color: #1e40af !important; 
            }
            .dtrg-end.benchmark td { 
                background-color: #d1fae5 !important; 
                border-top-color: #16a34a !important; 
            }
            .dtrg-end.strategic td { 
                background-color: #fef3c7 !important; 
                border-top-color: #FEC401 !important; 
            }
            .dtrg-end.intensive td { 
                background-color: #fee2e2 !important; 
                border-top-color: #dc2626 !important; 
            }

            /* Student highlights */
            .hi-aa { background-color: #d1fae5 !important; }
            .hi-el { background-color: #fbcfe8 !important; }
            .hi-swd { background-color: #fef3c7 !important; }

            /* Page break controls */
            .dtrg-start { 
                page-break-before: always; 
            }
            .dtrg-start:first-of-type { 
                page-break-before: avoid; 
            }

            /* Force page breaks for long quadrant sections */
            .quadrant-page-break {
                page-break-before: always !important;
            }

            /* Ensure student rows don't break across pages awkwardly */
            tbody tr {
                page-break-inside: avoid;
            }

            /* Title styling */
            .print-title {
                text-align: center;
                font-size: 16px;
                font-weight: bold;
                color: #1e40af;
                margin-bottom: 20px;
                page-break-after: avoid;
            }
        }
    </style>
}

<div class="orenda-header">
    <h2 class="mb-1">Quadrant Breakdown</h2>
    @if (!string.IsNullOrEmpty(Model.DistrictName))
    {
        <h5 class="fw-normal mb-0 opacity-75">District: @Model.DistrictName</h5>
    }
    <p class="mb-0 mt-2">Challenge · Benchmark · Strategic · Intensive</p>
</div>

<div class="orenda-card mb-3">
    <div class="orenda-card-body">
        <form method="get" class="d-flex flex-wrap gap-3 align-items-end">
            <input type="hidden" asp-for="DistrictId" />
            <div class="flex-grow-1" style="min-width: 120px;">
                <label class="form-label fw-semibold">Unit/Cycle</label>
                <select name="UnitCycle" class="form-select orenda-select" onchange="this.form.submit()">
                    @foreach (var o in Model.AvailableUnitCycles)
                    {
                        <option value="@o.Value" selected="@(o.Value == Model.UnitCycle)">@o.Text</option>
                    }
                </select>
            </div>
            <div class="flex-grow-1" style="min-width: 200px;">
                <label class="form-label fw-semibold">Assessment</label>
                <select name="BatchId" class="form-select orenda-select" onchange="this.form.submit()">
                    @foreach (var o in Model.AvailableBatches)
                    {
                        <option value="@o.Value" selected="@(o.Value == Model.BatchId)">@o.Text</option>
                    }
                </select>
            </div>
            <div class="flex-grow-1" style="min-width: 200px;">
                <label class="form-label fw-semibold">School</label>
                <select name="SchoolId" class="form-select orenda-select" onchange="this.form.submit()">
                    @foreach (var o in Model.AvailableSchools)
                    {
                        <option value="@o.Value" selected="@(o.Value == (Model.SchoolId?.ToString() ?? ""))">@o.Text
                        </option>
                    }
                </select>
            </div>
            <div class="flex-grow-1" style="min-width: 200px;">
                <label class="form-label fw-semibold">Teacher</label>
                <select name="TeacherId" class="form-select orenda-select" onchange="this.form.submit()">
                    @foreach (var o in Model.AvailableTeachers)
                    {
                        <option value="@o.Value" selected="@(o.Value == (Model.TeacherId?.ToString() ?? ""))">@o.Text
                        </option>
                    }
                </select>
            </div>
        </form>
    </div>
</div>

<div class="orenda-card mb-3">
    <div class="orenda-card-body d-flex flex-wrap gap-3">
        <div><span class="badge-compact"
                style="background-color: var(--quad-challenge-bg); color: var(--quad-challenge-fg);">Race/Ethnicity =
                Black or African American</span></div>
        <div><span class="badge-compact" style="background-color: #fce7f3; color: #9d174d;">Language Fluency = EL</span>
        </div>
        <div><span class="badge-compact"
                style="background-color: var(--quad-strategic-bg); color: var(--quad-strategic-fg);">SWD = true</span>
        </div>
    </div>
</div>

@if (!Model.Students.Any())
{
    <div class="orenda-card">
        <div class="orenda-card-body text-muted">Select Unit/Cycle and Assessment to view quadrant breakdown.</div>
    </div>
}
else
{
    <div class="orenda-table-wrapper" id="quadrantExportRoot">
        @if (!string.IsNullOrEmpty(Model.FormattedTitle))
        {
            <h4 class="table-title">@Model.FormattedTitle</h4>
        }
        <table id="quadrantTable" class="table orenda-table" style="width:100%">
            <thead>
                <tr>
                    <th style="display:none;">Quadrant</th>
                    <th>Last Name</th>
                    <th>First Name</th>
                    <th>Race/Ethnicity</th>
                    <th>Language Fluency</th>
                    <th>SWD</th>
                    <th>Total Passed</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var student in Model.FlattenedStudents.Where(s => !s.IsQuadrantTotal))
                {
                    <tr>
                        <td style="display:none;">@student.QuadrantName</td>
                        <td>@student.LastName</td>
                        <td>@student.FirstName</td>
                        <td class="@(student.IsAA ? "hi-aa" : "")">@student.RaceEthnicity</td>
                        <td class="@(student.IsEL ? "hi-el" : "")">@student.LanguageFluency</td>
                        <td class="@(student.IsSWD ? "hi-swd" : "")">@student.SWDDisplay</td>
                        <td>@student.TotalPassed</td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/rowgroup/1.4.0/js/dataTables.rowGroup.min.js"></script>

    <script>
        // Helper function to get quadrant standards information
        function getQuadrantInfo(quadrantName) {
            switch(quadrantName) {
                case 'Challenge':
                    return '4-5 standards passed';
                case 'Benchmark':
                    return '3 standards passed';
                case 'Strategic':
                    return '2 standards passed';
                case 'Intensive':
                    return '0-1 standards passed';
                default:
                    return '';
            }
        }

        $(document).ready(function () {
            const dynamicTitle = "@Html.Raw(Model.FormattedTitle)";
            var totalsData = {
                @foreach (var totalRow in Model.FlattenedStudents.Where(s => s.IsQuadrantTotal))
                {
                    <text>'@totalRow.QuadrantName': '@Html.Raw(totalRow.TotalsSummary)',</text>
                }
            };

            var table = $('#quadrantTable').DataTable({
                responsive: true,
                pageLength: 100,
                lengthMenu: [[25, 50, 100, -1], [25, 50, 100, "All"]],
                dom: 'Bfrtip',
                orderFixed: [[0, 'asc']],
                ordering: false,
                columnDefs: [
                    { targets: [0], visible: false }
                ],
                rowGroup: {
                    dataSrc: 0,
                    startRender: function (rows, group) {
                        var groupClass = group.toLowerCase();
                        var standardsInfo = getQuadrantInfo(group);
                        return $('<tr class="dtrg-start ' + groupClass + '"></tr>')
                            .append('<td colspan="6">' + group + ' (' + rows.count() + ' students) - ' + standardsInfo + '</td>');
                    },
                    endRender: function (rows, group) {
                        var groupClass = group.toLowerCase();
                        var totals = totalsData[group] || 'No data available';
                        return $('<tr class="dtrg-end ' + groupClass + '"></tr>')
                            .append('<td colspan="6" style="text-align:left;"><strong>Totals: ' + totals + '</strong></td>');
                    }
                },
                buttons: [
                    { 
                        text: '<i class="fas fa-print"></i> Print', 
                        className: 'btn-export', 
                        action: () => enhancedPrint(table, dynamicTitle) 
                    }
                ],
                language: { 
                    search: "", 
                    searchPlaceholder: 'Search students...', 
                    info: 'Showing _START_ to _END_ of _TOTAL_ students', 
                    infoFiltered: '(filtered from _MAX_ total students)' 
                }
            });

            $('.dataTables_filter input').before('<i class="fas fa-search" style="padding-right: 5px;"></i>');
        });

        function withAllRows(datatable, callback) {
            const originalPageLength = datatable.page.len();
            datatable.page.len(-1).draw();
            setTimeout(() => {
                callback();
                datatable.page.len(originalPageLength).draw();
            }, 500);
        }

        // Enhanced print function with repeating quadrant headers
        function enhancedPrint(datatable, title) {
            withAllRows(datatable, function () {
                const tableElement = document.getElementById('quadrantTable');
                const tableRows = document.querySelectorAll('#quadrantTable tbody tr');
                
                // Build enhanced HTML with better structure for printing
                let printHtml = `
                    <div class="print-title">${title}</div>
                    <table class="table" style="width:100%">
                `;

                const columnHeaders = ['Last Name', 'First Name', 'Race/Ethnicity', 'Language Fluency', 'SWD', 'Total Passed'];
                let currentQuadrant = '';
                let studentCount = 0;
                const studentsPerPage = 25; // Adjust based on your page size needs

                tableRows.forEach((row, index) => {
                    if (row.classList.contains('dtrg-start')) {
                        // Quadrant header
                        const headerText = row.querySelector('td').textContent.trim();
                        currentQuadrant = headerText.split(' ')[0].toLowerCase();
                        studentCount = 0; // Reset count for new quadrant

                        // Add page break for non-first quadrants
                        const pageBreakClass = index > 0 ? 'quadrant-page-break' : '';
                        
                        printHtml += `
                            <tr class="dtrg-start ${currentQuadrant} ${pageBreakClass}">
                                <td colspan="6">${headerText}</td>
                            </tr>
                            <tr class="print-column-header">
                                ${columnHeaders.map(h => `<th>${h}</th>`).join('')}
                            </tr>
                        `;
                    }
                    else if (row.classList.contains('dtrg-end')) {
                        // Quadrant footer
                        const footerText = row.querySelector('td').textContent.trim();
                        printHtml += `
                            <tr class="dtrg-end ${currentQuadrant}">
                                <td colspan="6"><strong>${footerText}</strong></td>
                            </tr>
                        `;
                    }
                    else {
                        // Student row
                        studentCount++;
                        
                        // Add repeating header if we've exceeded students per page
                        if (studentCount > 1 && (studentCount - 1) % studentsPerPage === 0) {
                            const quadrantName = currentQuadrant.charAt(0).toUpperCase() + currentQuadrant.slice(1);
                            const standardsInfo = getQuadrantInfo(quadrantName);
                            printHtml += `
                                <tr class="dtrg-start ${currentQuadrant} quadrant-page-break">
                                    <td colspan="6">${quadrantName} (continued) - ${standardsInfo}</td>
                                </tr>
                                <tr class="print-column-header">
                                    ${columnHeaders.map(h => `<th>${h}</th>`).join('')}
                                </tr>
                            `;
                        }
                        
                        const cells = Array.from(row.querySelectorAll('td'));
                        if (cells.length > 0) {
                            const startIndex = cells[0].style.display === 'none' ? 1 : 0;
                            
                            printHtml += '<tr>';
                            for (let i = 0; i < 6 && (startIndex + i) < cells.length; i++) {
                                const cell = cells[startIndex + i];
                                const classes = cell.className;
                                printHtml += `<td class="${classes}">${cell.textContent.trim()}</td>`;
                            }
                            printHtml += '</tr>';
                        }
                    }
                });

                printHtml += '</table>';

                const printStyles = `
                    <style>
                        @@page { 
                            size: A4; 
                            margin: 0.5in; 
                        }
                        body { 
                            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
                            font-size: 11px;
                            line-height: 1.3;
                            color: #333;
                        }
                        .print-title { 
                            text-align: center; 
                            font-size: 16px;
                            font-weight: bold;
                            margin-bottom: 20px;
                            color: #1e40af;
                            page-break-after: avoid;
                        }
                        table { 
                            width: 100%; 
                            border-collapse: collapse;
                            font-size: 10px;
                        }
                        th, td { 
                            padding: 6px 4px;
                            border: 1px solid #ddd;
                            text-align: center;
                        }
                        .print-column-header th { 
                            background-color: #f8f9fa !important;
                            font-weight: 600;
                            border-bottom: 2px solid #dee2e6;
                            page-break-after: avoid;
                        }
                        
                        /* Quadrant group headers */
                        .dtrg-start td {
                            font-weight: 600 !important;
                            font-size: 12px !important;
                            padding: 10px !important;
                            border: none !important;
                            text-align: left !important;
                            page-break-after: avoid !important;
                        }
                        .dtrg-start.challenge td { 
                            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%) !important; 
                            color: white !important; 
                        }
                        .dtrg-start.benchmark td { 
                            background: linear-gradient(135deg, #16a34a 0%, #15803d 100%) !important; 
                            color: white !important; 
                        }
                        .dtrg-start.strategic td { 
                            background: linear-gradient(135deg, #FEC401 0%, #F59E0B 100%) !important; 
                            color: #111827 !important; 
                        }
                        .dtrg-start.intensive td { 
                            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%) !important; 
                            color: white !important; 
                        }
                        
                        /* Quadrant group footers */
                        .dtrg-end td {
                            font-weight: 600 !important;
                            font-style: italic !important;
                            padding: 8px !important;
                            border-top: 3px solid !important;
                            text-align: left !important;
                            page-break-before: avoid !important;
                        }
                        .dtrg-end.challenge td { 
                            background-color: #ddd6fe !important; 
                            border-top-color: #1e40af !important; 
                        }
                        .dtrg-end.benchmark td { 
                            background-color: #d1fae5 !important; 
                            border-top-color: #16a34a !important; 
                        }
                        .dtrg-end.strategic td { 
                            background-color: #fef3c7 !important; 
                            border-top-color: #FEC401 !important; 
                        }
                        .dtrg-end.intensive td { 
                            background-color: #fee2e2 !important; 
                            border-top-color: #dc2626 !important; 
                        }
                        
                        /* Student highlights */
                        .hi-aa { background-color: #d1fae5 !important; }
                        .hi-el { background-color: #fbcfe8 !important; }
                        .hi-swd { background-color: #fef3c7 !important; }
                        
                        /* Page break controls */
                        .quadrant-page-break {
                            page-break-before: always !important;
                        }
                        
                        /* Ensure student rows don't break across pages awkwardly */
                        tbody tr {
                            page-break-inside: avoid;
                        }
                    </style>
                `;

                const printWindow = window.open('', '', 'height=800,width=1200');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>${title}</title>
                            ${printStyles}
                        </head>
                        <body>
                            ${printHtml}
                        </body>
                    </html>
                `);

                printWindow.document.close();

                setTimeout(() => {
                    printWindow.focus();
                    printWindow.print();
                    printWindow.close();
                }, 1000);
            });
        }
    </script>
}