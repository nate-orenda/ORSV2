@page
@model ORSV2.Pages.IndexModel
@{
    ViewData["Title"] = "Overview";
}
@using System.Security.Claims

<div class="orenda-container">
    <!-- Welcome Header -->
    <div class="orenda-header shadow-orenda">
        <h2 class="mb-1">Welcome, @Model.FirstName</h2>
        <div class="mt-2 text-sm">
            <p class="font-semibold">Please review the information below:</p>

            @{
                // ----- Roles -----
                var roles = User.Claims
                    .Where(c => c.Type == ClaimTypes.Role)
                    .Select(c => c.Value)
                    .ToList();

                var isOrendaUser = roles.Any(r =>
                    r.StartsWith("orenda", StringComparison.OrdinalIgnoreCase));

                var isDistrictAdmin = roles.Any(r =>
                    r.Equals("DistrictAdmin", StringComparison.OrdinalIgnoreCase) ||
                    r.Equals("districtadmin", StringComparison.OrdinalIgnoreCase));

                // ----- District + school info from DistrictBlocks -----
                var districtGroups = Model.DistrictBlocks
                    .Select(b => new
                    {
                        b.DistrictName,
                        SchoolCount = b.Schools.Count
                    })
                    .ToList();

                var districtNames = districtGroups
                    .Select(g => g.DistrictName)
                    .Distinct()
                    .ToList();

                var totalSchoolCount = districtGroups.Sum(g => g.SchoolCount);

                // ----- District summary text -----
                string districtSummary;
                if (!districtNames.Any())
                {
                    districtSummary = "No district assigned";
                }
                else if (isOrendaUser)
                {
                    districtSummary = $"{districtNames.Count} district(s) (system-wide access)";
                }
                else if (districtNames.Count == 1)
                {
                    districtSummary = districtNames[0];
                }
                else
                {
                    districtSummary = $"{districtNames.Count} district(s)";
                }

                // ----- School summary text -----
                var schoolNames = Model.DistrictBlocks
                    .SelectMany(d => d.Schools)
                    .Select(s => s.SchoolName)
                    .Distinct()
                    .ToList();

                string schoolSummary;
                if (!schoolNames.Any())
                {
                    schoolSummary = "No schools assigned";
                }
                else if (isOrendaUser)
                {
                    // Orenda users: high-level count, no giant list
                    schoolSummary = $"{totalSchoolCount} schools across {districtNames.Count} district(s)";
                }
                else if (isDistrictAdmin && schoolNames.Count > 10)
                {
                    // District admins with a ton of schools: summarized view
                    schoolSummary = $"{schoolNames.Count} schools (district-wide access)";
                }
                else if (schoolNames.Count <= 5)
                {
                    // Small list: show all names
                    schoolSummary = string.Join(", ", schoolNames);
                }
                else
                {
                    // Medium/large list: preview + "and N more"
                    var preview = string.Join(", ", schoolNames.Take(3));
                    var remaining = schoolNames.Count - 3;
                    schoolSummary = $"{preview} and {remaining} more";
                }
            }

            <!-- Current role -->
            <p>
                <strong>Your current role:</strong>
                @(roles.Any() ? string.Join(", ", roles) : "No role assigned")
            </p>

            <!-- Current district -->
            <p>
                <strong>Your current district(s):</strong> @districtSummary
            </p>

            <!-- Current schools -->
            <p>
                <strong>Your current school(s):</strong> @schoolSummary
            </p>

            <!-- Help text -->
            <p class="mt-2 text-xs text-gray-200">
                If you see an issue with your current level of access or assigned schools,
                please contact us directly at
                <a class="underline" href="mailto:help@orendaed.org">help@orendaed.org</a>.
                We will be able to assist you.
            </p>
        </div>

    </div>

    @if (Model.DistrictBlocks != null && Model.DistrictBlocks.Any() && Model.DistrictBlocks.Any(db => db.Schools.Any(s => s.GA)))
{
        <!-- Collapsible Gantt Chart Section -->
        var districtTimeline = Model.CheckpointSchedules
            .GroupBy(s => new { s.DistrictId })
            .Select(g => new {
                DistrictId = g.Key.DistrictId,
                DistrictName = g.Select(x => x.SchoolName)
                                    .Select(_ => Model.DistrictBlocks.FirstOrDefault(db => db.DistrictId == g.Key.DistrictId)?.DistrictName)
                                    .FirstOrDefault() ?? $"District {g.Key.DistrictId}",
                CP1 = g.Min(x => x.Checkpoint1Date),
                CP2 = g.Min(x => x.Checkpoint2Date),
                CP3 = g.Min(x => x.Checkpoint3Date),
                CP4 = g.Min(x => x.Checkpoint4Date),
                CP5 = g.Min(x => x.Checkpoint5Date)
            })
            .Where(d => Model.DistrictBlocks.Any(db => db.DistrictId == d.DistrictId && db.Schools.Any(s => s.GA)))
            .OrderBy(x => x.DistrictName)
            .ToList();

        DateTime? minAnchor = districtTimeline.SelectMany(d => new[] { d.CP1, d.CP2, d.CP3, d.CP4, d.CP5 }).Where(d => d.HasValue).DefaultIfEmpty().Min();
        DateTime? maxAnchor = districtTimeline.SelectMany(d => new[] { d.CP1, d.CP2, d.CP3, d.CP4, d.CP5 }).Where(d => d.HasValue).DefaultIfEmpty().Max();
        DateTime startWindow = (minAnchor ?? DateTime.Today).AddDays(-7).Date;
        DateTime endWindow = ((maxAnchor ?? DateTime.Today).AddDays(14)).Date;
        DateTime EndOfMonth(DateTime d) => new DateTime(d.Year, d.Month, DateTime.DaysInMonth(d.Year, d.Month));
        Func<DateTime, double> pct = dt => {
            var span = (endWindow - startWindow).TotalDays;
            if (span <= 0) return 0;
            return Math.Clamp(((dt - startWindow).TotalDays / span) * 100.0, 0, 100);
        };
        var ticks = new List<DateTime>();
        var tickIter = new DateTime(startWindow.Year, startWindow.Month, 1);
        while (tickIter <= endWindow)
        {
            ticks.Add(tickIter);
            tickIter = tickIter.AddMonths(1);
        }

        <div class="orenda-card ga-gantt-card mb-4">
          <div class="orenda-card-body">
            <div class="gantt-header-toggle" data-bs-toggle="collapse" data-bs-target="#ganttCollapseContent" aria-expanded="true" aria-controls="ganttCollapseContent">
              <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-orenda-primary">GA Checkpoint Timeline</h5>
                <i class="bi bi-chevron-up collapse-icon"></i>
              </div>
              <div class="text-muted small">Bars show CP windows (start → next CP; CP5 → end of month)</div>
            </div>

            <div class="collapse show" id="ganttCollapseContent">
              <div class="gantt-content-wrapper mt-4">
                <div class="ga-gantt-scale">
                  <div class="ga-gantt-scale-track">
                    @foreach (var (t, index) in ticks.Select((value, i) => (value, i)))
                    {
                        var left = pct(t);
                        // Show year for the first tick and for every January to avoid clutter
                        var tickLabel = (index == 0 || t.Month == 1) ? t.ToString("MMM yyyy") : t.ToString("MMM");
                        <div class="ga-gantt-tick" style="left:@left%"><span>@tickLabel</span></div>
                    }

                    <!-- Today Marker -->
                    @if (DateTime.Today >= startWindow && DateTime.Today <= endWindow)
                    {
                        var todayPosition = pct(DateTime.Today);
                        <div class="ga-gantt-today" style="left: @todayPosition%;">
                            <div class="today-label">Today</div>
                        </div>
                    }
                  </div>
                </div>

                <div class="ga-gantt">
                  @foreach (var d in districtTimeline)
                  {
                      var spans = new List<(string cp, DateTime start, DateTime end)>();
                      if (d.CP1.HasValue && d.CP2.HasValue) spans.Add(("CP1", d.CP1.Value, d.CP2.Value));
                      if (d.CP2.HasValue && d.CP3.HasValue) spans.Add(("CP2", d.CP2.Value, d.CP3.Value));
                      if (d.CP3.HasValue && d.CP4.HasValue) spans.Add(("CP3", d.CP3.Value, d.CP4.Value));
                      if (d.CP4.HasValue && d.CP5.HasValue) spans.Add(("CP4", d.CP4.Value, d.CP5.Value));
                      if (d.CP5.HasValue) {
                          var eom = EndOfMonth(d.CP5.Value);
                          spans.Add(("CP5", d.CP5.Value, eom));
                      }

                      <div class="ga-gantt-row">
                        <div class="ga-gantt-label" title="@d.DistrictName">@d.DistrictName</div>
                        <div class="ga-gantt-track">
                          @foreach (var s in spans)
                          {
                              var left = pct(s.start);
                              var right = pct(s.end);
                              var width = Math.Max(1, right - left);
                              <div class="ga-span cp-@s.cp.ToLower()" style="left:@left%;width:@width%"
                                   aria-label="@($"{s.cp}: {s.start:MMM d, yyyy} → {s.end:MMM d, yyyy}")"
                                   title="@($"{s.cp}: {s.start:MMM d} → {s.end:MMM d}")">
                                <span class="ga-span-label">@s.cp</span>
                              </div>
                          }
                        </div>
                      </div>
                  }
                </div>
              </div>
            </div>
          </div>
        </div>
    }

    @if (Model.DistrictBlocks == null || !Model.DistrictBlocks.Any())
    {
        <div class="orenda-card shadow-orenda">
            <div class="orenda-card-body">
                <p class="mb-0 text-muted">No schools available in your scope.</p>
            </div>
        </div>
    }
    else
    {
        <!-- District Cards Section -->
        <div class="row g-4 mb-5 justify-content-center">
            @foreach (var district in Model.DistrictBlocks)
            {
                var hasGA = district.Schools.Any(s => s.GA);
                var hasCA = district.Schools.Any(s => s.CA);
                var totalEnrollment = district.Schools.Sum(s => s.Enrollment);
                var gaEnabledCount = district.Schools.Count(s => s.GA);
                var caEnabledCount = district.Schools.Count(s => s.CA);
                var districtId = $"district-{district.DistrictId}";
                
                <div class="col-12 col-md-6 col-lg-4 d-flex">
                    <div class="orenda-card district-card-v2 w-100">

                        <div class="district-card-header text-center">
                            @if (!string.IsNullOrEmpty(district.LogoImagePath))
                            {
                                <img src="@district.LogoImagePath" alt="@district.DistrictName Logo" class="district-logo-stacked mb-3" />
                            }
                            <h4 class="mb-0" title="@district.DistrictName">
                                @district.DistrictName
                            </h4>
                        </div>
                        
                        <div class="district-card-body">
                            <div class="district-overview mb-3">
                                <div class="district-stats-compact">
                                    <div class="d-flex flex-column gap-2">
                                        <div class="stats-row d-flex justify-content-between">
                                            <div class="compact-stat">
                                                <i class="bi bi-building"></i>
                                                <span class="stat-number">@district.Schools.Count</span>
                                                <span class="stat-label">school@(district.Schools.Count == 1 ? "" : "s")</span>
                                            </div>
                                            <div class="compact-stat">
                                                <i class="bi bi-people"></i>
                                                <span class="stat-number">@totalEnrollment.ToString("N0")</span>
                                                <span class="stat-label">students</span>
                                            </div>
                                        </div>
                                        
                                        <div class="schools-link-row text-center">
                                            <button type="button" 
                                                    class="school-expand-btn" 
                                                    data-target="@($"{districtId}-schools-detail")"
                                                    data-expanded="false"
                                                    title="View school details">
                                                <span class="expand-text">View schools</span>
                                                <span class="collapse-text" style="display: none;">Hide schools</span>
                                                <i class="bi bi-chevron-down expand-icon ms-1"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="schools-detail-section" id="@($"{districtId}-schools-detail")" style="display: none;">
                                <div class="schools-detail-list">
                                    @foreach (var school in district.Schools.OrderBy(s => s.SchoolName))
                                    {
                                        <div class="school-detail-item-compact">
                                            <span class="school-name">@school.SchoolName</span>
                                            <div class="school-meta-inline">
                                                @if (school.CurrentCP.HasValue && school.CurrentCP.Value > 0)
                                                {
                                                    <span class="ga-chip cp-cp@(school.CurrentCP.Value)">CP@(school.CurrentCP.Value)</span>
                                                }
                                                @if (school.GA)
                                                {
                                                    <span class="program-mini program-ga-mini">GA</span>
                                                }
                                                @if (school.CA)
                                                {
                                                    <span class="program-mini program-ca-mini">CA</span>
                                                }
                                                <span class="enrollment">@school.Enrollment.ToString("N0")</span>
                                            </div>
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="district-programs mt-3">
                                @if (hasGA)
                                {
                                    <span class="program-badge program-ga">
                                        <i class="bi bi-compass me-1"></i>
                                        GA (@gaEnabledCount)
                                    </span>
                                }
                                @if (hasCA)
                                {
                                    <span class="program-badge program-ca">
                                        <i class="bi bi-book me-1"></i>
                                        CA (@caEnabledCount)
                                    </span>
                                }
                                @if (!hasGA && !hasCA)
                                {
                                    <span class="program-badge program-none">
                                        <i class="bi bi-info-circle me-1"></i>
                                        No programs enabled
                                    </span>
                                }
                            </div>
                        </div>

                        <div class="district-card-footer">
                            @if (hasGA)
                            {
                                <a href="@Url.Page("/GuidanceAlignment/Schools", new { DistrictId = district.DistrictId })" class="action-link">
                                    <span>Guidance Alignment</span>
                                </a>
                            }
                            @if (hasCA)
                            {
                                <a href="@Url.Page("/DataReflection/Forms", new { districtId = district.DistrictId })" class="action-link">
                                    <span>Data Reflection</span>
                                </a>
                            }
                            @if (!hasGA && !hasCA)
                            {
                                <div class="text-muted text-center py-2">
                                    <small>Configure schools to enable programs</small>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- School Details Toggle JavaScript - Fixed Selector -->
<script>
    (function() {
        // Handle school details expansion - using correct class selector
        document.querySelectorAll('.school-expand-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const targetId = this.dataset.target;
                const targetElement = document.getElementById(targetId);
                const isExpanded = this.dataset.expanded === 'true';
                
                const expandText = this.querySelector('.expand-text');
                const collapseText = this.querySelector('.collapse-text');
                const icon = this.querySelector('.expand-icon');
                
                if (isExpanded) {
                    // Collapse
                    targetElement.style.display = 'none';
                    expandText.style.display = 'inline';
                    collapseText.style.display = 'none';
                    icon.style.transform = 'rotate(0deg)';
                    this.dataset.expanded = 'false';
                } else {
                    // Expand
                    targetElement.style.display = 'block';
                    expandText.style.display = 'none';
                    collapseText.style.display = 'inline';
                    icon.style.transform = 'rotate(180deg)';
                    this.dataset.expanded = 'true';
                }
            });
        });
    })();
</script>

