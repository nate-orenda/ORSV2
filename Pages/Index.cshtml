@page
@model ORSV2.Pages.IndexModel
@{
    ViewData["Title"] = "Overview";
}

<div class="orenda-container">
    <!-- District Focus Header for ALL users with focus district -->
    @if (Model.FocusDistrictId.HasValue)
    {
        <div class="district-focus-header mb-4">
            <div class="d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-3">
                    <div class="focus-indicator">
                        <svg width="20" height="20" fill="currentColor" class="text-primary" viewBox="0 0 16 16">
                            <path d="M8 2a.5.5 0 0 1 .5.5v2.793l1.146-1.147a.5.5 0 0 1 .708.708L8.707 6.5H11.5a.5.5 0 0 1 0 1H8.707l1.647 1.646a.5.5 0 0 1-.708.708L8.5 8.207V11.5a.5.5 0 0 1-1 0V8.207L6.354 9.354a.5.5 0 1 1-.708-.708L7.293 7.5H4.5a.5.5 0 0 1 0-1h2.793L5.646 5.354a.5.5 0 1 1 .708-.708L7.5 5.793V2.5A.5.5 0 0 1 8 2z"/>
                        </svg>
                    </div>
                    <div>
                        <span class="text-muted small">@(Model.IsOrendaUser ? "Currently focused on:" : "Working with:")</span>
                        <h6 class="mb-0 fw-bold text-primary">@Model.FocusDistrictName</h6>
                    </div>
                </div>
                @if (Model.IsOrendaUser && Model.AvailableDistricts.Count > 1)
                {
                    <div class="dropdown">
                        <button class="btn-orenda-soft btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-arrow-repeat me-1"></i>
                            Switch District
                        </button>
                        <ul class="dropdown-menu dropdown-menu-end">
                            @foreach (var district in Model.AvailableDistricts.Where(d => d.Id != Model.FocusDistrictId))
                            {
                                <li>
                                    <a class="dropdown-item district-switch-btn" href="#" data-district-id="@district.Id">
                                        <i class="bi bi-building me-2"></i>
                                        @district.Name
                                    </a>
                                </li>
                            }
                        </ul>
                    </div>
                }
            </div>
        </div>
    }

    <!-- Welcome Header -->
    <div class="orenda-header shadow-orenda">
        <h2 class="mb-1">Welcome, @Model.UserName</h2>
        <p class="mb-0">
            @if (Model.FocusDistrictId.HasValue)
            {
                <span>Viewing @Model.FocusDistrictName district. Review the calendar for upcoming deadlines.</span>
            }
            else
            {
                <span>Select a district to begin, or review the calendar for upcoming deadlines.</span>
            }
        </p>
    </div>

    @if (Model.DistrictBlocks == null || !Model.DistrictBlocks.Any())
    {
        <div class="orenda-card shadow-orenda">
            <div class="orenda-card-body">
                <p class="mb-0 text-muted">No schools available in your scope.</p>
            </div>
        </div>
    }
    else
    {
        <div class="row g-4 mb-5 justify-content-center">
            @foreach (var district in Model.DistrictBlocks)
            {
                <div class="col-12 col-md-6 col-lg-4 d-flex">
                    <div class="orenda-card district-card-v2 w-100 @(district.IsFocused ? "focused-district" : "")">
                        <div class="district-card-header">
                            <div class="d-flex align-items-center justify-content-between">
                                <h4 class="mb-0 text-truncate flex-grow-1" title="@district.DistrictName">
                                    @district.DistrictName
                                </h4>
                                @if (district.IsFocused)
                                {
                                    <span class="focus-badge ms-2">
                                        <i class="bi bi-star-fill"></i>
                                    </span>
                                }
                                @if (Model.IsOrendaUser && !district.IsFocused)
                                {
                                    <button class="btn-focus-district ms-2" data-district-id="@district.DistrictId" title="Set as focus district">
                                        <i class="bi bi-star"></i>
                                    </button>
                                }
                            </div>
                        </div>

                        <div class="district-card-body">
                            <div class="d-flex align-items-center text-muted">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-building me-2" viewBox="0 0 16 16">
                                  <path d="M4 2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zM4 5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zM7.5 5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm2.5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zM4.5 8a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm2.5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5z"/>
                                  <path d="M2 1a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1zm11 0H3v14h3v-2.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5V15h3z"/>
                                </svg>
                                <span>@(district.Schools.Count) School@(district.Schools.Count == 1 ? "" : "s")</span>
                            </div>
                        </div>

                        <div class="district-card-footer">
                            <a href="@Url.Page("/GuidanceAlignment/Schools", new { DistrictId = district.DistrictId })" class="action-link">
                                <span>Guidance Alignment</span>
                            </a>

                            @{
                                var hasCA = district.Schools.Any(s => s.CA);
                            }
                            @if (hasCA)
                            {
                                <a href="@Url.Page("/CurriculumAlignment/Index", new { districtId = district.DistrictId })" class="action-link">
                                    <span>Curriculum Alignment</span>
                                </a>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Calendar Section - Shows focus district context -->
        <div class="orenda-card">
            <div class="orenda-card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="mb-0">
                        Guidance Alignment Calendar
                        @if (Model.IsOrendaUser)
                        {
                            @if (Model.FocusDistrictId.HasValue)
                            {
                                <span class="badge bg-light text-dark ms-2">@Model.FocusDistrictName</span>
                            }
                            else
                            {
                                <span class="badge bg-light text-dark ms-2">All Districts</span>
                            }
                        }
                        else if (Model.FocusDistrictId.HasValue)
                        {
                            <span class="badge bg-light text-dark ms-2">@Model.FocusDistrictName</span>
                        }
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn-orenda-outline btn-sm" id="calPrev" aria-label="Previous Month">&larr;</button>
                        <div class="badge-compact" id="calTitle"></div>
                        <button class="btn-orenda-outline btn-sm" id="calNext" aria-label="Next Month">&rarr;</button>
                        <button class="btn-orenda-ghost btn-sm" id="calToday">Today</button>
                    </div>
                </div>
                <div class="ga-calendar" id="gaCalendar" aria-label="Month calendar"></div>
                
                @{
                    var clientItems = Model.CalendarItems.Select(it => new {
                        date = it.Date,
                        dateStr = it.Date.ToString("yyyy-MM-dd"),
                        label = it.Label,
                        schoolId = it.SchoolId,
                        districtId = it.DistrictId,
                        districtName = it.DistrictName,
                        cp = it.Cp
                    }).ToList();
                    var json = System.Text.Json.JsonSerializer.Serialize(
                        clientItems,
                        new System.Text.Json.JsonSerializerOptions {
                            PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase
                        }
                    );
                }
                <script>
                    (function(){
                        const items = @Html.Raw(json);
                        const byDate = items.reduce((m, it) => {
                            (m[it.dateStr] ||= []).push(it);
                            return m;
                        }, {});

                        const el = document.getElementById('gaCalendar');
                        const titleEl = document.getElementById('calTitle');
                        const prevBtn = document.getElementById('calPrev');
                        const nextBtn = document.getElementById('calNext');
                        const todayBtn = document.getElementById('calToday');
                        let view = new Date();

                        function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
                        function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth() + 1, 0); }
                        function toYmd(d){
                            return [
                                d.getFullYear(),
                                String(d.getMonth()+1).padStart(2,"0"),
                                String(d.getDate()).padStart(2,"0")
                            ].join("-");
                        }

                        function render(){
                            const s = startOfMonth(view);
                            const e = endOfMonth(view);
                            const start = new Date(s);
                            start.setDate(s.getDate() - s.getDay());
                            const end = new Date(e);
                            end.setDate(e.getDate() + (6 - e.getDay()));
                            titleEl.textContent = s.toLocaleString(undefined, { month: 'long', year: 'numeric' });
                            const days = [];
                            for (let dt = new Date(start); dt <= end; dt.setDate(dt.getDate()+1)) {
                                days.push(new Date(dt));
                            }

                            const dow = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
                            let html = '<div class="ga-cal-grid">';
                            for (const h of dow) html += `<div class="ga-cal-head">${h}</div>`;
                            const todayIso = toYmd(new Date());

                            for (const d of days) {
                                const inMonth = d.getMonth() === s.getMonth();
                                const iso = toYmd(d);
                                const dayEvents = byDate[iso] || [];
                                let chipsHtml = '';
                                if (dayEvents.length > 0) {
                                    const grouped = {};
                                    for (const ev of dayEvents) {
                                        if (!grouped[ev.districtId]) {
                                            grouped[ev.districtId] = { name: ev.districtName, cps: new Set() };
                                        }
                                        grouped[ev.districtId].cps.add(ev.cp);
                                    }
                                    const districtChips = Object.values(grouped).map(g => {
                                        const cpsJoined = Array.from(g.cps).join(', ');
                                        const text = `${cpsJoined}-${g.name}`;
                                        const title = text;
                                        return `<span class="ga-chip district-chip" title="${title}">${text}</span>`;
                                    });
                                    const MAX_CHIPS = 2;
                                    const visible = districtChips.slice(0, MAX_CHIPS);
                                    const hiddenCount = districtChips.length - visible.length;
                                    if (hiddenCount > 0) {
                                        visible.push(
                                            `<span class="ga-chip" title="${hiddenCount} more">+${hiddenCount} more</span>`
                                        );
                                    }
                                    chipsHtml = visible.join('');
                                }
                                const todayCls = (iso===todayIso) ? ' is-today' : '';
                                const dimCls = inMonth ? '' : ' is-out';
                                html += `<div class="ga-cal-cell${dimCls}${todayCls}">
                                            <div class="ga-cal-date">${d.getDate()}</div>
                                            <div class="ga-cal-chips">${chipsHtml}</div>
                                         </div>`;
                            }
                            html += '</div>';
                            el.innerHTML = html;
                        }
                        prevBtn.addEventListener('click', () => { view.setMonth(view.getMonth()-1); render(); });
                        nextBtn.addEventListener('click', () => { view.setMonth(view.getMonth()+1); render(); });
                        todayBtn.addEventListener('click', () => { view = new Date(); render(); });
                        render();
                    })();
                </script>
            </div>
        </div>
    }
</div>

<!-- District Selection Modal for First-Time Orenda Users -->
@if (Model.ShowDistrictSelector)
{
    <div class="modal fade" id="districtSelectorModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content shadow-orenda">
                <div class="modal-header bg-orenda-primary text-white">
                    <h5 class="modal-title">
                        <i class="bi bi-building me-2"></i>
                        Select Your Focus District
                    </h5>
                </div>
                <div class="modal-body">
                    <p class="mb-4">Please select a district to focus on. This will be used as your default for navigation and calendar views. You can change this anytime from the header dropdown.</p>
                    
                    <div class="district-options">
                        @foreach (var district in Model.AvailableDistricts)
                        {
                            <div class="district-option" data-district-id="@district.Id">
                                <div class="d-flex align-items-center p-3 border rounded hover-shadow">
                                    <div class="me-3">
                                        <i class="bi bi-building text-primary fs-4"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1">@district.Name</h6>
                                        <small class="text-muted">Click to set as focus district</small>
                                    </div>
                                    <div>
                                        <i class="bi bi-chevron-right text-muted"></i>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
                <div class="modal-footer">
                    <p class="text-muted small mb-0">
                        <i class="bi bi-info-circle me-1"></i>
                        You'll still be able to view all districts, but this will be your primary focus.
                    </p>
                </div>
            </div>
        </div>
    </div>
}

<script>
    (function(){
        // District Focus Functionality
        function setFocusDistrict(districtId) {
            // Find district name from available districts
            const districtName = document.querySelector(`[data-district-id="${districtId}"]`)?.textContent?.trim() || 'District';
            
            // Update localStorage for navigation consistency
            if (window.setOrendaFocusDistrict) {
                window.setOrendaFocusDistrict({ id: districtId, name: districtName });
            }

            fetch('/Index?handler=SetFocus', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: `districtId=${districtId}`
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Dispatch event for other components
                    window.dispatchEvent(new CustomEvent('focusDistrictChanged', { 
                        detail: { id: districtId, name: districtName } 
                    }));
                    
                    // Reload page to show new focus
                    window.location.href = `/?setFocus=${districtId}`;
                } else {
                    alert('Failed to set focus district. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please try again.');
            });
        }

        // Handle district switching from dropdown (Orenda users only)
        document.querySelectorAll('.district-switch-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const districtId = btn.dataset.districtId;
                setFocusDistrict(districtId);
            });
        });

        // Handle focus buttons on district cards (Orenda users only)
        document.querySelectorAll('.btn-focus-district').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const districtId = btn.dataset.districtId;
                setFocusDistrict(districtId);
            });
        });

        // Handle district selection modal (Orenda users only)
        const modal = document.getElementById('districtSelectorModal');
        if (modal) {
            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();

            document.querySelectorAll('.district-option').forEach(option => {
                option.addEventListener('click', () => {
                    const districtId = option.dataset.districtId;
                    modalInstance.hide();
                    setFocusDistrict(districtId);
                });
            });
        }

        // Collapse/expand functionality for districts (keeping existing)
        function toggle(el){
            const targetSel = el.getAttribute('data-target');
            const panel = document.querySelector(targetSel);
            if(!panel) return;
            const expanded = el.getAttribute('aria-expanded') === 'true';
            el.setAttribute('aria-expanded', expanded ? 'false' : 'true');
            panel.classList.toggle('is-collapsed', expanded);
            if(!expanded){
                panel.style.maxHeight = panel.scrollHeight + 'px';
                setTimeout(()=>{ panel.style.maxHeight = ''; }, 260);
            }else{
                panel.style.maxHeight = panel.scrollHeight + 'px';
                requestAnimationFrame(()=>{ panel.style.maxHeight = '0px'; });
                setTimeout(()=>{ panel.style.maxHeight = ''; }, 260);
            }
        }

        document.addEventListener('click', function(e){
            const btn = e.target.closest('.district-header-toggle');
            if(!btn) return;
            e.preventDefault();
            toggle(btn);
        });

        // Initialize collapsed panels
        document.querySelectorAll('.district-header-toggle').forEach(btn=>{
            btn.setAttribute('aria-expanded','false');
        });
        document.querySelectorAll('.collapse-body').forEach(p=>{
            p.classList.add('is-collapsed');
        });
    })();
</script>