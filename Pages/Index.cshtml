@page
@model ORSV2.Pages.IndexModel
@{
    ViewData["Title"] = "Overview";
}

<div class="orenda-container">
    <div class="orenda-header shadow-orenda">
        <h2 class="mb-1">Welcome, @Model.UserName</h2>
        <p class="mb-0">Select a district to begin, or review the calendar for upcoming deadlines.</p>
    </div>

    @if (Model.DistrictBlocks == null || !Model.DistrictBlocks.Any())
    {
        <div class="orenda-card shadow-orenda">
            <div class="orenda-card-body">
                <p class="mb-0 text-muted">No schools available in your scope.</p>
            </div>
        </div>
    }
    else
    {
        <div class="row g-4 mb-5 justify-content-center">
            @foreach (var district in Model.DistrictBlocks)
            {
                <div class="col-12 col-md-6 col-lg-4 d-flex">
                    <div class="orenda-card district-card-v2 w-100">
                        <div class="district-card-header">
                            <h4 class="mb-0 text-truncate" title="@district.DistrictName">
                                @district.DistrictName
                            </h4>
                        </div>

                        <div class="district-card-body">
                            <div class="d-flex align-items-center text-muted">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-building me-2" viewBox="0 0 16 16">
                                  <path d="M4 2.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3 0a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zM4 5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zM7.5 5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm2.5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zM4.5 8a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5zm2.5.5a.5.5 0 0 1 .5-.5h1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-1a.5.5 0 0 1-.5-.5zm3.5-.5a.5.5 0 0 0-.5.5v1a.5.5 0 0 0 .5.5h1a.5.5 0 0 0 .5-.5v-1a.5.5 0 0 0-.5-.5z"/>
                                  <path d="M2 1a1 1 0 0 1 1-1h10a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1zm11 0H3v14h3v-2.5a.5.5 0 0 1 .5-.5h3a.5.5 0 0 1 .5.5V15h3z"/>
                                </svg>
                                <span>@(district.Schools.Count) School@(district.Schools.Count == 1 ? "" : "s")</span>
                            </div>
                        </div>

                        <div class="district-card-footer">
                            <a href="@Url.Page("/GuidanceAlignment/Schools", new { DistrictId = district.DistrictId })" class="action-link">
                                <span>Guidance Alignment</span>
                            </a>

                            @{
                                var hasCA = district.Schools.Any(s => s.CA);
                            }
                            @if (hasCA)
                            {
                                <a href="@Url.Page("/CurriculumAlignment/Index", new { districtId = district.DistrictId })" class="action-link">
                                    <span>Curriculum Alignment</span>
                                </a>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>


        <div class="orenda-card">
            <div class="orenda-card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="mb-0">Guidance Alignment Calendar</h5>
                    <div class="d-flex gap-2">
                        <button class="btn-orenda-outline btn-sm" id="calPrev" aria-label="Previous Month">&larr;</button>
                        <div class="badge-compact" id="calTitle"></div>
                        <button class="btn-orenda-outline btn-sm" id="calNext" aria-label="Next Month">&rarr;</button>
                        <button class="btn-orenda-ghost btn-sm" id="calToday">Today</button>
                    </div>
                </div>
                <div class="ga-calendar" id="gaCalendar" aria-label="Month calendar"></div>
                @{
                    // This C# block for JSON serialization remains exactly the same.
                    var clientItems = Model.CalendarItems.Select(it => new {
                        date = it.Date,
                        dateStr = it.Date.ToString("yyyy-MM-dd"),
                        label = it.Label,
                        schoolId = it.SchoolId,
                        districtId = it.DistrictId,
                        districtName = it.DistrictName,
                        cp = it.Cp
                    }).ToList();
                    var json = System.Text.Json.JsonSerializer.Serialize(
                        clientItems,
                        new System.Text.Json.JsonSerializerOptions {
                            PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase
                        }
                    );
                }
                <script>
                    (function(){
                        const items = @Html.Raw(json);
                        const byDate = items.reduce((m, it) => {
                            (m[it.dateStr] ||= []).push(it);
                            return m;
                        }, {});

                        const el = document.getElementById('gaCalendar');
                        const titleEl = document.getElementById('calTitle');
                        const prevBtn = document.getElementById('calPrev');
                        const nextBtn = document.getElementById('calNext');
                        const todayBtn = document.getElementById('calToday');
                        let view = new Date();

                        function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
                        function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth() + 1, 0); }
                        function toYmd(d){
                            return [
                                d.getFullYear(),
                                String(d.getMonth()+1).padStart(2,"0"),
                                String(d.getDate()).padStart(2,"0")
                            ].join("-");
                        }

                        function render(){
                            const s = startOfMonth(view);
                            const e = endOfMonth(view);
                            const start = new Date(s);
                            start.setDate(s.getDate() - s.getDay());
                            const end = new Date(e);
                            end.setDate(e.getDate() + (6 - e.getDay()));
                            titleEl.textContent = s.toLocaleString(undefined, { month: 'long', year: 'numeric' });
                            const days = [];
                            for (let dt = new Date(start); dt <= end; dt.setDate(dt.getDate()+1)) {
                                days.push(new Date(dt));
                            }

                            const dow = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
                            let html = '<div class="ga-cal-grid">';
                            for (const h of dow) html += `<div class="ga-cal-head">${h}</div>`;
                            const todayIso = toYmd(new Date());

                            for (const d of days) {
                                const inMonth = d.getMonth() === s.getMonth();
                                const iso = toYmd(d);
                                const dayEvents = byDate[iso] || [];
                                let chipsHtml = '';
                                if (dayEvents.length > 0) {
                                    const grouped = {};
                                    for (const ev of dayEvents) {
                                        if (!grouped[ev.districtId]) {
                                            grouped[ev.districtId] = { name: ev.districtName, cps: new Set() };
                                        }
                                        grouped[ev.districtId].cps.add(ev.cp);
                                    }
                                    const districtChips = Object.values(grouped).map(g => {
                                        const cpsJoined = Array.from(g.cps).join(', ');
                                        const text = `${cpsJoined}-${g.name}`;
                                        const title = text;
                                        return `<span class="ga-chip district-chip" title="${title}">${text}</span>`;
                                    });
                                    const MAX_CHIPS = 2;
                                    const visible = districtChips.slice(0, MAX_CHIPS);
                                    const hiddenCount = districtChips.length - visible.length;
                                    if (hiddenCount > 0) {
                                        visible.push(
                                            `<span class="ga-chip" title="${hiddenCount} more">+${hiddenCount} more</span>`
                                        );
                                    }
                                    chipsHtml = visible.join('');
                                }
                                const todayCls = (iso===todayIso) ? ' is-today' : '';
                                const dimCls = inMonth ? '' : ' is-out';
                                html += `<div class="ga-cal-cell${dimCls}${todayCls}">
                                            <div class="ga-cal-date">${d.getDate()}</div>
                                            <div class="ga-cal-chips">${chipsHtml}</div>
                                         </div>`;
                            }
                            html += '</div>';
                            el.innerHTML = html;
                        }
                        prevBtn.addEventListener('click', () => { view.setMonth(view.getMonth()-1); render(); });
                        nextBtn.addEventListener('click', () => { view.setMonth(view.getMonth()+1); render(); });
                        todayBtn.addEventListener('click', () => { view = new Date(); render(); });
                        render();
                    })();
                </script>
            </div>
        </div>
        }
</div>

<script>
  (function(){
    function toggle(el){
      const targetSel = el.getAttribute('data-target');
      const panel = document.querySelector(targetSel);
      if(!panel) return;
      const expanded = el.getAttribute('aria-expanded') === 'true';
      el.setAttribute('aria-expanded', expanded ? 'false' : 'true');
      panel.classList.toggle('is-collapsed', expanded);
      if(!expanded){
        panel.style.maxHeight = panel.scrollHeight + 'px';
        setTimeout(()=>{ panel.style.maxHeight = ''; }, 260);
      }else{
        panel.style.maxHeight = panel.scrollHeight + 'px';
        requestAnimationFrame(()=>{ panel.style.maxHeight = '0px'; });
        setTimeout(()=>{ panel.style.maxHeight = ''; }, 260);
      }
    }

    document.addEventListener('click', function(e){
      const btn = e.target.closest('.district-header-toggle');
      if(!btn) return;
      e.preventDefault();
      toggle(btn);
    });

    // initialize all panels as collapsed on page load
    document.querySelectorAll('.district-header-toggle').forEach(btn=>{
      btn.setAttribute('aria-expanded','false');
    });
    document.querySelectorAll('.collapse-body').forEach(p=>{
      p.classList.add('is-collapsed');
    });
  })();
</script>
