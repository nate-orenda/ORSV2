@page
@model ORSV2.Pages.IndexModel
@{
    ViewData["Title"] = "Overview";
}

<div class="orenda-container">
    <div class="orenda-header shadow-orenda">
        <h2 class="mb-1">Welcome, @Model.UserName</h2>
        <p class="mb-0">Choose a school to dive into Guidance Alignment.</p>
    </div>

    @if (Model.DistrictBlocks == null || !Model.DistrictBlocks.Any())
    {
        <div class="orenda-card shadow-orenda">
            <div class="orenda-card-body">
                <p class="mb-0 text-muted">No schools available in your scope.</p>
            </div>
        </div>
    }
    else
    {
        foreach (var district in Model.DistrictBlocks)
        {
            var bodyId = $"district-body-{district.DistrictId}";

            <section class="mb-4 ga-section visible">
                <button class="district-header-toggle w-100 d-flex align-items-center justify-content-between"
                        type="button"
                        aria-expanded="true"
                        aria-controls="@bodyId"
                        data-target="#@bodyId">
                    <h4 class="mb-0 text-truncate" title="@district.DistrictName">@district.DistrictName</h4>
                    <div class="d-flex align-items-center gap-2">
                        <span class="badge school-badge">
                            @(district.Schools.Count) School@(district.Schools.Count == 1 ? "" : "s")
                        </span>
                        <span class="chevron" aria-hidden="true">▾</span>
                    </div>
                </button>

                <div id="@bodyId" class="collapse-body mt-3">
                    <div class="row g-3">
                        @foreach (var s in district.Schools)
                        {
                            <div class="col-12 col-sm-6 col-lg-4">
                                <div class="orenda-card shadow-orenda-hover smooth-transition h-100">
                                    <div class="orenda-card-body py-3 position-relative" style="min-width:0;">

                                    @{
                                        var cpText = (s.CurrentCP.HasValue && s.CurrentCP.Value > 0)
                                            ? s.CurrentCP.Value.ToString()
                                            : "—";

                                        var gaUpdatedText = s.GAResultsLastUpdated.HasValue
                                            ? s.GAResultsLastUpdated.Value.ToString("MMM d, yyyy")
                                            : "—";
                                    }

                                    <!-- Title -->
                                    <div class="d-flex align-items-center justify-content-between gap-2 flex-nowrap mb-2">
                                        <h5 class="mb-0 text-orenda-primary text-truncate me-2"
                                            title="@s.SchoolName"
                                            style="font-weight:600; max-width:100%;">
                                        @s.SchoolName
                                        </h5>
                                    </div>

                                    <!-- Data box -->
                                    <div class="d-flex flex-column gap-1 small text-muted">

                                        <!-- Enrollment inline -->
                                        <div class="orenda-summary-item">
                                        <span class="orenda-summary-label">Enrollment:</span>
                                        <span class="fw-semibold ms-1">@s.Enrollment</span>
                                        </div>

                                        <!-- GA row: green ✓ or red ✕ next to words -->
                                        <div class="orenda-summary-item">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="orenda-summary-label">Guidance Alignment</span>
                                            @if (s.GA)
                                            {
                                            <span class="text-success fs-6" title="Enabled" aria-hidden="true">✓</span>
                                            <span class="visually-hidden">Enabled</span>
                                            }
                                            else
                                            {
                                            <span class="text-danger fs-6" title="Not enabled" aria-hidden="true">✕</span>
                                            <span class="visually-hidden">Not enabled</span>
                                            }
                                            
                                        </div>
                                        </div>

                                        <!-- CP line -->
                                        <div class="small text-muted" style="margin-top:-.2rem;">
                                        Checkpoint: @(s.CurrentCP.HasValue && s.CurrentCP.Value > 0 ? s.CurrentCP.Value.ToString() : "—")
                                        </div>

                                        <!-- Date line -->
                                        <div class="small text-muted" style="margin-top:-.2rem;">
                                        Last Updated: @(s.GAResultsLastUpdated.HasValue ? s.GAResultsLastUpdated.Value.ToString("MMM d, yyyy") : "—")
                                        </div>

                                        <!-- CA row: green ✓ or red ✕ next to words -->
                                        <div class="orenda-summary-item">
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="orenda-summary-label">Curriculum Alignment</span>
                                            @if (s.CA)
                                            {
                                            <span class="text-success fs-6" title="Enabled" aria-hidden="true">✓</span>
                                            <span class="visually-hidden">Enabled</span>
                                            }
                                            else
                                            {
                                            <span class="text-danger fs-6" title="Not enabled" aria-hidden="true">✕</span>
                                            <span class="visually-hidden">Not enabled</span>
                                            }
                                            
                                        </div>
                                        </div>


                                    </div>
                                    </div>
                                </div>
                                </div>

                        }
                    </div>
                </div>
            </section>
        }
    }
</div>

<script>
  (function(){
    function toggle(el){
      const targetSel = el.getAttribute('data-target');
      const panel = document.querySelector(targetSel);
      if(!panel) return;
      const expanded = el.getAttribute('aria-expanded') === 'true';
      el.setAttribute('aria-expanded', expanded ? 'false' : 'true');
      panel.classList.toggle('is-collapsed', expanded);
      if(!expanded){
        panel.style.maxHeight = panel.scrollHeight + 'px';
        setTimeout(()=>{ panel.style.maxHeight = ''; }, 260);
      }else{
        panel.style.maxHeight = panel.scrollHeight + 'px';
        requestAnimationFrame(()=>{ panel.style.maxHeight = '0px'; });
        setTimeout(()=>{ panel.style.maxHeight = ''; }, 260);
      }
    }

    document.addEventListener('click', function(e){
      const btn = e.target.closest('.district-header-toggle');
      if(!btn) return;
      e.preventDefault();
      toggle(btn);
    });

    // initialize all panels as collapsed on page load
    document.querySelectorAll('.district-header-toggle').forEach(btn=>{
      btn.setAttribute('aria-expanded','false');
    });
    document.querySelectorAll('.collapse-body').forEach(p=>{
      p.classList.add('is-collapsed');
    });
  })();
</script>

