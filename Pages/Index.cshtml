@page
@model ORSV2.Pages.IndexModel
@{
    ViewData["Title"] = "Overview";
}

<div class="orenda-container">
    <!-- Welcome Header -->
    <div class="orenda-header shadow-orenda">
        <h2 class="mb-1">Welcome, @Model.UserName</h2>
        <p class="mb-0">Review the calendar for upcoming deadlines and select a district to get started.</p>
    </div>

    @if (Model.DistrictBlocks == null || !Model.DistrictBlocks.Any())
    {
        <div class="orenda-card shadow-orenda">
            <div class="orenda-card-body">
                <p class="mb-0 text-muted">No schools available in your scope.</p>
            </div>
        </div>
    }
    else
    {
        <div class="row g-4 mb-5 justify-content-center">
            @foreach (var district in Model.DistrictBlocks)
            {
                var hasGA = district.Schools.Any(s => s.GA);
                var hasCA = district.Schools.Any(s => s.CA);
                var totalEnrollment = district.Schools.Sum(s => s.Enrollment);
                var gaEnabledCount = district.Schools.Count(s => s.GA);
                var caEnabledCount = district.Schools.Count(s => s.CA);
                var districtId = $"district-{district.DistrictId}";
                
                <div class="col-12 col-md-6 col-lg-4 d-flex">
                    <div class="orenda-card district-card-v2 w-100">
                        <div class="district-card-header">
                            <div class="d-flex align-items-center justify-content-between">
                                <h4 class="mb-0 text-truncate flex-grow-1" title="@district.DistrictName">
                                    @district.DistrictName
                                </h4>
                            </div>
                        </div>

                        <div class="district-card-body">
                            <!-- Quick Stats Row -->
                            <div class="row g-3 mb-3">
                                <div class="col-6">
                                    <div class="district-stat">
                                        <div class="district-stat-number">@district.Schools.Count</div>
                                        <div class="district-stat-label">School@(district.Schools.Count == 1 ? "" : "s")</div>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <div class="district-stat">
                                        <div class="district-stat-number">@totalEnrollment.ToString("N0")</div>
                                        <div class="district-stat-label">Students</div>
                                    </div>
                                </div>
                            </div>

                            <!-- School List Preview -->
                            <div class="district-schools-preview">
                                @{
                                    var schoolsToShow = district.Schools.Take(3).ToList();
                                    var remainingSchools = district.Schools.Skip(3).ToList();
                                }
                                
                                <!-- Always visible schools -->
                                <div class="schools-visible">
                                    @foreach (var school in schoolsToShow)
                                    {
                                        <div class="school-preview-item">
                                            <span class="school-name">@school.SchoolName</span>
                                            <span class="school-enrollment">@school.Enrollment.ToString("N0")</span>
                                        </div>
                                    }
                                </div>
                                
                                <!-- Expandable additional schools -->
                                @if (remainingSchools.Any())
                                {
                                    <div class="schools-expandable" id="@($"{districtId}-schools")" style="display: none;">
                                        @foreach (var school in remainingSchools)
                                        {
                                            <div class="school-preview-item">
                                                <span class="school-name">@school.SchoolName</span>
                                                <span class="school-enrollment">@school.Enrollment.ToString("N0")</span>
                                            </div>
                                        }
                                    </div>
                                    
                                    <!-- Toggle button -->
                                    <div class="school-preview-toggle">
                                        <button type="button" 
                                                class="school-expand-btn" 
                                                data-target="@($"{districtId}-schools")"
                                                data-expanded="false">
                                            <span class="expand-text">+@remainingSchools.Count more school@(remainingSchools.Count == 1 ? "" : "s")</span>
                                            <span class="collapse-text" style="display: none;">Show less</span>
                                            <i class="bi bi-chevron-down expand-icon ms-1"></i>
                                        </button>
                                    </div>
                                }
                                
                                @if (!remainingSchools.Any() && district.Schools.Count <= 3)
                                {
                                    <!-- No expand needed, but keep consistent spacing -->
                                }
                            </div>

                            <!-- Program Availability -->
                            <div class="district-programs mt-3">
                                @if (hasGA)
                                {
                                    <span class="program-badge program-ga">
                                        <i class="bi bi-compass me-1"></i>
                                        GA (@gaEnabledCount)
                                    </span>
                                }
                                @if (hasCA)
                                {
                                    <span class="program-badge program-ca">
                                        <i class="bi bi-book me-1"></i>
                                        CA (@caEnabledCount)
                                    </span>
                                }
                                @if (!hasGA && !hasCA)
                                {
                                    <span class="program-badge program-none">
                                        <i class="bi bi-info-circle me-1"></i>
                                        No programs enabled
                                    </span>
                                }
                            </div>
                        </div>

                        <div class="district-card-footer">
                            @if (hasGA)
                            {
                                <a href="@Url.Page("/GuidanceAlignment/Schools", new { DistrictId = district.DistrictId })" class="action-link">
                                    <span>Guidance Alignment</span>
                                </a>
                            }

                            @if (hasCA)
                            {
                                <a href="@Url.Page("/CurriculumAlignment/Forms", new { districtId = district.DistrictId })" class="action-link">
                                    <span>Curriculum Alignment</span>
                                </a>
                            }

                            @if (!hasGA && !hasCA)
                            {
                                <div class="text-muted text-center py-2">
                                    <small>Configure schools to enable programs</small>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>

        <!-- Calendar Section -->
        <div class="orenda-card">
            <div class="orenda-card-body">
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <h5 class="mb-0">
                        Guidance Alignment Calendar
                        @if (Model.IsOrendaUser)
                        {
                            <span class="badge bg-light text-dark ms-2">All Districts</span>
                        }
                        else
                        {
                            <span class="badge bg-light text-dark ms-2">My Districts</span>
                        }
                    </h5>
                    <div class="d-flex gap-2">
                        <button class="btn-orenda-outline btn-sm" id="calPrev" aria-label="Previous Month">&larr;</button>
                        <div class="badge-compact" id="calTitle"></div>
                        <button class="btn-orenda-outline btn-sm" id="calNext" aria-label="Next Month">&rarr;</button>
                        <button class="btn-orenda-ghost btn-sm" id="calToday">Today</button>
                    </div>
                </div>
                <div class="ga-calendar" id="gaCalendar" aria-label="Month calendar"></div>
                
                @{
                    var clientItems = Model.CalendarItems.Select(it => new {
                        date = it.Date,
                        dateStr = it.Date.ToString("yyyy-MM-dd"),
                        label = it.Label,
                        schoolId = it.SchoolId,
                        districtId = it.DistrictId,
                        districtName = it.DistrictName,
                        cp = it.Cp
                    }).ToList();
                    var json = System.Text.Json.JsonSerializer.Serialize(
                        clientItems,
                        new System.Text.Json.JsonSerializerOptions {
                            PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase
                        }
                    );
                }
                <script>
                    (function(){
                        const items = @Html.Raw(json);
                        const byDate = items.reduce((m, it) => {
                            (m[it.dateStr] ||= []).push(it);
                            return m;
                        }, {});

                        const el = document.getElementById('gaCalendar');
                        const titleEl = document.getElementById('calTitle');
                        const prevBtn = document.getElementById('calPrev');
                        const nextBtn = document.getElementById('calNext');
                        const todayBtn = document.getElementById('calToday');
                        let view = new Date();

                        function startOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
                        function endOfMonth(d){ return new Date(d.getFullYear(), d.getMonth() + 1, 0); }
                        function toYmd(d){
                            return [
                                d.getFullYear(),
                                String(d.getMonth()+1).padStart(2,"0"),
                                String(d.getDate()).padStart(2,"0")
                            ].join("-");
                        }

                        function render(){
                            const s = startOfMonth(view);
                            const e = endOfMonth(view);
                            const start = new Date(s);
                            start.setDate(s.getDate() - s.getDay());
                            const end = new Date(e);
                            end.setDate(e.getDate() + (6 - e.getDay()));
                            titleEl.textContent = s.toLocaleString(undefined, { month: 'long', year: 'numeric' });
                            const days = [];
                            for (let dt = new Date(start); dt <= end; dt.setDate(dt.getDate()+1)) {
                                days.push(new Date(dt));
                            }

                            const dow = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
                            let html = '<div class="ga-cal-grid">';
                            for (const h of dow) html += `<div class="ga-cal-head">${h}</div>`;
                            const todayIso = toYmd(new Date());

                            for (const d of days) {
                                const inMonth = d.getMonth() === s.getMonth();
                                const iso = toYmd(d);
                                const dayEvents = byDate[iso] || [];
                                let chipsHtml = '';
                                if (dayEvents.length > 0) {
                                    const grouped = {};
                                    for (const ev of dayEvents) {
                                        if (!grouped[ev.districtId]) {
                                            grouped[ev.districtId] = { name: ev.districtName, cps: new Set() };
                                        }
                                        grouped[ev.districtId].cps.add(ev.cp);
                                    }
                                    const districtChips = Object.values(grouped).map(g => {
                                        const cpsJoined = Array.from(g.cps).join(', ');
                                        const text = `${cpsJoined}-${g.name}`;
                                        const title = text;
                                        return `<span class="ga-chip district-chip" title="${title}">${text}</span>`;
                                    });
                                    const MAX_CHIPS = 2;
                                    const visible = districtChips.slice(0, MAX_CHIPS);
                                    const hiddenCount = districtChips.length - visible.length;
                                    if (hiddenCount > 0) {
                                        visible.push(
                                            `<span class="ga-chip" title="${hiddenCount} more">+${hiddenCount} more</span>`
                                        );
                                    }
                                    chipsHtml = visible.join('');
                                }
                                const todayCls = (iso===todayIso) ? ' is-today' : '';
                                const dimCls = inMonth ? '' : ' is-out';
                                html += `<div class="ga-cal-cell${dimCls}${todayCls}">
                                            <div class="ga-cal-date">${d.getDate()}</div>
                                            <div class="ga-cal-chips">${chipsHtml}</div>
                                         </div>`;
                            }
                            html += '</div>';
                            el.innerHTML = html;
                        }
                        prevBtn.addEventListener('click', () => { view.setMonth(view.getMonth()-1); render(); });
                        nextBtn.addEventListener('click', () => { view.setMonth(view.getMonth()+1); render(); });
                        todayBtn.addEventListener('click', () => { view = new Date(); render(); });
                        render();
                    })();
                </script>
            </div>
        </div>
    }
</div>

<!-- School Expansion JavaScript -->
<script>
    (function() {
        // Handle school list expansion
        document.querySelectorAll('.school-expand-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const targetId = this.dataset.target;
                const targetElement = document.getElementById(targetId);
                const isExpanded = this.dataset.expanded === 'true';
                
                const expandText = this.querySelector('.expand-text');
                const collapseText = this.querySelector('.collapse-text');
                const icon = this.querySelector('.expand-icon');
                
                if (isExpanded) {
                    // Collapse
                    targetElement.style.display = 'none';
                    expandText.style.display = 'inline';
                    collapseText.style.display = 'none';
                    icon.style.transform = 'rotate(0deg)';
                    this.dataset.expanded = 'false';
                } else {
                    // Expand
                    targetElement.style.display = 'block';
                    expandText.style.display = 'none';
                    collapseText.style.display = 'inline';
                    icon.style.transform = 'rotate(180deg)';
                    this.dataset.expanded = 'true';
                }
            });
        });
    })();
</script>