@page
@model ORSV2.Pages.DataReflection.Form3Model

@{
    var batchForTitle = Model.AvailableBatches.FirstOrDefault(b => b.Value == Model.BatchId);
    var schoolForTitle = Model.AvailableSchools.FirstOrDefault(s => s.Value == Model.SchoolId?.ToString());
    
    var dynamicTitle = batchForTitle != null 
        ? $"{batchForTitle.Text} - {schoolForTitle?.Text ?? "All Schools"} - Form 3"
        : "DRS – Form 3";
    
    ViewData["Title"] = dynamicTitle;
}
@await Html.PartialAsync("_Breadcrumbs", Model.Breadcrumbs)

<style>
    /* Custom styles for Form 3 */
    .form3-table {
        font-size: 1rem;
        table-layout: fixed; /* Enable fixed column widths */
    }
    
    /* Narrow columns for Teacher and Period */
    .form3-table .teacher-col {
        width: 10%;
        min-width: 100px;
    }
    
    .form3-table .period-col {
        width: 5%;
        min-width: 50px;
    }
    
    /* Equal width for all standard data columns (Passed/Not Passed) */
    .form3-table .standard-col {
        width: auto; /* Will distribute remaining space equally */
    }
    
    /* Standard group headers span 2 columns */
    .form3-table .standard-group {
        /* Width will be 2x standard-col since it has colspan="2" */
    }
    
    /* Teacher name formatting with line breaks */
    .teacher-name-cell {
        white-space: normal !important;
        word-wrap: break-word;
        line-height: 1.3;
        font-size: 0.9rem;
    }
    
    /* Header text wrapping for narrow columns */
    .teacher-col, .period-col {
        white-space: normal !important;
        word-wrap: break-word;
        line-height: 1.2;
    }
    
    /* Stacked passed/not passed styling */
    .stacked-cell {
        white-space: normal !important;
        line-height: 1.3;
        padding: 0.4rem 0.25rem !important;
    }
    
    .passed-line {
        font-size: 0.9rem;
        line-height: 1.3;
        padding-bottom: 0.2rem;
    }
    
    .not-passed-line {
        font-size: 0.9rem;
        line-height: 1.3;
        padding-top: 0.2rem;
        border-top: 1px solid #f0f0f0; /* Barely visible divider */
    }
    
    .sub-header-row .passed-line {
        font-size: 0.75rem;
        font-weight: normal;
        padding-bottom: 0.15rem;
    }
    
    .sub-header-row .not-passed-line {
        font-size: 0.75rem;
        font-weight: normal;
        border-top: 1px solid #f0f0f0; /* Barely visible divider */
        padding-top: 0.15rem;
    }
    
    /* Prominent borders between teacher rows */
    .teacher-row td {
        border-bottom: 2px solid #000 !important;
    }
    
    /* Darker border between headers and first teacher */
    .form3-table tbody tr:first-child td {
        border-top: 2px solid #000 !important;
    }
    
    .form3-table th {
        font-size: 0.95rem;
        padding: 0.6rem 0.4rem;
        vertical-align: middle;
    }
    
    .form3-table td {
        font-size: 0.95rem;
        padding: 0.5rem 0.35rem;
        vertical-align: middle;
    }
    
    .pass-not-pass-header {
        line-height: 1.4;
        margin-bottom: 0.2rem;
    }
    
    .pass-not-pass-header .fw-semibold {
        display: block;
        margin-bottom: 0.25rem;
        font-size: 1rem;
        font-weight: bold;
    }
    
    .pass-not-pass-header .small {
        display: block;
        font-size: 0.8rem;
        line-height: 1.3;
        font-weight: normal;
    }
    
    .sub-header-row th {
        font-size: 0.85rem;
        padding: 0.4rem 0.3rem;
        line-height: 1.3;
        border-top: 1px solid #dee2e6;
    }
    
    .percentage-cell {
        white-space: nowrap;
    }
    
    .percentage-cell .text-muted {
        font-size: 0.85rem;
        margin-left: 0.15rem;
    }
    
    .compact-nowrap {
        white-space: nowrap;
        font-size: 0.95rem;
    }
    
    .table-compact {
        margin-bottom: 0.5rem;
    }
    
    .form3-footer-note {
        font-size: 0.9rem;
        margin-top: 0.75rem;
        padding: 0.5rem 0;
    }
    
    /* Alternating column backgrounds for better readability */
    .form3-table .standard-group-even {
        background-color: #f1f3f4 !important;
    }
    
    .form3-table .standard-group-odd {
        background-color: #ffffff !important;
    }
    
    /* Ensure alternating colors work in all table sections */
    .form3-table thead .standard-group-even,
    .form3-table tbody .standard-group-even,
    .form3-table tfoot .standard-group-even {
        background-color: #f1f3f4 !important;
    }
    
    .form3-table thead .standard-group-odd,
    .form3-table tbody .standard-group-odd,
    .form3-table tfoot .standard-group-odd {
        background-color: #ffffff !important;
    }
    
    /* Print styles */
    @@media print {
        /* Hide everything first */
        body * {
            visibility: hidden !important;
        }
        
        /* Only show the table and print title */
        .form3-table,
        .form3-table *,
        .print-title,
        .print-title * {
            visibility: visible !important;
        }
        
        /* Reset body and html for clean positioning */
        html, body {
            margin: 0 !important;
            padding: 0 !important;
            height: auto !important;
        }
        
        /* Position print title at top */
        .print-title {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            text-align: center !important;
            font-size: 14pt !important;
            font-weight: bold !important;
            padding: 0.15in 0 !important;
            background: white !important;
            z-index: 1000 !important;
            display: block !important;
            visibility: visible !important;
        }
        
        /* Position table container below title with more buffer */
        .table-responsive {
            position: fixed !important;
            top: 0.65in !important;
            left: 0 !important;
            width: 100% !important;
            height: calc(100% - 0.65in) !important;
            margin: 0 !important;
            padding: 0 0.15in !important;
            visibility: visible !important;
        }
        
        /* Table styling with top border */
        .form3-table {
            width: 100% !important;
            font-size: 9pt !important;
            margin: 0 !important;
            border-collapse: collapse !important;
            position: relative !important;
            border-top: 2px solid #000 !important;
            table-layout: fixed !important; /* Enable fixed column widths */
        }
        
        /* Narrow columns for Teacher and Period */
        .form3-table .teacher-col {
            width: 10% !important;
        }
        
        .form3-table .period-col {
            width: 5% !important;
        }
        
        /* Equal width for all standard data columns (Passed/Not Passed) */
        .form3-table .standard-col {
            width: auto !important; /* Will distribute remaining space equally */
        }
        
        /* Standard group headers span 2 columns */
        .form3-table .standard-group {
            /* Width will be 2x standard-col since it has colspan="2" */
        }
        
        /* Teacher name formatting with line breaks for print */
        .teacher-name-cell {
            white-space: normal !important;
            word-wrap: break-word !important;
            line-height: 1.3 !important;
            font-size: 8.5pt !important;
        }
        
        /* Header text wrapping for narrow columns in print */
        .teacher-col, .period-col {
            white-space: normal !important;
            word-wrap: break-word !important;
            line-height: 1.2 !important;
        }
        
        /* Stacked passed/not passed styling for print */
        .stacked-cell {
            white-space: normal !important;
            line-height: 1.3 !important;
            padding: 0.3rem 0.15rem !important;
        }
        
        .passed-line {
            font-size: 8.5pt !important;
            line-height: 1.3 !important;
            padding-bottom: 0.15rem !important;
        }
        
        .not-passed-line {
            font-size: 8.5pt !important;
            line-height: 1.3 !important;
            padding-top: 0.15rem !important;
            border-top: 1px solid #e8e8e8 !important; /* Barely visible divider for print */
        }
        
        .sub-header-row .passed-line {
            font-size: 7.5pt !important;
            font-weight: normal !important;
            padding-bottom: 0.1rem !important;
        }
        
        .sub-header-row .not-passed-line {
            font-size: 7.5pt !important;
            font-weight: normal !important;
            border-top: 1px solid #e8e8e8 !important; /* Barely visible divider for print */
            padding-top: 0.1rem !important;
        }
        
        /* Prominent borders between teacher rows in print */
        .teacher-row td {
            border-bottom: 2px solid #000 !important;
        }
        
        /* Darker border between headers and first teacher in print */
        .form3-table tbody tr:first-child td {
            border-top: 2px solid #000 !important;
        }
        
        /* Body cells - larger text matching PDF */
        .form3-table td {
            font-size: 9pt !important;
            padding: 0.3rem 0.15rem !important;
            border: 1px solid #000 !important;
            line-height: 1.3 !important;
        }
        
        /* Header cells - taller with more padding for readability */
        .form3-table th {
            font-size: 9pt !important;
            padding: 0.4rem 0.2rem !important;
            border: 1px solid #000 !important;
            line-height: 1.4 !important;
            vertical-align: middle !important;
        }
        
        /* Standard code and description styling for print - taller headers */
        .pass-not-pass-header {
            padding: 0.45rem 0.2rem !important;
        }
        
        .pass-not-pass-header .fw-semibold {
            font-size: 10pt !important;
            font-weight: bold !important;
            display: block !important;
            margin-bottom: 0.25rem !important;
        }
        
        .pass-not-pass-header .small {
            font-size: 8pt !important;
            font-weight: normal !important;
            line-height: 1.3 !important;
        }
        
        /* Sub-header row styling */
        .sub-header-row th {
            font-size: 8.5pt !important;
            padding: 0.4rem 0.15rem !important;
            line-height: 1.3 !important;
        }
        
        .percentage-cell .text-muted {
            font-size: 8pt !important;
        }
        
        /* Force table to break across pages properly */
        .form3-table thead {
            display: table-header-group !important;
        }
        
        .form3-table tfoot {
            display: table-footer-group !important;
        }
        
        .form3-table tbody {
            display: table-row-group !important;
        }
        
        /* Ensure headers repeat on each page */
        .form3-table thead tr {
            page-break-inside: avoid !important;
            page-break-after: avoid !important;
        }
        
        /* Prevent awkward page breaks */
        .form3-table tbody tr {
            page-break-inside: avoid !important;
        }
        
        /* Maintain alternating colors in print */
        .form3-table .standard-group-even {
            background-color: #f5f5f5 !important;
            -webkit-print-color-adjust: exact !important;
            color-adjust: exact !important;
        }
        
        .form3-table .standard-group-odd {
            background-color: #ffffff !important;
            -webkit-print-color-adjust: exact !important;
            color-adjust: exact !important;
        }
        
        /* Print page setup - maximize space */
        @@page {
            margin: 0.2in !important;
            size: landscape !important;
        }
    }
    
    /* Print button styling */
    .print-button {
        margin-bottom: 1rem;
    }
    
    /* Hide elements on screen */
    .no-print {
        display: none;
    }
</style>

<div class="orenda-container">
    <div class="orenda-header shadow-orenda">
        <h2 class="mb-1">Data Reflection</h2>
        <p class="mb-0">Form 3</p>
    </div>

    <!-- Filters: District -> Unit/Cycle -> Assessment -> School (no Teacher filter) -->
    <form method="get" class="row g-3 mt-3">
        <input type="hidden" name="DistrictId" value="@Model.DistrictId" />
        <div class="col-md-3">
            <label class="form-label fw-semibold">Unit/Cycle</label>
            <select name="UnitCycle" class="form-select" onchange="this.form.submit()">
                @foreach (var opt in Model.AvailableUnitCycles)
                {
                    <option value="@opt.Value" selected="@(Model.UnitCycle == opt.Value)">@opt.Text</option>
                }
            </select>
        </div>
        <div class="col-md-4">
            <label class="form-label fw-semibold">Assessment</label>
            <select name="BatchId" class="form-select" onchange="this.form.submit()">
                @foreach (var opt in Model.AvailableBatches)
                {
                    <option value="@opt.Value" selected="@(Model.BatchId == opt.Value)">@opt.Text</option>
                }
            </select>
        </div>
        <div class="col-md-5">
            <label class="form-label fw-semibold">School</label>
            <select name="SchoolId" class="form-select" onchange="this.form.submit()">
                @foreach (var opt in Model.AvailableSchools)
                {
                    <option value="@opt.Value" selected="@(Model.SchoolId?.ToString() == opt.Value)">@opt.Text</option>
                }
            </select>
        </div>
    </form>

    @if (Model.GroupSummaries.Any() && Model.Columns.Any())
    {
        <div class="card shadow-sm mt-4">
                            <div class="card-body">
                <!-- Print Button -->
                <div class="print-button mb-3 d-flex gap-2">
                    <button type="button" class="btn btn-primary" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>Print Report
                    </button>
                    
                    <a class="btn btn-outline-success"
                       asp-page-handler="Excel"
                       asp-route-DistrictId="@Model.DistrictId"
                       asp-route-UnitCycle="@Model.UnitCycle"
                       asp-route-BatchId="@Model.BatchId"
                       asp-route-SchoolId="@Model.SchoolId">
                        <i class="fas fa-file-excel me-2"></i>Export to Excel
                    </a>
                </div>
                
                <!-- Print Title (hidden on screen, visible in print) -->
                <div class="print-title" style="display: none;">
                    @if (!string.IsNullOrEmpty(Model.BatchId) && Model.AvailableBatches.Any())
                    {
                        var selectedBatch = Model.AvailableBatches.FirstOrDefault(b => b.Value == Model.BatchId);
                        if (selectedBatch != null)
                        {
                            <span>@selectedBatch.Text - @(Model.AvailableSchools.FirstOrDefault(s => s.Value == Model.SchoolId?.ToString())?.Text ?? "All Schools") - Form 3</span>
                        }
                    }
                </div>

                <!-- Test Name Header for screen -->
                <div class="mb-2">
                    @if (!string.IsNullOrEmpty(Model.BatchId) && Model.AvailableBatches.Any())
                    {
                        var selectedBatch = Model.AvailableBatches.FirstOrDefault(b => b.Value == Model.BatchId);
                        if (selectedBatch != null)
                        {
                            <h5 class="mb-0 text-center">@selectedBatch.Text - @(Model.AvailableSchools.FirstOrDefault(s => s.Value == Model.SchoolId?.ToString())?.Text ?? "All Schools") - Form 3</h5>
                        }
                    }
                    else
                    {
                        <h5 class="mb-0 text-center">Assessment Data</h5>
                    }
                </div>

                <div class="table-responsive">
                    <table class="table form3-table table-compact align-middle">
                        <thead class="table-light">
                            <tr>
                                <th class="compact-nowrap text-center teacher-col" rowspan="2">Teacher</th>
                                <th class="compact-nowrap text-center period-col" rowspan="2">Per</th>

                                @* For each standard, show Code + short description in single column *@
                                @for (int i = 0; i < Model.Columns.Count; i++)
                                {
                                    var c = Model.Columns[i];
                                    var groupClass = i % 2 == 0 ? "standard-group-even" : "standard-group-odd";
                                    <th class="text-center pass-not-pass-header standard-col @groupClass">
                                        <span class="fw-semibold">@c.Code</span>
                                        <span class="small text-muted">@c.ShortStatement</span>
                                    </th>
                                }

                                <th class="text-center pass-not-pass-header standard-col standard-group-odd">
                                    <span class="fw-semibold">Overall Proficiency</span>
                                    <span class="small text-muted">3+ standards passed</span>
                                </th>
                            </tr>
                            <tr class="sub-header-row">
                                @for (int i = 0; i < Model.Columns.Count; i++)
                                {
                                    var groupClass = i % 2 == 0 ? "standard-group-even" : "standard-group-odd";
                                    <th class="text-center standard-col @groupClass">
                                        <div class="passed-line">% (#) Passed</div>
                                        <div class="not-passed-line">% (#) Not Passed</div>
                                    </th>
                                }

                                <th class="text-center standard-col standard-group-odd">
                                    <div class="passed-line">% (#) Passed</div>
                                    <div class="not-passed-line">% (#) Not Passed</div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                        @foreach (var g in Model.GroupSummaries)
                        {
                            <tr class="teacher-row">
                                <td class="text-center teacher-name-cell teacher-col">@Html.Raw(g.Key.TeacherName.Replace(", ", ",<br/>"))</td>
                                <td class="compact-nowrap text-center period-col">@g.Key.Period</td>

                                @for (int i = 0; i < Model.Columns.Count; i++)
                                {
                                    var den = g.DenomPerStd[i];
                                    var pass = g.PassedPerStd[i];
                                    var notp = g.NotPassedPerStd[i];
                                    var groupClass = i % 2 == 0 ? "standard-group-even" : "standard-group-odd";

                                    <td class="text-center stacked-cell standard-col @groupClass">
                                        <div class="passed-line">
                                            @ORSV2.Pages.DataReflection.Form3Model.Pct(pass, den) <span class="text-muted">(@pass)</span>
                                        </div>
                                        <div class="not-passed-line">
                                            @ORSV2.Pages.DataReflection.Form3Model.Pct(notp, den) <span class="text-muted">(@notp)</span>
                                        </div>
                                    </td>
                                }

                                @{
                                    var totDen = g.StudentCount;
                                    var totPass = g.PassedByTotal;
                                    var totNot = g.NotPassedByTotal;
                                }
                                <td class="text-center stacked-cell standard-col standard-group-odd">
                                    <div class="passed-line">
                                        @ORSV2.Pages.DataReflection.Form3Model.Pct(totPass, totDen) <span class="text-muted">(@totPass)</span>
                                    </div>
                                    <div class="not-passed-line">
                                        @ORSV2.Pages.DataReflection.Form3Model.Pct(totNot, totDen) <span class="text-muted">(@totNot)</span>
                                    </div>
                                </td>
                            </tr>
                        }
                        </tbody>
                        @if (Model.GrandTotals is not null)
                        {
                            <tfoot class="table-light">
                                <tr>
                                    <th class="compact-nowrap text-center teacher-col">OVERALL</th>
                                    <th class="compact-nowrap text-center period-col"></th>

                                    @for (int i = 0; i < Model.Columns.Count; i++)
                                    {
                                        var den  = Model.GrandTotals.DenomPerStd[i];
                                        var pass = Model.GrandTotals.PassedPerStd[i];
                                        var notp = Model.GrandTotals.NotPassedPerStd[i];
                                        var groupClass = i % 2 == 0 ? "standard-group-even" : "standard-group-odd";

                                        <th class="text-center stacked-cell standard-col @groupClass">
                                            <div class="passed-line">
                                                @ORSV2.Pages.DataReflection.Form3Model.Pct(pass, den) <span class="text-muted">(@pass)</span>
                                            </div>
                                            <div class="not-passed-line">
                                                @ORSV2.Pages.DataReflection.Form3Model.Pct(notp, den) <span class="text-muted">(@notp)</span>
                                            </div>
                                        </th>
                                    }

                                    @{
                                        var totDen  = Model.GrandTotals.StudentCount;
                                        var totPass = Model.GrandTotals.PassedByTotal;
                                        var totNot  = Model.GrandTotals.NotPassedByTotal;
                                    }
                                    <th class="text-center stacked-cell standard-col standard-group-odd">
                                        <div class="passed-line">
                                            @ORSV2.Pages.DataReflection.Form3Model.Pct(totPass, totDen) <span class="text-muted">(@totPass)</span>
                                        </div>
                                        <div class="not-passed-line">
                                            @ORSV2.Pages.DataReflection.Form3Model.Pct(totNot, totDen) <span class="text-muted">(@totNot)</span>
                                        </div>
                                    </th>
                                </tr>
                            </tfoot>
                        }
                    </table>
                </div>

                <div class="form3-footer-note text-muted">
                    PASS cutoff = score ≥ 4 (per standard). Overall Proficiency = student passed ≥ 3 standards.
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-info mt-4">
            Select a Unit/Cycle, Assessment, and School to view the summary.
        </div>
    }
</div>